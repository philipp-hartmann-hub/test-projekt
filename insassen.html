<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insassen-Portal - Antragswesen</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Login-Bereich -->
  <div class="start-page" id="loginSection">
    <div class="bg-decoration">
      <div class="bg-circle bg-circle-1"></div>
      <div class="bg-circle bg-circle-2"></div>
      <div class="bg-grid"></div>
    </div>

    <div class="login-card">
      <div class="login-header">
        <div class="login-icon"></div>
        <h2>Insassen-Portal</h2>
      </div>
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="username">Benutzername</label>
          <input type="text" id="username" placeholder="Benutzername" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="password">Passwort</label>
          <input type="password" id="password" placeholder="Passwort" required autocomplete="current-password">
        </div>
        <div id="loginError" class="login-error" style="display: none;">
          Ung√ºltige Zugangsdaten. Bitte versuchen Sie es erneut.
        </div>
        <button type="submit" class="btn btn-primary btn-full">
          Anmelden
        </button>
      </form>
      <div class="login-hint">
        <a href="index.html" class="btn btn-secondary btn-sm" style="margin-top: 1rem;">‚Üê Zur√ºck zur √úbersicht</a>
      </div>
    </div>
  </div>

  <!-- Portal-Bereich (nach Login sichtbar) -->
  <div id="portalSection" style="display: none;">
    <header class="header">
      <div class="header-left">
        <div class="hamburg-logo">
          <img src="https://pem-center.de/wp-content/uploads/Logo-Stadt-Hamburg.jpg" alt="Stadt Hamburg" class="hamburg-wappen-img">
        </div>
        <div class="header-title">
          <h1>Insassen-Portal</h1>
          <span class="header-subtitle">Freie und Hansestadt Hamburg</span>
        </div>
      </div>
      <div class="header-right">
        <div class="user-badge">
          <div>
            <div class="role" data-i18n="role.inmate">Insasse</div>
            <div class="name" id="userName">-</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="logout()" data-i18n="app.logout">Abmelden</button>
      </div>
    </header>

    <main class="container">
      <!-- Begr√º√üung -->
      <div class="welcome-banner" id="welcomeBanner">
        <h2 id="welcomeGreeting">Moin!</h2>
        <p id="welcomeMessage">Willkommen im Insassen-Portal.</p>
      </div>
      
      <div class="dashboard">
        <!-- Benachrichtigungs-Bereich (aufklappbar) -->
        <section class="section notification-section collapsed" id="notificationSection">
          <div class="notification-header" onclick="togglePostfach()">
            <div class="notification-header-left">
              <span class="postfach-toggle-icon" id="postfachToggleIcon">‚ñ∂</span>
              <h2>Nachrichten <span class="count" id="notificationCount">0</span></h2>
            </div>
            <button class="btn btn-sm" onclick="markAllNotificationsRead(); event.stopPropagation();" id="markAllReadBtn" style="display: none;">
              Alle als gelesen markieren
            </button>
          </div>
          <!-- Vorschau: Nur neueste Nachricht (wenn eingeklappt) -->
          <div class="notification-preview" id="notificationPreview">
            <!-- Dynamisch gef√ºllt -->
          </div>
          <!-- Vollst√§ndige Liste (wenn aufgeklappt) -->
          <div class="notification-dashboard-list" id="notificationList">
            <!-- Dynamisch gef√ºllt -->
          </div>
        </section>

        <!-- Neuer Antrag Button -->
        <div class="action-bar">
          <button class="btn btn-primary" onclick="openModal('newAntragModal')">
            + Neuer Antrag
          </button>
        </div>

        <!-- Aufgaben-Bereich f√ºr Insassen -->
        <section class="section aufgaben-section" id="aufgabenSection" style="display: none;">
          <div class="section-header">
            <h2>Meine Aufgaben <span class="count" id="aufgabenCount">0</span></h2>
          </div>
          <p class="section-hint">Diese Aufgaben wurden Ihnen zugewiesen und ben√∂tigen Ihre Mitwirkung.</p>
          <div class="antrag-list" id="aufgabenList">
            <!-- Dynamisch gef√ºllt -->
          </div>
        </section>

        <!-- Zweispaltiges Layout -->
        <div class="two-column-layout">
          <!-- Linke Spalte: Eingereichte Antr√§ge / Historie -->
          <div class="column-main">
            <!-- Tabs -->
            <div class="tabs">
              <button class="tab active" onclick="switchTab('aktiv')">Eingereichte Antr√§ge</button>
              <button class="tab" onclick="switchTab('historie')">Historie</button>
            </div>

            <!-- Aktive Antr√§ge -->
            <section class="section" id="aktivSection">
              <div class="section-header">
                <h2>Eingereichte Antr√§ge <span class="count" id="aktivCount">0</span></h2>
              </div>
              <div class="antrag-list" id="aktivList">
                <!-- Dynamisch gef√ºllt -->
              </div>
            </section>

            <!-- Historie -->
            <section class="section" id="historieSection" style="display: none;">
              <div class="section-header">
                <h2>Abgeschlossene Antr√§ge <span class="count" id="historieCount">0</span></h2>
              </div>
              <div class="antrag-list" id="historieList">
                <!-- Dynamisch gef√ºllt -->
              </div>
            </section>
          </div>

          <!-- Rechte Spalte: Entw√ºrfe -->
          <div class="column-sidebar">
            <section class="section entwuerfe-section">
              <div class="section-header">
                <h2>Entw√ºrfe <span class="count" id="entwuerfeCount">0</span></h2>
              </div>
              <div class="antrag-list" id="entwuerfeList">
                <!-- Dynamisch gef√ºllt -->
              </div>
            </section>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Neuer Antrag -->
  <div class="modal-overlay" id="newAntragModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Neuer Antrag</h3>
        <button class="modal-close" onclick="closeModal('newAntragModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Antragsart</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="antragType" value="teilhabegeld" checked onchange="toggleAntragFields()">
              <span class="radio-label">üí∞ Teilhabegeld</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="antragType" value="eigentum" onchange="toggleAntragFields()">
              <span class="radio-label">üëï Eigentum in der Kammer</span>
            </label>
          </div>
        </div>

        <!-- Teilhabegeld Felder -->
        <div id="teilhabegeldFields">
          <div class="form-group">
            <label for="monatSelect">Monat ausw√§hlen</label>
            <input type="month" id="monatSelect">
          </div>
        </div>

        <!-- Eigentum Felder -->
        <div id="eigentumFields" style="display: none;">
          <div class="form-group">
            <label>Aktion</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="eigentumAktion" value="aufstocken" checked>
                <span class="radio-label">üì¶ Kleidung aufstocken</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="eigentumAktion" value="tauschen">
                <span class="radio-label">Kleidung tauschen</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Kleidungsst√ºcke (Mehrfachauswahl m√∂glich)</label>
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" name="kleidung" value="Oberteil">
                <span class="checkbox-label">üëî Oberteil</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="kleidung" value="Pullover">
                <span class="checkbox-label">üß• Pullover</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="kleidung" value="Unterw√§sche/Socken">
                <span class="checkbox-label">üß¶ Unterw√§sche/Socken</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="kleidung" value="Hose">
                <span class="checkbox-label">üëñ Hose</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="kleidung" value="Jacke">
                <span class="checkbox-label">üß• Jacke</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label for="eigentumBegruendung">Begr√ºndung <span class="required">*</span></label>
            <textarea id="eigentumBegruendung" placeholder="Bitte begr√ºnden Sie Ihren Antrag..." rows="3" required></textarea>
            <p class="field-hint">Eine Begr√ºndung ist f√ºr diesen Antrag erforderlich.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer modal-footer-triple">
        <button class="btn btn-secondary" onclick="closeModal('newAntragModal')">Abbrechen</button>
        <button class="btn btn-outline" onclick="saveAsEntwurf()">Als Entwurf speichern</button>
        <button class="btn btn-primary" onclick="submitNewAntrag()">Einreichen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Entwurf bearbeiten -->
  <div class="modal-overlay" id="entwurfModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Entwurf bearbeiten</h3>
        <button class="modal-close" onclick="closeModal('entwurfModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Antragsart</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="entwurfType" value="teilhabegeld" onchange="toggleEntwurfFields()">
              <span class="radio-label">üí∞ Teilhabegeld</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="entwurfType" value="eigentum" onchange="toggleEntwurfFields()">
              <span class="radio-label">üëï Eigentum in der Kammer</span>
            </label>
          </div>
        </div>

        <!-- Teilhabegeld Felder -->
        <div id="entwurfTeilhabegeldFields">
          <div class="form-group">
            <label for="entwurfMonatSelect">Monat ausw√§hlen</label>
            <input type="month" id="entwurfMonatSelect">
          </div>
        </div>

        <!-- Eigentum Felder -->
        <div id="entwurfEigentumFields" style="display: none;">
          <div class="form-group">
            <label>Aktion</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="entwurfEigentumAktion" value="aufstocken">
                <span class="radio-label">üì¶ Kleidung aufstocken</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="entwurfEigentumAktion" value="tauschen">
                <span class="radio-label">Kleidung tauschen</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Kleidungsst√ºcke (Mehrfachauswahl m√∂glich)</label>
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" name="entwurfKleidung" value="Oberteil">
                <span class="checkbox-label">üëî Oberteil</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="entwurfKleidung" value="Pullover">
                <span class="checkbox-label">üß• Pullover</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="entwurfKleidung" value="Unterw√§sche/Socken">
                <span class="checkbox-label">üß¶ Unterw√§sche/Socken</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="entwurfKleidung" value="Hose">
                <span class="checkbox-label">üëñ Hose</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="entwurfKleidung" value="Jacke">
                <span class="checkbox-label">üß• Jacke</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label for="entwurfEigentumBegruendung">Begr√ºndung <span class="required">*</span></label>
            <textarea id="entwurfEigentumBegruendung" placeholder="Bitte begr√ºnden Sie Ihren Antrag..." rows="3" required></textarea>
            <p class="field-hint">Eine Begr√ºndung ist f√ºr diesen Antrag erforderlich.</p>
          </div>
        </div>

        <input type="hidden" id="entwurfId">
      </div>
      <div class="modal-footer modal-footer-triple">
        <button class="btn btn-danger" onclick="deleteEntwurf()">L√∂schen</button>
        <button class="btn btn-outline" onclick="updateEntwurf()">Speichern</button>
        <button class="btn btn-primary" onclick="submitEntwurf()">Einreichen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Teilweise genehmigten Antrag bearbeiten -->
  <div class="modal-overlay" id="editAntragModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Antrag bearbeiten</h3>
        <button class="modal-close" onclick="closeModal('editAntragModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="info-box warning">
          <strong>Teilweise genehmigt</strong>
          <p id="editBegruendung">-</p>
        </div>
        
        <!-- F√ºr Teilhabegeld -->
        <div id="editTeilhabegeldFields">
          <div class="form-group">
            <label for="editMonatSelect">Neuen Monat ausw√§hlen</label>
            <input type="month" id="editMonatSelect">
          </div>
        </div>

        <!-- F√ºr Eigentum -->
        <div id="editEigentumFields" style="display: none;">
          <div class="form-group">
            <label>Aktion</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="editEigentumAktion" value="aufstocken">
                <span class="radio-label">üì¶ Kleidung aufstocken</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="editEigentumAktion" value="tauschen">
                <span class="radio-label">Kleidung tauschen</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Kleidungsst√ºcke (Mehrfachauswahl m√∂glich)</label>
            <div class="checkbox-group" id="editKleidungCheckboxes">
              <label class="checkbox-option">
                <input type="checkbox" name="editKleidung" value="Oberteil">
                <span class="checkbox-label">üëî Oberteil</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="editKleidung" value="Pullover">
                <span class="checkbox-label">üß• Pullover</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="editKleidung" value="Unterw√§sche/Socken">
                <span class="checkbox-label">üß¶ Unterw√§sche/Socken</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="editKleidung" value="Hose">
                <span class="checkbox-label">üëñ Hose</span>
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="editKleidung" value="Jacke">
                <span class="checkbox-label">üß• Jacke</span>
              </label>
            </div>
          </div>
        </div>

        <input type="hidden" id="editAntragId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteAntrag()">Endg√ºltig l√∂schen</button>
        <button class="btn btn-primary" onclick="resubmitAntrag()">Erneut einreichen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Aufgabe bearbeiten (Insasse) -->
  <div class="modal-overlay" id="aufgabeInsasseModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Aufgabe bearbeiten</h3>
        <button class="modal-close" onclick="closeModal('aufgabeInsasseModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="aufgabe-info" id="aufgabeInsasseInfo">
          <!-- Dynamisch gef√ºllt -->
        </div>
        
        <div class="form-group">
          <label>Wie m√∂chten Sie die Aufgabe abschlie√üen?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="aufgabeInsasseTyp" value="antwort" checked onchange="toggleInsasseAntwortFeld()">
              <span class="radio-label">Mit Antwort</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="aufgabeInsasseTyp" value="kenntnisnahme" onchange="toggleInsasseAntwortFeld()">
              <span class="radio-label">Zur Kenntnis genommen</span>
            </label>
          </div>
        </div>
        
        <div class="form-group" id="aufgabeInsasseAntwortGruppe">
          <label for="aufgabeInsasseAntwort">Ihre Antwort</label>
          <textarea id="aufgabeInsasseAntwort" placeholder="Geben Sie Ihre Antwort ein..." rows="4"></textarea>
        </div>
        
        <input type="hidden" id="aufgabeInsasseId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('aufgabeInsasseModal')">Abbrechen</button>
        <button class="btn btn-success" onclick="erledigeInsassenAufgabe()">Aufgabe abschlie√üen</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    let currentSession = null;

    // Statusanzeige (nur Deutsch)
    function getStatusText(status) {
      const statusMap = {
        'entwurf': 'Entwurf',
        'eingereicht': 'Eingereicht',
        'in-bearbeitung': 'In Bearbeitung',
        'genehmigt': 'Genehmigt',
        'abgelehnt': 'Abgelehnt',
        'teilweise-genehmigt': 'Teilweise genehmigt',
        'erledigt': 'Erledigt',
        'offen': 'Offen'
      };
      return statusMap[status] || status;
    }
    
    // Antragstypen (nur Deutsch)
    function getAntragsTypText(type) {
      const typeMap = {
        'teilhabegeld': 'Teilhabegeld',
        'eigentum': 'Eigentum in der Kammer',
        'sonstiges': 'Sonstiges'
      };
      return typeMap[type] || type;
    }

    // ============================================
    // LOGIN
    // ============================================
    
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      const result = sessionManager.login(username, password, 'insasse');
      
      if (result.success) {
        currentSession = result.user;
        showPortal();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    function logout() {
      sessionManager.logout();
      currentSession = null;
      location.reload();
    }
    
    function showPortal() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('portalSection').style.display = 'block';
      document.getElementById('userName').textContent = currentSession.name;
      
      // Moin-Begr√º√üung setzen
      document.getElementById('welcomeGreeting').textContent = 'Moin, ' + currentSession.name + '!';
      document.getElementById('welcomeMessage').textContent = 'Willkommen im Insassen-Portal.';
      
      renderAntraege();
      renderNotifications();
      updateNotificationBadge();
      
      // Benachrichtigungen und Aufgaben periodisch pr√ºfen
      setInterval(() => {
        renderNotifications();
        renderAntraege();
        updateNotificationBadge();
      }, 10000); // Alle 10 Sekunden
    }
    
    // Check if already logged in
    const existingSession = sessionManager.getSession();
    if (existingSession && existingSession.type === 'insasse') {
      currentSession = existingSession;
      showPortal();
    }

    // ============================================
    // BENACHRICHTIGUNGEN
    // ============================================
    
    function updateNotificationBadge() {
      if (!currentSession) return;
      
      const count = notificationSystem.getUnreadCount(currentSession.userId);
      document.getElementById('notificationCount').textContent = count;
      
      // "Alle als gelesen" Button nur anzeigen, wenn es ungelesene gibt
      const markAllBtn = document.getElementById('markAllReadBtn');
      markAllBtn.style.display = count > 0 ? 'inline-block' : 'none';
    }
    
    // Postfach auf-/zuklappen
    let postfachExpanded = false;
    
    function togglePostfach() {
      const section = document.getElementById('notificationSection');
      const icon = document.getElementById('postfachToggleIcon');
      
      postfachExpanded = !postfachExpanded;
      
      if (postfachExpanded) {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        icon.textContent = '‚ñº';
      } else {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
      }
    }
    
    function renderNotifications() {
      if (!currentSession) return;
      
      const list = document.getElementById('notificationList');
      const preview = document.getElementById('notificationPreview');
      const notifications = notificationSystem.getAllNotifications(currentSession.userId);
      const section = document.getElementById('notificationSection');
      
      if (notifications.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'flex';
      
      // Vorschau: Nur neueste Nachricht
      if (notifications.length > 0) {
        const newest = notifications[0];
        const typeClass = newest.type || 'info';
        const unreadClass = newest.gelesen ? 'read' : 'unread';
        
        preview.innerHTML = `
          <div class="notification-card ${typeClass} ${unreadClass}" onclick="handleNotificationClick('${newest.id}', '${newest.antragId || ''}'); event.stopPropagation();">
            <div class="notification-card-icon">${getNotificationIcon(newest.type)}</div>
            <div class="notification-card-content">
              <div class="notification-card-title">${newest.title}</div>
              <div class="notification-card-message">${newest.message}</div>
              <div class="notification-card-time">${formatDate(newest.erstelltAm)}</div>
            </div>
            ${!newest.gelesen ? '<div class="notification-card-dot"></div>' : ''}
          </div>
          ${notifications.length > 1 ? `<div class="notification-more-hint">+ ${notifications.length - 1} weitere Nachrichten</div>` : ''}
        `;
      }
      
      // Vollst√§ndige Liste
      list.innerHTML = notifications.map(n => {
        const typeClass = n.type || 'info';
        const unreadClass = n.gelesen ? 'read' : 'unread';
        
        return `
          <div class="notification-card ${typeClass} ${unreadClass}" onclick="handleNotificationClick('${n.id}', '${n.antragId || ''}'); event.stopPropagation();">
            <div class="notification-card-icon">${getNotificationIcon(n.type)}</div>
            <div class="notification-card-content">
              <div class="notification-card-title">${n.title}</div>
              <div class="notification-card-message">${n.message}</div>
              <div class="notification-card-time">${formatDate(n.erstelltAm)}</div>
            </div>
            ${!n.gelesen ? '<div class="notification-card-dot"></div>' : ''}
          </div>
        `;
      }).join('');
    }
    
    function getNotificationIcon(type) {
      return '';
    }
    
    function handleNotificationClick(notificationId, antragId) {
      notificationSystem.markAsRead(notificationId);
      updateNotificationBadge();
      renderNotifications();
      
      // Wenn ein Antrag verkn√ºpft ist, zur entsprechenden Ansicht wechseln
      if (antragId) {
        const antrag = antragSystem.getAntrag(antragId);
        if (antrag && antrag.erledigt) {
          switchTab('historie');
        }
      }
    }
    
    function markAllNotificationsRead() {
      if (!currentSession) return;
      notificationSystem.markAllAsRead(currentSession.userId);
      updateNotificationBadge();
      renderNotifications();
    }

    // ============================================
    // TAB-WECHSEL
    // ============================================
    
    function switchTab(tab) {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => t.classList.remove('active'));
      
      document.getElementById('aktivSection').style.display = 'none';
      document.getElementById('historieSection').style.display = 'none';
      
      if (tab === 'aktiv') {
        tabs[0].classList.add('active');
        document.getElementById('aktivSection').style.display = 'block';
      } else {
        tabs[1].classList.add('active');
        document.getElementById('historieSection').style.display = 'block';
      }
    }

    // ============================================
    // ANTR√ÑGE
    // ============================================
    
    function toggleAntragFields() {
      const type = document.querySelector('input[name="antragType"]:checked').value;
      document.getElementById('teilhabegeldFields').style.display = type === 'teilhabegeld' ? 'block' : 'none';
      document.getElementById('eigentumFields').style.display = type === 'eigentum' ? 'block' : 'none';
    }

    function toggleEntwurfFields() {
      const type = document.querySelector('input[name="entwurfType"]:checked').value;
      document.getElementById('entwurfTeilhabegeldFields').style.display = type === 'teilhabegeld' ? 'block' : 'none';
      document.getElementById('entwurfEigentumFields').style.display = type === 'eigentum' ? 'block' : 'none';
    }

    function getNewAntragData() {
      const type = document.querySelector('input[name="antragType"]:checked').value;
      
      if (type === 'teilhabegeld') {
        const monat = document.getElementById('monatSelect').value;
        if (!monat) {
          return { type, data: { monat }, valid: false, error: 'Bitte w√§hlen Sie einen Monat aus.' };
        }
        // Pr√ºfen ob bereits ein Antrag f√ºr diesen Monat existiert
        if (antragSystem.hatTeilhabegeldAntragFuerMonat(currentSession.userId, monat)) {
          const monatFormatiert = new Date(monat + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
          return { type, data: { monat }, valid: false, error: `Sie haben bereits einen Teilhabegeld-Antrag f√ºr ${monatFormatiert} gestellt. Pro Monat ist nur ein Antrag m√∂glich.` };
        }
        return { type, data: { monat }, valid: true, error: null };
      } else {
        const aktion = document.querySelector('input[name="eigentumAktion"]:checked').value;
        const kleidungCheckboxes = document.querySelectorAll('input[name="kleidung"]:checked');
        const kleidung = Array.from(kleidungCheckboxes).map(cb => cb.value);
        const antragBegruendungText = document.getElementById('eigentumBegruendung').value.trim();
        const antragBegruendung = antragBegruendungText;
        
        if (kleidung.length === 0) {
          return { type, data: { aktion, kleidung, antragBegruendung }, valid: false, error: 'Bitte w√§hlen Sie eine Option aus.' };
        }
        if (!antragBegruendungText) {
          return { type, data: { aktion, kleidung, antragBegruendung }, valid: false, error: 'Dieses Feld ist erforderlich.' };
        }
        return { type, data: { aktion, kleidung, antragBegruendung }, valid: true, error: null };
      }
    }

    function submitNewAntrag() {
      if (!currentSession) return;
      
      const { type, data, valid, error } = getNewAntragData();
      
      if (!valid) {
        showAlert(error);
        return;
      }
      
      antragSystem.createAntrag(type, data, currentSession, false);
      
      closeModal('newAntragModal');
      renderAntraege();
      resetNewAntragForm();
    }

    function saveAsEntwurf() {
      if (!currentSession) return;
      
      const { type, data } = getNewAntragData();
      
      // Bei Entw√ºrfen ist keine Validierung n√∂tig - kann unvollst√§ndig sein
      antragSystem.createAntrag(type, data, currentSession, true);
      
      closeModal('newAntragModal');
      renderAntraege();
      resetNewAntragForm();
      
      // Hinweis anzeigen
      showAlert('Entwurf wurde gespeichert! Sie finden ihn in der rechten Spalte.');
    }

    function resetNewAntragForm() {
      document.getElementById('monatSelect').value = '';
      document.querySelectorAll('input[name="kleidung"]').forEach(cb => cb.checked = false);
      document.getElementById('eigentumBegruendung').value = '';
      document.querySelector('input[name="antragType"][value="teilhabegeld"]').checked = true;
      document.querySelector('input[name="eigentumAktion"][value="aufstocken"]').checked = true;
      toggleAntragFields();
    }

    // ============================================
    // ENTW√úRFE
    // ============================================

    function openEntwurfModal(entwurfId) {
      const entwurf = antragSystem.getAntrag(entwurfId);
      if (!entwurf || entwurf.status !== 'entwurf') return;
      
      document.getElementById('entwurfId').value = entwurfId;
      
      // Typ setzen
      document.querySelector(`input[name="entwurfType"][value="${entwurf.type}"]`).checked = true;
      toggleEntwurfFields();
      
      if (entwurf.type === 'teilhabegeld') {
        document.getElementById('entwurfMonatSelect').value = entwurf.monat || '';
      } else {
        if (entwurf.aktion) {
          document.querySelector(`input[name="entwurfEigentumAktion"][value="${entwurf.aktion}"]`).checked = true;
        }
        document.querySelectorAll('input[name="entwurfKleidung"]').forEach(cb => {
          cb.checked = entwurf.kleidung && entwurf.kleidung.includes(cb.value);
        });
        document.getElementById('entwurfEigentumBegruendung').value = entwurf.antragBegruendung || '';
      }
      
      openModal('entwurfModal');
    }

    function getEntwurfData() {
      const type = document.querySelector('input[name="entwurfType"]:checked').value;
      
      if (type === 'teilhabegeld') {
        const monat = document.getElementById('entwurfMonatSelect').value;
        if (!monat) {
          return { type, monat, valid: false, error: 'Bitte w√§hlen Sie einen Monat aus.' };
        }
        // Pr√ºfen ob bereits ein Antrag f√ºr diesen Monat existiert (aber dieser Entwurf ausschlie√üen)
        const entwurfId = document.getElementById('entwurfId').value;
        const existierenderAntrag = antragSystem.antraege.find(a => 
          a.type === 'teilhabegeld' && 
          a.insasseId === currentSession.userId && 
          a.monat === monat &&
          a.status !== 'entwurf' &&
          a.id !== entwurfId
        );
        if (existierenderAntrag) {
          const monatFormatiert = new Date(monat + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
          return { type, monat, valid: false, error: `Sie haben bereits einen Teilhabegeld-Antrag f√ºr ${monatFormatiert} gestellt. Pro Monat ist nur ein Antrag m√∂glich.` };
        }
        return { type, monat, valid: true, error: null };
      } else {
        const aktionRadio = document.querySelector('input[name="entwurfEigentumAktion"]:checked');
        const aktion = aktionRadio ? aktionRadio.value : 'aufstocken';
        const kleidungCheckboxes = document.querySelectorAll('input[name="entwurfKleidung"]:checked');
        const kleidung = Array.from(kleidungCheckboxes).map(cb => cb.value);
        const antragBegruendung = document.getElementById('entwurfEigentumBegruendung').value.trim();
        
        if (kleidung.length === 0) {
          return { type, aktion, kleidung, antragBegruendung, valid: false, error: 'Bitte w√§hlen Sie mindestens ein Kleidungsst√ºck aus.' };
        }
        if (!antragBegruendung) {
          return { type, aktion, kleidung, antragBegruendung, valid: false, error: 'Bitte geben Sie eine Begr√ºndung f√ºr Ihren Antrag an.' };
        }
        return { type, aktion, kleidung, antragBegruendung, valid: true, error: null };
      }
    }

    function updateEntwurf() {
      const entwurfId = document.getElementById('entwurfId').value;
      const data = getEntwurfData();
      
      antragSystem.updateEntwurf(entwurfId, data);
      
      closeModal('entwurfModal');
      renderAntraege();
    }

    function submitEntwurf() {
      const entwurfId = document.getElementById('entwurfId').value;
      const data = getEntwurfData();
      
      if (!data.valid) {
        showAlert(data.error);
        return;
      }
      
      // Erst Daten aktualisieren, dann einreichen
      antragSystem.updateEntwurf(entwurfId, data);
      antragSystem.submitEntwurf(entwurfId);
      
      closeModal('entwurfModal');
      renderAntraege();
      
      // Zum aktiven Antr√§ge-Tab wechseln
      switchTab('aktiv');
    }

    async function deleteEntwurf() {
      const entwurfId = document.getElementById('entwurfId').value;
      const confirmed = await showConfirm('M√∂chten Sie diesen Entwurf wirklich l√∂schen?');
      if (confirmed) {
        antragSystem.deleteAntrag(entwurfId);
        closeModal('entwurfModal');
        renderAntraege();
      }
    }

    function renderAntragCard(antrag, mode = 'aktiv') {
      // Sicherheitspr√ºfung
      if (!antrag || typeof antrag !== 'object') {
        console.error('Ung√ºltiger Antrag:', antrag);
        return '';
      }
      
      const statusClass = antrag.status || 'offen';
      const isTeilweiseGenehmigt = antrag.status === 'teilweise-genehmigt';
      const isEntwurf = antrag.status === 'entwurf';
      
      // Antrags-Nummer anzeigen
      const antragsNummer = antrag.antragsNummer ? `<span class="antrags-nummer">${antrag.antragsNummer}</span> ` : '';
      
      let detailsHtml = '';
      let typeLabel = 'Antrag';
      
      if (antrag.type === 'teilhabegeld') {
        typeLabel = 'Teilhabegeld';
        if (antrag.monat) {
          try {
            detailsHtml = `<p><strong>Monat:</strong> ${formatMonat(antrag.monat)}</p>`;
          } catch(e) {
            detailsHtml = `<p><strong>Monat:</strong> ${antrag.monat}</p>`;
          }
        } else {
          detailsHtml = `<p class="incomplete"><em>Monat noch nicht ausgew√§hlt</em></p>`;
        }
      } else if (antrag.type === 'eigentum') {
        typeLabel = 'Eigentum in der Kammer';
        const aktionText = antrag.aktion === 'aufstocken' ? 'Kleidung aufstocken' : 'Kleidung tauschen';
        if (antrag.kleidung && antrag.kleidung.length > 0) {
          let begruendungText = '';
          if (antrag.antragBegruendung) {
            begruendungText = typeof antrag.antragBegruendung === 'object' ? (antrag.antragBegruendung.text || '') : (antrag.antragBegruendung || '');
          }
          detailsHtml = `
            <p><strong>Anliegen:</strong> ${aktionText}</p>
            <p><strong>Kleidung:</strong> ${antrag.kleidung.join(', ')}</p>
            ${begruendungText ? `<p><strong>Begr√ºndung:</strong> ${begruendungText}</p>` : ''}
          `;
        } else {
          detailsHtml = `
            <p><strong>Aktion:</strong> ${aktionText}</p>
            <p class="incomplete"><em>Keine Kleidungsst√ºcke ausgew√§hlt</em></p>
          `;
        }
      } else {
        // Unbekannter Typ - trotzdem anzeigen
        typeLabel = antrag.type || 'Antrag';
        detailsHtml = `<p><strong>Typ:</strong> ${antrag.type || 'Unbekannt'}</p>`;
      }
      
      let actionsHtml = '';
      
      if (isEntwurf) {
        actionsHtml = `
          <div class="antrag-actions">
            <button class="btn btn-primary btn-sm" onclick="openEntwurfModal('${antrag.id}')">
              Bearbeiten
            </button>
          </div>
        `;
      } else if (mode === 'historie') {
        // Erledigte Antr√§ge (genehmigt/abgelehnt)
        if (antrag.begruendung) {
          actionsHtml = `
            <div class="antrag-feedback">
              <strong>Begr√ºndung:</strong> ${antrag.begruendung || ''}
            </div>
          `;
        }
        // Vollzugs-Kommentar anzeigen (f√ºr den Insassen sichtbar)
        if (antrag.vollzugKommentar) {
          actionsHtml += `
            <div class="antrag-feedback vollzug-kommentar">
              <strong>Hinweis zum Vollzug:</strong> ${antrag.vollzugKommentar || ''}
            </div>
          `;
        }
        if (antrag.bescheidPdf) {
          actionsHtml += `
            <div class="antrag-actions">
              <button class="btn btn-secondary btn-sm" onclick="downloadBescheidPdf('${antrag.id}')">
                Bescheid herunterladen
              </button>
            </div>
          `;
        }
      }
      
      return `
        <div class="antrag-card ${isTeilweiseGenehmigt ? 'teilweise-genehmigt' : ''} ${isEntwurf ? 'entwurf' : ''}">
          <div class="antrag-header">
            <span class="antrag-type">${antragsNummer}${typeLabel}</span>
            <span class="status-badge ${statusClass}">
              ${getStatusIcon(antrag.status)} ${getStatusText(antrag.status)}
            </span>
          </div>
          <div class="antrag-body">
            ${detailsHtml}
            <p class="antrag-date">${isEntwurf ? 'Gespeichert' : 'Erstellt'}: ${formatDate(antrag.erstelltAm)}</p>
            ${antrag.bearbeitetAm ? `<p class="antrag-date">Bearbeitet: ${formatDate(antrag.bearbeitetAm)}</p>` : ''}
          </div>
          ${actionsHtml}
        </div>
      `;
    }
    
    // Bescheid-PDF herunterladen
    function downloadBescheidPdf(antragId) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag || !antrag.bescheidPdf) {
        showAlert('Kein Bescheid vorhanden.');
        return;
      }
      
      const link = document.createElement('a');
      link.href = antrag.bescheidPdf;
      link.download = `Bescheid_${antrag.antragsNummer || antrag.id}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function openEditModal(antragId) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag) return;
      
      document.getElementById('editAntragId').value = antragId;
      document.getElementById('editBegruendung').textContent = antrag.begruendung || 'Keine Begr√ºndung angegeben';
      
      if (antrag.type === 'teilhabegeld') {
        document.getElementById('editTeilhabegeldFields').style.display = 'block';
        document.getElementById('editEigentumFields').style.display = 'none';
        document.getElementById('editMonatSelect').value = antrag.monat;
      } else {
        document.getElementById('editTeilhabegeldFields').style.display = 'none';
        document.getElementById('editEigentumFields').style.display = 'block';
        
        document.querySelector(`input[name="editEigentumAktion"][value="${antrag.aktion}"]`).checked = true;
        
        document.querySelectorAll('input[name="editKleidung"]').forEach(cb => {
          cb.checked = antrag.kleidung.includes(cb.value);
        });
      }
      
      openModal('editAntragModal');
    }

    function resubmitAntrag() {
      const antragId = document.getElementById('editAntragId').value;
      const antrag = antragSystem.getAntrag(antragId);
      
      if (antrag.type === 'teilhabegeld') {
        const monat = document.getElementById('editMonatSelect').value;
        if (!monat) {
          showAlert('Bitte w√§hlen Sie einen Monat aus.');
          return;
        }
        antragSystem.updateAntragMonat(antragId, monat);
      } else {
        const aktion = document.querySelector('input[name="editEigentumAktion"]:checked').value;
        const kleidungCheckboxes = document.querySelectorAll('input[name="editKleidung"]:checked');
        const kleidung = Array.from(kleidungCheckboxes).map(cb => cb.value);
        
        if (kleidung.length === 0) {
          showAlert('Bitte w√§hlen Sie mindestens ein Kleidungsst√ºck aus.');
          return;
        }
        
        antragSystem.updateAntragEigentum(antragId, aktion, kleidung);
      }
      
      closeModal('editAntragModal');
      renderAntraege();
    }

    async function deleteAntrag() {
      const antragId = document.getElementById('editAntragId').value;
      const confirmed = await showConfirm('M√∂chten Sie diesen Antrag wirklich endg√ºltig l√∂schen?');
      if (confirmed) {
        antragSystem.deleteAntrag(antragId);
        closeModal('editAntragModal');
        renderAntraege();
      }
    }

    function renderAntraege() {
      if (!currentSession) return;
      
      const entwuerfeList = document.getElementById('entwuerfeList');
      const aktivList = document.getElementById('aktivList');
      const historieList = document.getElementById('historieList');
      const aufgabenList = document.getElementById('aufgabenList');
      const aufgabenSection = document.getElementById('aufgabenSection');
      
      // WICHTIG: Automatische ID-Reparatur f√ºr Antr√§ge, die per Name diesem Insassen geh√∂ren
      let needsSave = false;
      antragSystem.antraege.forEach(antrag => {
        if (antrag.insasseName === currentSession.name && antrag.insasseId !== currentSession.userId) {
          console.log('Repariere Antrag-ID:', antrag.id, 'von', antrag.insasseId, 'zu', currentSession.userId);
          antrag.insasseId = currentSession.userId;
          needsSave = true;
        }
      });
      if (needsSave) {
        antragSystem.saveAntraege();
      }
      
      const entwuerfe = antragSystem.getEntwuerfeInsasse(currentSession.userId);
      const aktiveAntraege = antragSystem.getAktiveAntraegeInsasse(currentSession.userId);
      const historieAntraege = antragSystem.getHistorieInsasse(currentSession.userId);
      
      // Aufgaben f√ºr den Insassen laden
      const meineAufgaben = aufgabenSystem.getOffeneAufgaben(currentSession.userId);
      
      document.getElementById('entwuerfeCount').textContent = entwuerfe.length;
      document.getElementById('aktivCount').textContent = aktiveAntraege.length;
      document.getElementById('historieCount').textContent = historieAntraege.length;
      document.getElementById('aufgabenCount').textContent = meineAufgaben.length;
      
      // Aufgaben anzeigen
      if (meineAufgaben.length === 0) {
        aufgabenSection.style.display = 'none';
      } else {
        aufgabenSection.style.display = 'block';
        aufgabenList.innerHTML = meineAufgaben.map(a => renderAufgabeCard(a)).join('');
      }
      
      // Entw√ºrfe
      if (entwuerfe.length === 0) {
        entwuerfeList.innerHTML = '<div class="empty-state"><p>Keine Entw√ºrfe vorhanden.</p><p class="hint">Klicken Sie auf "+ Neuer Antrag" und dann "Als Entwurf speichern"</p></div>';
      } else {
        entwuerfeList.innerHTML = entwuerfe.map(a => renderAntragCard(a, 'entwurf')).join('');
      }
      
      // Aktive Antr√§ge
      if (aktiveAntraege.length === 0) {
        aktivList.innerHTML = '<div class="empty-state"><p>Keine eingereichten Antr√§ge vorhanden.</p></div>';
      } else {
        try {
          const html = aktiveAntraege.map(a => renderAntragCard(a, 'aktiv')).join('');
          aktivList.innerHTML = html || '<div class="empty-state"><p>Fehler beim Anzeigen der Antr√§ge.</p></div>';
        } catch (e) {
          console.error('Fehler beim Rendern aktiver Antr√§ge:', e);
          aktivList.innerHTML = '<div class="error-state" style="color:red;padding:1rem;">Fehler: ' + e.message + '</div>';
        }
      }
      
      // Historie
      if (historieAntraege.length === 0) {
        historieList.innerHTML = '<div class="empty-state"><p>Noch keine abgeschlossenen Antr√§ge.</p></div>';
      } else {
        try {
          const html = historieAntraege.map(a => renderAntragCard(a, 'historie')).join('');
          historieList.innerHTML = html || '<div class="empty-state"><p>Fehler beim Anzeigen der Antr√§ge.</p></div>';
        } catch (e) {
          console.error('Fehler beim Rendern der Historie:', e);
          historieList.innerHTML = '<div class="error-state" style="color:red;padding:1rem;">Fehler: ' + e.message + '</div>';
        }
      }
    }

    // ============================================
    // AUFGABEN F√úR INSASSEN
    // ============================================
    
    function renderAufgabeCard(aufgabe) {
      const antrag = antragSystem.getAntrag(aufgabe.antragId);
      const antragsNummer = antrag ? antrag.antragsNummer : aufgabe.antragsNummer;
      return `
        <div class="antrag-card aufgabe-card">
          <div class="aufgabe-header">
            <span class="aufgabe-icon"></span>
            <span class="aufgabe-label">Aufgabe</span>
            <span class="status-badge in-bearbeitung">Offen</span>
          </div>
          <div class="antrag-body">
            <p><strong>Zum Antrag:</strong> ${antragsNummer || aufgabe.antragId}</p>
            <p><strong>Von:</strong> ${aufgabe.erstelltVonName}</p>
            <p><strong>Aufgabe:</strong> ${aufgabe.kurzbeschreibung || aufgabe.beschreibung}</p>
            ${aufgabe.beschreibung && aufgabe.kurzbeschreibung ? `<p><strong>Details:</strong> ${aufgabe.beschreibung}</p>` : ''}
            <p class="antrag-date">Erhalten: ${formatDate(aufgabe.erstelltAm)}</p>
          </div>
          <div class="antrag-actions">
            <button class="btn btn-primary btn-sm" onclick="openAufgabeInsasseModal('${aufgabe.id}')">
              Bearbeiten
            </button>
          </div>
        </div>
      `;
    }
    
    function openAufgabeInsasseModal(aufgabeId) {
      const aufgabe = aufgabenSystem.getAufgabe(aufgabeId);
      if (!aufgabe) return;
      
      document.getElementById('aufgabeInsasseId').value = aufgabeId;
      document.getElementById('aufgabeInsasseAntwort').value = '';
      
      // Radio-Button auf "Antwort" setzen und Feld anzeigen
      document.querySelector('input[name="aufgabeInsasseTyp"][value="antwort"]').checked = true;
      document.getElementById('aufgabeInsasseAntwortGruppe').style.display = 'block';
      
      document.getElementById('aufgabeInsasseInfo').innerHTML = `
        <div class="detail-box">
          <div class="detail-row">
            <span class="detail-label">Von:</span>
            <span class="detail-value">${aufgabe.erstelltVonName}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Zum Antrag:</span>
            <span class="detail-value">${aufgabe.antragsNummer || aufgabe.antragId}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Aufgabe:</span>
            <span class="detail-value">${aufgabe.kurzbeschreibung || aufgabe.beschreibung}</span>
          </div>
          ${aufgabe.beschreibung && aufgabe.kurzbeschreibung ? `
          <div class="detail-row">
            <span class="detail-label">Beschreibung:</span>
            <span class="detail-value">${aufgabe.beschreibung}</span>
          </div>
          ` : ''}
        </div>
      `;
      
      openModal('aufgabeInsasseModal');
    }
    
    function toggleInsasseAntwortFeld() {
      const erledigungsTyp = document.querySelector('input[name="aufgabeInsasseTyp"]:checked').value;
      const antwortGruppe = document.getElementById('aufgabeInsasseAntwortGruppe');
      
      if (erledigungsTyp === 'kenntnisnahme') {
        antwortGruppe.style.display = 'none';
      } else {
        antwortGruppe.style.display = 'block';
      }
    }
    
    function erledigeInsassenAufgabe() {
      const aufgabeId = document.getElementById('aufgabeInsasseId').value;
      const erledigungsTyp = document.querySelector('input[name="aufgabeInsasseTyp"]:checked').value;
      const antwortText = document.getElementById('aufgabeInsasseAntwort').value.trim();
      
      // Bei "Antwort" ist eine Eingabe erforderlich, bei "Kenntnisnahme" nicht
      if (erledigungsTyp === 'antwort' && !antwortText) {
        showAlert('Dieses Feld ist erforderlich.');
        return;
      }
      
      const aufgabe = aufgabenSystem.erledigeAufgabe(aufgabeId, antwortText, erledigungsTyp);
      
      // Benachrichtigung an den Ersteller
      const nachrichtText = erledigungsTyp === 'kenntnisnahme'
        ? `Zur Kenntnis genommen (Antrags-ID: ${aufgabe.antragsNummer || aufgabe.antragId})`
        : `Antwort erhalten (Antrags-ID: ${aufgabe.antragsNummer || aufgabe.antragId})`;
      
      notificationSystem.createNotification(
        aufgabe.erstelltVonId,
        'aufgabe-erledigt',
        'Aufgabe erledigt',
        nachrichtText,
        aufgabe.antragId
      );
      
      closeModal('aufgabeInsasseModal');
      showAlert(erledigungsTyp === 'kenntnisnahme' ? 'Zur Kenntnis genommen' : 'Erfolgreich √ºbermittelt');
      renderAntraege();
    }
  </script>
</body>
</html>
