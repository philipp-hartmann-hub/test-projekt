<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mitarbeiter-Portal - Antragswesen</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Login-Bereich -->
  <div class="start-page" id="loginSection">
    <div class="bg-decoration">
      <div class="bg-circle bg-circle-1"></div>
      <div class="bg-circle bg-circle-2"></div>
      <div class="bg-grid"></div>
    </div>

    <div class="login-card">
      <div class="login-header">
        <div class="login-icon">üõ°Ô∏è</div>
        <h2>Mitarbeiter-Portal</h2>
      </div>
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="username">Benutzername</label>
          <input type="text" id="username" placeholder="Benutzername" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="password">Passwort</label>
          <input type="password" id="password" placeholder="Passwort" required autocomplete="current-password">
        </div>
        <div id="loginError" class="login-error" style="display: none;">
          Ung√ºltige Zugangsdaten. Bitte versuchen Sie es erneut.
        </div>
        <button type="submit" class="btn btn-primary btn-full">
          Anmelden
        </button>
      </form>
      <div class="login-hint">
        <a href="index.html" class="btn btn-secondary btn-sm" style="margin-top: 1rem;">‚Üê Zur√ºck zur √úbersicht</a>
      </div>
    </div>
  </div>

  <!-- Portal-Bereich (nach Login sichtbar) -->
  <div id="portalSection" style="display: none;">
    <header class="header">
      <div class="header-left">
        <div class="hamburg-logo">
          <img src="https://pem-center.de/wp-content/uploads/Logo-Stadt-Hamburg.jpg" alt="Stadt Hamburg" class="hamburg-wappen-img">
        </div>
        <div class="header-title">
          <h1>Mitarbeiter-Portal</h1>
          <span class="header-subtitle">Freie und Hansestadt Hamburg</span>
        </div>
      </div>
      <div class="header-right">
        <div class="language-selector">
          <select id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="de">üá©üá™ Deutsch</option>
            <option value="en">üá¨üáß English</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
          </select>
        </div>
        <div class="user-badge">
          <div>
            <div class="role" id="userRole">Mitarbeiter</div>
            <div class="name" id="userName">-</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="logout()" data-i18n="app.logout">Abmelden</button>
      </div>
    </header>

    <main class="container">
      <!-- Begr√º√üung -->
      <div class="welcome-banner" id="welcomeBanner">
        <h2 id="welcomeGreeting">Moin!</h2>
        <p id="welcomeMessage">Willkommen im Mitarbeiter-Portal.</p>
      </div>
      
      <!-- √úbersicht (Dashboard) -->
      <div class="dashboard" id="dashboardView">
        <!-- Postfach / Benachrichtigungen (aufklappbar) -->
        <section class="section notification-section collapsed" id="notificationSection" style="display: none;">
          <div class="notification-header" onclick="togglePostfach()">
            <div class="notification-header-left">
              <span class="postfach-toggle-icon" id="postfachToggleIcon">‚ñ∂</span>
              <h2>üì¨ Postfach <span class="count" id="notificationCount">0</span></h2>
            </div>
            <button class="btn btn-sm" onclick="markAllNotificationsRead(); event.stopPropagation();" id="markAllReadBtn" style="display: none;">
              Alle als gelesen markieren
            </button>
          </div>
          <!-- Vorschau: Nur neueste Nachricht (wenn eingeklappt) -->
          <div class="notification-preview" id="notificationPreview">
            <!-- Dynamisch gef√ºllt -->
          </div>
          <!-- Vollst√§ndige Liste (wenn aufgeklappt) -->
          <div class="notification-dashboard-list" id="notificationList">
            <!-- Dynamisch gef√ºllt -->
          </div>
        </section>

        <!-- Kalender / Termin√ºbersicht -->
        <section class="section kalender-section" id="kalenderSection">
          <div class="kalender-header-bar">
            <h2>Terminuebersicht</h2>
            <div class="kalender-toolbar">
              <div class="kalender-view-buttons">
                <button type="button" class="view-btn" id="viewTagBtn" onclick="setKalenderAnsicht('tag')">Tag</button>
                <button type="button" class="view-btn" id="viewWocheBtn" onclick="setKalenderAnsicht('woche')">Woche</button>
                <button type="button" class="view-btn active" id="viewMonatBtn" onclick="setKalenderAnsicht('monat')">Monat</button>
              </div>
              <div class="kalender-nav">
                <button type="button" class="nav-btn" onclick="kalenderZurueck()" title="Zur√ºck">‚óÄ</button>
                <button type="button" class="nav-btn heute-btn" onclick="kalenderHeute()">Heute</button>
                <span class="kalender-anzeige" id="kalenderAnzeige">Januar 2024</span>
                <button type="button" class="nav-btn" onclick="kalenderVor()" title="Vor">‚ñ∂</button>
              </div>
              <button type="button" class="btn btn-primary btn-sm" onclick="openTerminModal()">+ Neuer Termin</button>
            </div>
          </div>
          <div class="kalender-content">
            <div class="kalender-main" id="kalenderMain">
              <!-- Dynamisch gef√ºllt: Tag, Woche oder Monat -->
            </div>
            <div class="termine-sidebar" id="termineSidebar">
              <h4 id="termineSidebarTitel">Termine heute</h4>
              <div id="termineSidebarListe">
                <!-- Dynamisch gef√ºllt -->
              </div>
            </div>
          </div>
        </section>

        <!-- Info-Box f√ºr Zust√§ndigkeitsbereich -->
        <div class="info-banner" id="zustaendigkeitInfo">
          <!-- Wird dynamisch gef√ºllt -->
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('offen')">Offene Antr√§ge</button>
          <button class="tab" onclick="switchTab('bearbeitung')">Meine Antr√§ge und Aufgaben <span class="tab-count" id="bearbeitungTabCount">0</span></button>
          <button class="tab" onclick="switchTab('historie')">Erledigt</button>
        </div>

        <!-- Offene Antr√§ge -->
        <section class="section" id="offenSection">
          <div class="section-header">
            <h2>Offene Antr√§ge <span class="count" id="offenCount">0</span></h2>
            <div class="sort-controls">
              <label for="sortierungOffen">Sortieren:</label>
              <select id="sortierungOffen" onchange="renderAntraege()">
                <option value="datum-neu">Neueste zuerst</option>
                <option value="datum-alt">√Ñlteste zuerst</option>
                <option value="antragsteller-az">Antragsteller A-Z</option>
                <option value="antragsteller-za">Antragsteller Z-A</option>
              </select>
            </div>
          </div>
          <div class="antrag-list" id="offenList">
            <!-- Dynamisch gef√ºllt -->
          </div>
        </section>

        <!-- Meine Antr√§ge und Aufgaben -->
        <section class="section" id="bearbeitungSection" style="display: none;">
          <div class="section-header">
            <h2>Meine Antr√§ge und Aufgaben <span class="count" id="bearbeitungCount">0</span></h2>
            <div class="sort-controls">
              <label for="sortierung">Sortieren:</label>
              <select id="sortierung" onchange="renderAntraege()">
                <option value="datum-neu">Neueste zuerst</option>
                <option value="datum-alt">√Ñlteste zuerst</option>
                <option value="antragsteller-az">Antragsteller A-Z</option>
                <option value="antragsteller-za">Antragsteller Z-A</option>
              </select>
            </div>
          </div>
          <div class="antrag-list" id="bearbeitungList">
            <!-- Dynamisch gef√ºllt -->
          </div>
        </section>


        <!-- Erledigt / Historie -->
        <section class="section" id="historieSection" style="display: none;">
          <div class="section-header">
            <h2>Erledigte Antr√§ge <span class="count" id="historieCount">0</span></h2>
            <div class="sort-controls">
              <label for="sortierungHistorie">Sortieren:</label>
              <select id="sortierungHistorie" onchange="renderAntraege()">
                <option value="datum-neu">Neueste zuerst</option>
                <option value="datum-alt">√Ñlteste zuerst</option>
                <option value="antragsteller-az">Antragsteller A-Z</option>
                <option value="antragsteller-za">Antragsteller Z-A</option>
              </select>
            </div>
          </div>
          <div class="antrag-list" id="historieList">
            <!-- Dynamisch gef√ºllt -->
          </div>
        </section>
      </div>

      <!-- Antrags-Detailansicht -->
      <div class="dashboard" id="antragDetailView" style="display: none;">
        <div class="back-navigation">
          <button class="btn btn-secondary btn-sm" onclick="closeAntragDetail()" data-i18n-back>‚Üê Zur√ºck zur √úbersicht</button>
        </div>
        
        <div class="detail-view-container" id="antragDetailContent">
          <!-- Wird dynamisch gef√ºllt -->
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Sachliche/Fachliche Pr√ºfung -->
  <div class="modal-overlay" id="pruefungModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Sachliche/Fachliche Pr√ºfung</h3>
        <button class="modal-close" onclick="closeModal('pruefungModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-info">Bitte dokumentieren Sie das Ergebnis Ihrer sachlichen und fachlichen Pr√ºfung.</p>
        <div class="form-group">
          <label for="pruefungKommentar">Pr√ºfungsergebnis / Anmerkungen <span class="required">*</span></label>
          <textarea id="pruefungKommentar" rows="4" placeholder="Ergebnis der sachlichen und fachlichen Pr√ºfung..." required></textarea>
        </div>
        <input type="hidden" id="pruefungAntragId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('pruefungModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmPruefung()">Pr√ºfung abschlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Entscheiden -->
  <div class="modal-overlay" id="entscheidenModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h3>Entscheidung treffen</h3>
        <button class="modal-close" onclick="closeModal('entscheidenModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="entscheidungBegruendung">Begr√ºndung <span class="required">*</span></label>
          <textarea id="entscheidungBegruendung" placeholder="Begr√ºndung eingeben (Pflichtfeld)..." rows="4" required></textarea>
        </div>
        
        <div class="form-group">
          <label class="checkbox-option persoenlich-eroeffnen">
            <input type="checkbox" id="entscheidungPersoenlichEroeffnen">
            <span class="checkbox-label">Persoenlich eroeffnen</span>
          </label>
          <p class="field-hint">Wenn aktiviert: Keine automatische Benachrichtigung. Das Ergebnis wird erst nach pers√∂nlicher Best√§tigung √ºbermittelt.</p>
        </div>
        
        <div class="form-group">
          <label class="checkbox-option vollzug-vor-bekanntgabe">
            <input type="checkbox" id="entscheidungVollzugVorBekanntgabe">
            <span class="checkbox-label">üì¶ Vollzug vor Bekanntgabe an den Insassen planen</span>
          </label>
          <p class="field-hint">Wenn aktiviert: Keine automatische Benachrichtigung. Das Ergebnis wird erst nach pers√∂nlicher Best√§tigung √ºbermittelt.</p>
        </div>
        
        <input type="hidden" id="entscheidenAntragId">
      </div>
      <div class="modal-footer bearbeiten-actions">
        <button class="btn btn-success" onclick="handleEntscheidung('genehmigt')">
          Genehmigen
        </button>
        <button class="btn btn-danger" onclick="handleEntscheidung('abgelehnt')">
          Ablehnen
        </button>
        <button class="btn btn-warning" onclick="handleEntscheidung('teilweise-genehmigt')">
          Teilweise genehmigen
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Vollzug best√§tigen -->
  <div class="modal-overlay" id="vollzugBestaetigenModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Vollzug best√§tigen</h3>
        <button class="modal-close" onclick="closeModal('vollzugBestaetigenModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="vollzug-info">
          <p><strong>Geplante Entscheidung:</strong> <span id="vollzugGeplantEntscheidung"></span></p>
        </div>
        
        <div class="form-group">
          <label for="vollzugKommentar">Kommentar zum Vollzug <span class="required">*</span></label>
          <textarea id="vollzugKommentar" placeholder="Dieser Kommentar wird dem Insassen bei der Bekanntgabe angezeigt..." rows="4" required></textarea>
          <p class="field-hint">Dieser Kommentar ist f√ºr den Insassen sichtbar und wird mit der Bekanntgabe der Entscheidung √ºbermittelt.</p>
        </div>
        
        <input type="hidden" id="vollzugBestaetigenAntragId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('vollzugBestaetigenModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmVollzugBestaetigung()">Vollzug bestaetigen & Bekanntgabe</button>
      </div>
    </div>
  </div>

  <!-- Modal: Aufgabe erstellen -->
  <div class="modal-overlay" id="aufgabeModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h3>Aufgabe erstellen</h3>
        <button class="modal-close" onclick="closeModal('aufgabeModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Aufgabe zuweisen an:</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="aufgabeZiel" value="insasse" onchange="toggleAufgabeZiel('insasse')">
              <span class="radio-label">Insasse (Antragsteller)</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="aufgabeZiel" value="mitarbeiter" onchange="toggleAufgabeZiel('mitarbeiter')">
              <span class="radio-label">Mitarbeitende</span>
            </label>
          </div>
        </div>
        
        <!-- Mitarbeiter-Auswahl (direkt mit Suche) -->
        <div id="mitarbeiterAuswahl" style="display: none;">
          <div class="form-group">
            <label for="aufgabeMitarbeiterSuche">Mitarbeiter suchen</label>
            <input type="text" id="aufgabeMitarbeiterSuche" placeholder="Name eingeben..." oninput="filterMitarbeiterListe()">
          </div>
          <div class="form-group">
            <label>Mitarbeiter ausw√§hlen:</label>
            <div class="mitarbeiter-liste" id="aufgabeMitarbeiterListe">
              <!-- Wird dynamisch gef√ºllt -->
            </div>
            <input type="hidden" id="aufgabePersonId">
            <div class="selected-person" id="selectedPersonDisplay" style="display: none;">
              <span class="selected-label">Ausgew√§hlt:</span>
              <span class="selected-name" id="selectedPersonName"></span>
              <button type="button" class="btn-clear" onclick="clearSelectedPerson()">&times;</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="aufgabeKurzbeschreibung">Kurzbeschreibung (max. 40 Zeichen) *</label>
          <input type="text" id="aufgabeKurzbeschreibung" maxlength="40" placeholder="Kurze Zusammenfassung der Aufgabe..." required>
          <p class="field-hint"><span id="aufgabeKurzCounter">0</span>/40 Zeichen</p>
        </div>
        
        <div class="form-group">
          <label for="aufgabeBeschreibung">Ausf√ºhrliche Beschreibung (optional)</label>
          <textarea id="aufgabeBeschreibung" placeholder="Detaillierte Beschreibung der Aufgabe..." rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label for="aufgabeFrist">Frist (optional)</label>
          <input type="date" id="aufgabeFrist">
          <p class="field-hint">Bei √úberschreitung der Frist werden t√§gliche Erinnerungen gesendet.</p>
        </div>
        
        <div class="form-group">
          <label for="aufgabePdfUpload">PDF-Dokumente anhaengen (optional)</label>
          <input type="file" id="aufgabePdfUpload" accept=".pdf" multiple onchange="handleAufgabePdfUpload(this)">
          <p class="field-hint">W√§hlen Sie eine oder mehrere PDF-Dateien zum Anh√§ngen aus.</p>
          <div id="aufgabePdfList" class="pdf-list"></div>
        </div>
        
        <input type="hidden" id="aufgabeAntragId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('aufgabeModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="sendeAufgabe()">Aufgabe senden</button>
      </div>
    </div>
  </div>

  <!-- Modal: Aufgabe bearbeiten -->
  <div class="modal-overlay" id="aufgabeLoesungModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h3>Aufgabe bearbeiten</h3>
        <button class="modal-close" onclick="closeModal('aufgabeLoesungModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="aufgabe-info" id="aufgabeLoesungInfo">
          <!-- Wird dynamisch gef√ºllt -->
        </div>
        
        <div class="form-group">
          <label>Wie m√∂chten Sie die Aufgabe abschlie√üen?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="aufgabeErledigungsTyp" value="antwort" checked onchange="toggleAntwortFeld()">
              <span class="radio-label">Mit Antwort</span>
              <p class="option-hint">Antrag geht zur√ºck an den Aufgabensteller</p>
            </label>
            <label class="radio-option">
              <input type="radio" name="aufgabeErledigungsTyp" value="kenntnisnahme" onchange="toggleAntwortFeld()">
              <span class="radio-label">Zur Kenntnis genommen</span>
            </label>
          </div>
        </div>
        
        <!-- Optionen bei "Zur Kenntnis" -->
        <div class="form-group" id="aufgabeKenntnisnahmeOptionen" style="display: none;">
          <label>Was soll mit dem Antrag passieren?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="kenntnisnahmeAktion" value="zurueck" checked>
              <span class="radio-label">Zurueck an Aufgabensteller</span>
              <p class="option-hint">Der Antrag geht zur√ºck und wird in Ihre "Erledigt"-Liste verschoben</p>
            </label>
            <label class="radio-option">
              <input type="radio" name="kenntnisnahmeAktion" value="uebernehmen">
              <span class="radio-label">Bearbeitung uebernehmen</span>
              <p class="option-hint">Sie werden zum Hauptbearbeiter des Antrags</p>
            </label>
          </div>
        </div>
        
        <div class="form-group" id="aufgabeAntwortGruppe">
          <label for="aufgabeAntwortText">Antwort</label>
          <textarea id="aufgabeAntwortText" placeholder="Geben Sie Ihre Antwort ein..." rows="4"></textarea>
        </div>
        
        <div class="form-group" id="aufgabeAntwortPdfGruppe">
          <label for="aufgabeAntwortPdfUpload">PDF-Dokumente anhaengen (optional)</label>
          <input type="file" id="aufgabeAntwortPdfUpload" accept=".pdf" multiple onchange="handleAntwortPdfUpload(this)">
          <p class="field-hint">W√§hlen Sie eine oder mehrere PDF-Dateien zum Anh√§ngen aus.</p>
          <div id="aufgabeAntwortPdfList" class="pdf-list"></div>
        </div>
        
        <input type="hidden" id="aufgabeLoesungId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('aufgabeLoesungModal')">Abbrechen</button>
        <button class="btn btn-success" onclick="erledigeAufgabe()">Aufgabe abschlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Antrag weiterleiten -->
  <div class="modal-overlay" id="weiterleitenModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h3>Antrag weiterleiten?</h3>
        <button class="modal-close" onclick="closeWeiterleitenModal(false)">&times;</button>
      </div>
      <div class="modal-body">
        <div class="weiterleiten-info">
          <p id="weiterleitenPhaseInfo"></p>
        </div>
        
        <div class="form-group">
          <label>M√∂chten Sie den Antrag an einen anderen Mitarbeiter weiterleiten?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="weiterleitenEntscheidung" value="nein" checked onchange="toggleWeiterleitenFelder()">
              <span class="radio-label">Nein, ich bearbeite weiter</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="weiterleitenEntscheidung" value="ja" onchange="toggleWeiterleitenFelder()">
              <span class="radio-label">Ja, an anderen Mitarbeiter weiterleiten</span>
            </label>
          </div>
        </div>
        
        <div id="weiterleitenFelder" style="display: none;">
          <div class="form-group">
            <label for="weiterleitenMitarbeiterSuche">Mitarbeiter suchen</label>
            <input type="text" id="weiterleitenMitarbeiterSuche" placeholder="Name eingeben..." oninput="filterWeiterleitenMitarbeiter()">
          </div>
          <div class="form-group">
            <label>Mitarbeiter ausw√§hlen:</label>
            <div class="mitarbeiter-liste" id="weiterleitenMitarbeiterListe" style="max-height: 250px; overflow-y: auto;">
              <!-- Wird dynamisch gef√ºllt -->
            </div>
          </div>
          <div class="form-group" id="weiterleitenSelectedContainer" style="display: none;">
            <div class="selected-person-box">
              <span class="selected-label">Ausgewaehlt:</span>
              <span class="selected-name" id="weiterleitenSelectedPersonName"></span>
              <button type="button" class="btn-clear-small" onclick="clearWeiterleitenSelection()">√ó</button>
            </div>
          </div>
          <input type="hidden" id="weiterleitenPersonId">
          <div class="form-group">
            <label for="weiterleitenNotiz">Notiz zur Weiterleitung (optional)</label>
            <textarea id="weiterleitenNotiz" placeholder="Kurze Notiz f√ºr den n√§chsten Bearbeiter..." rows="3"></textarea>
          </div>
        </div>
        
        <input type="hidden" id="weiterleitenAntragId">
        <input type="hidden" id="weiterleitenPhase">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeWeiterleitenModal(false)">Abbrechen</button>
        <button class="btn btn-primary" onclick="confirmWeiterleiten()">Best√§tigen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Neuer Termin -->
  <div class="modal-overlay" id="terminModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Neuer Termin</h3>
        <button class="modal-close" onclick="closeModal('terminModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="terminTitel">Titel <span class="required">*</span></label>
          <input type="text" id="terminTitel" placeholder="Titel des Termins" required>
        </div>
        
        <div class="form-group">
          <label for="terminBeschreibung">Beschreibung</label>
          <textarea id="terminBeschreibung" placeholder="Optionale Beschreibung..." rows="3"></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="terminDatum">Datum <span class="required">*</span></label>
            <input type="date" id="terminDatum" required>
          </div>
          <div class="form-group">
            <label for="terminUhrzeit">Uhrzeit (optional)</label>
            <input type="time" id="terminUhrzeit">
          </div>
        </div>
        
        <div class="form-group" id="terminSichtbarkeitGruppe">
          <label>Sichtbarkeit</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="terminSichtbarkeit" value="persoenlich" checked onchange="updateTerminSichtbarkeit()">
              <span class="radio-label">Nur fuer mich</span>
            </label>
            <label class="radio-option" id="terminHausOption" style="display: none;">
              <input type="radio" name="terminSichtbarkeit" value="haus" onchange="updateTerminSichtbarkeit()">
              <span class="radio-label">Mein Haus</span>
            </label>
            <label class="radio-option" id="terminStationOption" style="display: none;">
              <input type="radio" name="terminSichtbarkeit" value="station" onchange="updateTerminSichtbarkeit()">
              <span class="radio-label">üìç Meine Station</span>
            </label>
          </div>
        </div>
        
        <input type="hidden" id="terminEditId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('terminModal')">Abbrechen</button>
        <button class="btn btn-primary" onclick="speichereTermin()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Modal: Termin-Details -->
  <div class="modal-overlay" id="terminDetailModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Termin-Details</h3>
        <button class="modal-close" onclick="closeModal('terminDetailModal')">&times;</button>
      </div>
      <div class="modal-body" id="terminDetailContent">
        <!-- Wird dynamisch gef√ºllt -->
      </div>
      <div class="modal-footer" id="terminDetailFooter">
        <button class="btn btn-secondary" onclick="closeModal('terminDetailModal')">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    let currentSession = null;
    let currentAntragId = null;

    // ============================================
    // SPRACHSTEUERUNG
    // ============================================
    
    function changeLanguage(lang) {
      setLanguage(lang);
      updateUITranslations();
      // Listen neu rendern mit neuer Sprache
      if (currentSession) {
        renderAntraege();
        renderNotifications();
        renderKalender();
      }
    }
    
    function updateUITranslations() {
      // Statische Elemente mit data-i18n Attribut √ºbersetzen
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      
      // Placeholder √ºbersetzen
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });
      
      // Tabs aktualisieren
      const tabs = document.querySelectorAll('.tabs .tab');
      if (tabs.length >= 4) {
        tabs[0].innerHTML = t('nav.openApplications');
        tabs[1].innerHTML = t('nav.myApplicationsTasks') + ' <span class="tab-count" id="bearbeitungTabCount">0</span>';
        tabs[2].innerHTML = t('nav.personalOpening');
        tabs[3].innerHTML = t('nav.completed');
      }
      
      // Postfach-Titel
      const postfachTitle = document.querySelector('#notificationSection h2');
      if (postfachTitle) {
        const count = document.getElementById('notificationCount')?.textContent || '0';
        postfachTitle.innerHTML = `üì¨ ${t('inbox.title')} <span class="count" id="notificationCount">${count}</span>`;
      }
      
      // Kalender-Titel
      const kalenderTitle = document.querySelector('.kalender-header-bar h2');
      if (kalenderTitle) {
        kalenderTitle.textContent = '' + t('calendar.title');
      }
      
      // View-Buttons
      if (document.getElementById('viewTagBtn')) document.getElementById('viewTagBtn').textContent = t('calendar.day');
      if (document.getElementById('viewWocheBtn')) document.getElementById('viewWocheBtn').textContent = t('calendar.week');
      if (document.getElementById('viewMonatBtn')) document.getElementById('viewMonatBtn').textContent = t('calendar.month');
      
      // Heute-Button
      const heuteBtn = document.querySelector('.heute-btn');
      if (heuteBtn) heuteBtn.textContent = t('calendar.today');
      
      // Sortier-Labels
      document.querySelectorAll('.sort-controls label').forEach(label => {
        label.textContent = t('sort.label') + ':';
      });
      
      // Sortier-Optionen
      document.querySelectorAll('.sort-controls select').forEach(select => {
        const options = select.querySelectorAll('option');
        if (options.length >= 4) {
          options[0].textContent = t('sort.newest');
          options[1].textContent = t('sort.oldest');
          options[2].textContent = t('sort.applicantAZ');
          options[3].textContent = t('sort.applicantZA');
        }
      });
      
      // ============================================
      // MODAL-√úBERSETZUNGEN
      // ============================================
      
      // Aufgabe-Modal
      const aufgabeModalTitle = document.querySelector('#aufgabeModal .modal-header h3');
      if (aufgabeModalTitle) aufgabeModalTitle.textContent = t('task.create');
      
      const aufgabeZuweisen = document.querySelector('#aufgabeModal .modal-body > .form-group > label');
      if (aufgabeZuweisen) aufgabeZuweisen.textContent = t('task.assignTo') + ':';
      
      // Radio-Labels im Aufgabe-Modal
      const aufgabeRadios = document.querySelectorAll('#aufgabeModal .radio-label');
      if (aufgabeRadios.length >= 2) {
        aufgabeRadios[0].textContent = '' + t('task.assignToInmate');
        aufgabeRadios[1].textContent = '' + t('task.assignToStaff');
      }
      
      // Mitarbeiter-Suche
      const mitarbeiterSucheLabel = document.querySelector('label[for="aufgabeMitarbeiterSuche"]');
      if (mitarbeiterSucheLabel) mitarbeiterSucheLabel.textContent = t('task.searchStaff');
      const mitarbeiterSucheInput = document.getElementById('aufgabeMitarbeiterSuche');
      if (mitarbeiterSucheInput) mitarbeiterSucheInput.placeholder = t('masterdata.name') + '...';
      
      const mitarbeiterAuswahlLabel = document.querySelector('#mitarbeiterAuswahl .form-group:nth-child(2) > label');
      if (mitarbeiterAuswahlLabel) mitarbeiterAuswahlLabel.textContent = t('task.selectStaff') + ':';
      
      const selectedLabel = document.querySelector('.selected-label');
      if (selectedLabel) selectedLabel.textContent = t('task.selected') + ':';
      
      // Kurzbeschreibung
      const kurzLabel = document.querySelector('label[for="aufgabeKurzbeschreibung"]');
      if (kurzLabel) kurzLabel.textContent = t('task.shortDescription') + ' (' + t('form.maxChars', {count: 40}) + ') *';
      const kurzInput = document.getElementById('aufgabeKurzbeschreibung');
      if (kurzInput) kurzInput.placeholder = t('task.shortDescription') + '...';
      
      // Ausf√ºhrliche Beschreibung
      const beschrLabel = document.querySelector('label[for="aufgabeBeschreibung"]');
      if (beschrLabel) beschrLabel.textContent = t('task.description') + ' (' + t('form.optional') + ')';
      const beschrInput = document.getElementById('aufgabeBeschreibung');
      if (beschrInput) beschrInput.placeholder = t('task.description') + '...';
      
      // Frist
      const fristLabel = document.querySelector('label[for="aufgabeFrist"]');
      if (fristLabel) fristLabel.textContent = t('task.deadline') + ' (' + t('form.optional') + ')';
      const fristHint = document.querySelector('#aufgabeModal .form-group:nth-child(5) .field-hint');
      if (fristHint) fristHint.textContent = t('task.deadlineHint');
      
      // PDF anh√§ngen
      const pdfCheckbox = document.querySelector('#aufgabePdfAnhaengen + .checkbox-label');
      if (pdfCheckbox) pdfCheckbox.textContent = '' + t('task.attachPdf');
      
      // Aufgabe-Modal Buttons
      const aufgabeModalBtns = document.querySelectorAll('#aufgabeModal .modal-footer .btn');
      if (aufgabeModalBtns.length >= 2) {
        aufgabeModalBtns[0].textContent = t('button.cancel');
        aufgabeModalBtns[1].textContent = t('task.send');
      }
      
      // Aufgabe-L√∂sung-Modal
      const loesungModalTitle = document.querySelector('#aufgabeLoesungModal .modal-header h3');
      if (loesungModalTitle) loesungModalTitle.textContent = t('task.edit');
      
      const loesungModalBtns = document.querySelectorAll('#aufgabeLoesungModal .modal-footer .btn');
      if (loesungModalBtns.length >= 2) {
        loesungModalBtns[0].textContent = t('button.cancel');
        loesungModalBtns[1].textContent = t('task.complete');
      }
      
      // Termin-Modal
      const terminModalTitle = document.querySelector('#terminModal .modal-header h3');
      if (terminModalTitle) terminModalTitle.textContent = t('calendar.newAppointment');
      
      const terminTitelLabel = document.querySelector('label[for="terminTitel"]');
      if (terminTitelLabel) terminTitelLabel.textContent = t('appointment.title');
      
      const terminDatumLabel = document.querySelector('label[for="terminDatum"]');
      if (terminDatumLabel) terminDatumLabel.textContent = t('appointment.date');
      
      const terminUhrzeitLabel = document.querySelector('label[for="terminUhrzeit"]');
      if (terminUhrzeitLabel) terminUhrzeitLabel.textContent = t('appointment.time') + ' (' + t('form.optional') + ')';
      
      const terminTypLabel = document.querySelector('label[for="terminTyp"]');
      if (terminTypLabel) terminTypLabel.textContent = t('appointment.type');
      
      // Termin-Typ Optionen
      const terminTypSelect = document.getElementById('terminTyp');
      if (terminTypSelect) {
        const opts = terminTypSelect.querySelectorAll('option');
        if (opts.length >= 1) opts[0].textContent = t('appointment.private');
        if (opts.length >= 2) opts[1].textContent = '' + t('appointment.house');
        if (opts.length >= 3) opts[2].textContent = 'üìç ' + t('appointment.station');
      }
      
      const terminModalBtns = document.querySelectorAll('#terminModal .modal-footer .btn');
      if (terminModalBtns.length >= 2) {
        terminModalBtns[0].textContent = t('button.cancel');
        terminModalBtns[1].textContent = t('button.save');
      }
      
      // Termin-Detail-Modal
      const terminDetailBtns = document.querySelectorAll('#terminDetailModal .modal-footer .btn-secondary');
      terminDetailBtns.forEach(btn => {
        if (btn.textContent.includes('Schlie√üen') || btn.textContent.includes('Close') || btn.textContent.includes('Fermer')) {
          btn.textContent = t('button.close');
        }
      });
      
      // Entscheiden-Modal
      const entscheidenModalTitle = document.querySelector('#entscheidenModal .modal-header h3');
      if (entscheidenModalTitle) entscheidenModalTitle.textContent = t('decision.title');
      
      // Genehmigen/Ablehnen Buttons im Entscheiden-Modal
      const entscheidenBtns = document.querySelectorAll('#entscheidenModal .decision-buttons .btn');
      entscheidenBtns.forEach(btn => {
        if (btn.classList.contains('btn-success')) btn.innerHTML = '' + t('action.approve');
        if (btn.classList.contains('btn-warning')) btn.innerHTML = '' + t('action.partiallyApprove');
        if (btn.classList.contains('btn-danger')) btn.innerHTML = t('action.reject');
      });
      
      const begruendungLabel = document.querySelector('label[for="entscheidungBegruendung"]');
      if (begruendungLabel) begruendungLabel.textContent = t('decision.reason') + ' *';
      
      const persEroeffnungLabel = document.querySelector('#entscheidungPersoenlichEroeffnen + .checkbox-label');
      if (persEroeffnungLabel) persEroeffnungLabel.textContent = t('decision.personalOpeningCheck');
      
      const vollzugVorBekanntgabeLabel = document.querySelector('#entscheidungVollzugVorBekanntgabe + .checkbox-label');
      if (vollzugVorBekanntgabeLabel) vollzugVorBekanntgabeLabel.textContent = 'üì¶ ' + t('decision.executionBeforeNotification');
      
      // Hinweistexte f√ºr beide Checkboxen
      const checkboxHints = document.querySelectorAll('#entscheidenModal .field-hint');
      checkboxHints.forEach(hint => {
        hint.textContent = t('decision.noAutoNotificationHint');
      });
      
      // Zur√ºck-Button
      const backBtn = document.querySelector('[data-i18n-back]');
      if (backBtn) backBtn.textContent = '‚Üê ' + t('button.backToOverview');
      
      // Termin-Detail-Modal Titel
      const terminDetailTitle = document.querySelector('#terminDetailModal .modal-header h3');
      if (terminDetailTitle) terminDetailTitle.textContent = currentLanguage === 'en' ? 'Appointment Details' : currentLanguage === 'fr' ? 'D√©tails du rendez-vous' : 'Termin-Details';
    }
    
    // √úbersetzte Statusanzeige
    function getStatusText(status) {
      const statusMap = {
        'entwurf': t('status.draft'),
        'eingereicht': t('status.submitted'),
        'in-bearbeitung': t('status.inProgress'),
        'genehmigt': t('status.approved'),
        'abgelehnt': t('status.rejected'),
        'teilweise-genehmigt': t('status.partiallyApproved'),
        'erledigt': t('status.completed'),
        'offen': t('status.open')
      };
      return statusMap[status] || status;
    }
    
    // √úbersetzte Antragstypen
    function getAntragsTypText(type) {
      const typeMap = {
        'teilhabegeld': t('application.type.teilhabegeld'),
        'eigentum': t('application.type.eigentum'),
        'sonstiges': t('application.type.sonstiges')
      };
      return typeMap[type] || type;
    }
    
    // √úbersetzte Aktivit√§tsbeschreibung
    function getAktivitaetBeschreibung(aktivitaet) {
      const typ = aktivitaet.typ;
      const details = aktivitaet.details || {};
      const dateLocale = currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE';
      
      switch (typ) {
        case 'erstellt':
          const appType = aktivitaet.beschreibung.includes('Teilhabegeld') ? t('apptype.teilhabegeld') : t('apptype.eigentum');
          const fromDraft = aktivitaet.beschreibung.includes('Entwurf') 
            ? (currentLanguage === 'en' ? ' (from draft)' : currentLanguage === 'fr' ? ' (depuis brouillon)' : ' (aus Entwurf)')
            : '';
          return `${t('application.title')} "${appType}" ${currentLanguage === 'en' ? 'submitted' : currentLanguage === 'fr' ? 'soumise' : 'eingereicht'}${fromDraft}`;
          
        case 'genommen':
          return t('history.taken');
          
        case 'uebernommen':
          const von = aktivitaet.beschreibung.replace('Antrag √ºbernommen von ', '');
          return `${t('history.takenOver')} ${von}`;
          
        case 'sachlich-geprueft':
          const pruefText = t('history.reviewed');
          if (details.kommentar) {
            return `${pruefText}: "${details.kommentar}"`;
          }
          return pruefText;
          
        case 'entscheidung':
          const status = aktivitaet.beschreibung.replace('Entscheidung: ', '');
          let statusTranslated = status;
          if (status === 'Genehmigt') statusTranslated = t('status.approved');
          else if (status === 'Abgelehnt') statusTranslated = t('status.rejected');
          else if (status === 'Teilweise genehmigt') statusTranslated = t('status.partiallyApproved');
          return `${t('history.decided')}: ${statusTranslated}`;
          
        case 'entscheidung-geplant':
          const statusGeplant = aktivitaet.beschreibung.replace(' vorbereitet (pers√∂nliche Er√∂ffnung)', '');
          let statusGeplantTranslated = statusGeplant;
          if (statusGeplant === 'Genehmigung') statusGeplantTranslated = t('status.approved');
          else if (statusGeplant === 'Ablehnung') statusGeplantTranslated = t('status.rejected');
          else if (statusGeplant === 'Teilweise Genehmigung') statusGeplantTranslated = t('status.partiallyApproved');
          return `${statusGeplantTranslated} ${t('history.decisionPlanned').replace(/^.*\(/, '(').replace('Entscheidung vorbereitet ', '')}`;
          
        case 'persoenlich-eroeffnet':
          const statusEroeffnet = aktivitaet.beschreibung.replace('Pers√∂nliche Er√∂ffnung: ', '');
          let statusEroeffnetTranslated = statusEroeffnet;
          if (statusEroeffnet === 'Genehmigt') statusEroeffnetTranslated = t('status.approved');
          else if (statusEroeffnet === 'Abgelehnt') statusEroeffnetTranslated = t('status.rejected');
          else if (statusEroeffnet === 'Teilweise genehmigt') statusEroeffnetTranslated = t('status.partiallyApproved');
          return `${t('history.personalOpening')}: ${statusEroeffnetTranslated}`;
          
        case 'aufgabe-erstellt':
          const zielTyp = details.zugewiesenAn ? details.zugewiesenAn : '';
          const fristText = details.frist 
            ? ` (${t('history.deadline')}: ${new Date(details.frist).toLocaleDateString(dateLocale)})` 
            : '';
          return `${t('history.taskCreatedFor')} ${zielTyp}${fristText}`;
          
        case 'aufgabe-erledigt':
          if (details.erledigungsTyp === 'kenntnisnahme') {
            return t('history.taskAcknowledged');
          }
          return t('history.taskAnswered');
          
        case 'aufgabe-geloescht':
          return t('history.taskDeleted');
          
        case 'vollzogen':
          return t('history.executed');
          
        case 'veraktet':
          return t('history.archived');
          
        default:
          // Fallback: versuche Freitext zu √ºbersetzen
          return getTranslatedUserText(aktivitaet.beschreibung) || aktivitaet.beschreibung;
      }
    }

    // ============================================
    // LOGIN
    // ============================================
    
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      const result = sessionManager.login(username, password, 'mitarbeiter');
      
      if (result.success) {
        currentSession = result.user;
        showPortal();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    function logout() {
      sessionManager.logout();
      currentSession = null;
      resetLanguage(); // Sprache zur√ºcksetzen f√ºr n√§chsten Benutzer
      location.reload();
    }
    
    function showPortal() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('portalSection').style.display = 'block';
      document.getElementById('userName').textContent = currentSession.name;
      document.getElementById('userRole').textContent = getRolleText(currentSession.rolle);
      
      // Moin-Begr√º√üung setzen
      document.getElementById('welcomeGreeting').textContent = 'Moin, ' + currentSession.name + '!';
      const welcomeMsg = currentLanguage === 'en' ? 'Welcome to the Staff Portal.' 
                       : currentLanguage === 'fr' ? 'Bienvenue dans le portail des employ√©s.' 
                       : 'Willkommen im Mitarbeiter-Portal.';
      document.getElementById('welcomeMessage').textContent = welcomeMsg;
      
      // Benutzersprache laden
      loadUserLanguage(currentSession.userId);
      document.getElementById('languageSelect').value = currentLanguage;
      updateUITranslations();
      
      // Zust√§ndigkeitsbereich anzeigen
      updateZustaendigkeitInfo();
      
      // √úberf√§llige Aufgaben pr√ºfen (sendet Erinnerungen)
      aufgabenSystem.pruefeUeberfaelligeAufgaben();
      
      renderAntraege();
      renderNotifications();
      renderKalender();
      
      // Benachrichtigungen und √ºberf√§llige Aufgaben periodisch pr√ºfen
      setInterval(() => {
        aufgabenSystem.pruefeUeberfaelligeAufgaben();
        renderNotifications();
        renderAntraege();
      }, 60000); // Jede Minute pr√ºfen
    }

    // ============================================
    // BENACHRICHTIGUNGEN (POSTFACH)
    // ============================================
    
    // Postfach auf-/zuklappen
    let postfachExpanded = false;
    
    function togglePostfach() {
      const section = document.getElementById('notificationSection');
      const icon = document.getElementById('postfachToggleIcon');
      
      postfachExpanded = !postfachExpanded;
      
      if (postfachExpanded) {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        icon.textContent = '‚ñº';
      } else {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
      }
    }
    
    function renderNotifications() {
      if (!currentSession) return;
      
      const list = document.getElementById('notificationList');
      const preview = document.getElementById('notificationPreview');
      const notifications = notificationSystem.getAllNotifications(currentSession.userId);
      const section = document.getElementById('notificationSection');
      const unreadCount = notificationSystem.getUnreadCount(currentSession.userId);
      
      document.getElementById('notificationCount').textContent = unreadCount;
      
      // "Alle als gelesen" Button nur anzeigen, wenn es ungelesene gibt
      const markAllBtn = document.getElementById('markAllReadBtn');
      markAllBtn.style.display = unreadCount > 0 ? 'inline-block' : 'none';
      
      if (notifications.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'flex';
      
      // Vorschau: Nur neueste Nachricht
      if (notifications.length > 0) {
        const newest = notifications[0];
        const typeClass = newest.type || 'info';
        const unreadClass = newest.gelesen ? 'read' : 'unread';
        
        preview.innerHTML = `
          <div class="notification-card ${typeClass} ${unreadClass}" onclick="handleNotificationClick('${newest.id}', '${newest.antragId || ''}'); event.stopPropagation();">
            <div class="notification-card-icon">${getNotificationIcon(newest.type)}</div>
            <div class="notification-card-content">
              <div class="notification-card-title">${newest.title}</div>
              <div class="notification-card-message">${newest.message}</div>
              <div class="notification-card-time">${formatDate(newest.erstelltAm)}</div>
            </div>
            ${!newest.gelesen ? '<div class="notification-card-dot"></div>' : ''}
          </div>
          ${notifications.length > 1 ? `<div class="notification-more-hint">+ ${notifications.length - 1} weitere Nachrichten</div>` : ''}
        `;
      }
      
      // Vollst√§ndige Liste
      list.innerHTML = notifications.map(n => {
        const typeClass = n.type || 'info';
        const unreadClass = n.gelesen ? 'read' : 'unread';
        
        return `
          <div class="notification-card ${typeClass} ${unreadClass}" onclick="handleNotificationClick('${n.id}', '${n.antragId || ''}'); event.stopPropagation();">
            <div class="notification-card-icon">${getNotificationIcon(n.type)}</div>
            <div class="notification-card-content">
              <div class="notification-card-title">${n.title}</div>
              <div class="notification-card-message">${n.message}</div>
              <div class="notification-card-time">${formatDate(n.erstelltAm)}</div>
            </div>
            ${!n.gelesen ? '<div class="notification-card-dot"></div>' : ''}
          </div>
        `;
      }).join('');
    }
    
    function getNotificationIcon(type) {
      return ''; // Icons entfernt
    }
    
    function getVerlaufIcon(typ) {
      return ''; // Icons entfernt
    }
    
    // ============================================
    // KOMMENTAR-FUNKTIONEN
    // ============================================
    
    function renderKommentare(kommentare) {
      if (!kommentare || kommentare.length === 0) {
        const emptyText = currentLanguage === 'en' ? 'No notes yet.' 
                        : currentLanguage === 'fr' ? 'Pas encore de notes.' 
                        : 'Noch keine Notizen.';
        return `<p class="empty-hint">${emptyText}</p>`;
      }
      
      // Sortieren: neueste zuerst
      const sortiert = [...kommentare].sort((a, b) => new Date(b.erstelltAm) - new Date(a.erstelltAm));
      
      return sortiert.map(k => {
        const datum = new Date(k.erstelltAm);
        const datumStr = datum.toLocaleDateString('de-DE') + ' ' + datum.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        
        return `
          <div class="kommentar-item">
            <div class="kommentar-header">
              <span class="kommentar-autor">${k.benutzerName}</span>
              <span class="kommentar-datum">${datumStr}</span>
            </div>
            <div class="kommentar-text">${k.text.replace(/\n/g, '<br>')}</div>
          </div>
        `;
      }).join('');
    }
    
    function addKommentar(antragId) {
      const textarea = document.getElementById('neuerKommentar');
      const text = textarea.value.trim();
      
      if (!text) {
        const msg = currentLanguage === 'en' ? 'Please enter a note.' 
                  : currentLanguage === 'fr' ? 'Veuillez entrer une note.' 
                  : 'Bitte geben Sie eine Notiz ein.';
        showAlert(msg);
        return;
      }
      
      // Kommentar speichern
      antragSystem.addKommentar(antragId, text, currentSession.userId, currentSession.name);
      
      // Eingabefeld leeren und Ansicht aktualisieren
      textarea.value = '';
      openAntragDetail(antragId);
    }
    
    function handleNotificationClick(notificationId, antragId) {
      notificationSystem.markAsRead(notificationId);
      renderNotifications();
      
      // Wenn ein Antrag verkn√ºpft ist, zur Detailansicht wechseln
      if (antragId) {
        const antrag = antragSystem.getAntrag(antragId);
        if (antrag && antrag.bearbeiterId === currentSession.userId) {
          openAntragDetail(antragId);
        }
      }
    }
    
    function markAllNotificationsRead() {
      if (!currentSession) return;
      notificationSystem.markAllAsRead(currentSession.userId);
      renderNotifications();
    }
    
    function updateZustaendigkeitInfo() {
      const info = document.getElementById('zustaendigkeitInfo');
      const hausNames = currentSession.jvas ? currentSession.jvas.map(j => getHausName(j)).join(', ') : '-';
      
      if (currentSession.rolle === 'jva-leitung' || currentSession.rolle === 'haus-leitung') {
        info.innerHTML = `
          <div class="info-content">
            <span class="info-icon"></span>
            <span>Als <strong>Hausleitung</strong> sehen Sie alle Antr√§ge des <strong>${hausNames}</strong> (alle Stationen)</span>
          </div>
        `;
      } else if (currentSession.rolle === 'stationsleitung') {
        info.innerHTML = `
          <div class="info-content">
            <span class="info-icon"></span>
            <span>Als <strong>Stationsleitung</strong> sehen Sie alle Antr√§ge des <strong>${hausNames} - Station ${currentSession.station}</strong></span>
          </div>
        `;
      } else {
        info.innerHTML = `
          <div class="info-content">
            <span class="info-icon"></span>
            <span>Als <strong>Mitarbeiter</strong> sehen Sie offene Antr√§ge des <strong>${hausNames} - Station ${currentSession.station}</strong> und Ihre pers√∂nlich bearbeiteten Antr√§ge</span>
          </div>
        `;
      }
    }
    
    // Check if already logged in
    const existingSession = sessionManager.getSession();
    if (existingSession && existingSession.type === 'mitarbeiter') {
      currentSession = existingSession;
      showPortal();
    }

    // ============================================
    // TAB-WECHSEL
    // ============================================
    
    function switchTab(tab) {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => t.classList.remove('active'));
      
      document.getElementById('offenSection').style.display = 'none';
      document.getElementById('bearbeitungSection').style.display = 'none';
      document.getElementById('historieSection').style.display = 'none';
      
      if (tab === 'offen') {
        tabs[0].classList.add('active');
        document.getElementById('offenSection').style.display = 'block';
      } else if (tab === 'bearbeitung') {
        tabs[1].classList.add('active');
        document.getElementById('bearbeitungSection').style.display = 'block';
      } else {
        tabs[2].classList.add('active');
        document.getElementById('historieSection').style.display = 'block';
      }
    }

    // ============================================
    // ANTRAGS-CARDS (√úBERSICHT)
    // ============================================
    
    function renderAntragCard(antrag, mode = 'offen') {
      const statusClass = antrag.status;
      const isOwnAntrag = antrag.bearbeiterId === currentSession.userId;
      
      let detailsHtml = '';
      let typeLabel = '';
      
      if (antrag.type === 'teilhabegeld') {
        typeLabel = 'üí∞ Teilhabegeld';
        detailsHtml = `<p><strong>Monat:</strong> ${formatMonat(antrag.monat)}</p>`;
      } else if (antrag.type === 'eigentum') {
        typeLabel = 'üëï Eigentum in der Kammer';
        const aktionText = antrag.aktion === 'aufstocken' ? 'Kleidung aufstocken' : 'Kleidung tauschen';
        detailsHtml = `
          <p><strong>Aktion:</strong> ${aktionText}</p>
          <p><strong>Kleidung:</strong> ${antrag.kleidung.join(', ')}</p>
        `;
      }
      
      // Antrags-Nummer anzeigen
      const antragsNummer = antrag.antragsNummer ? `<span class="antrags-nummer">${antrag.antragsNummer}</span>` : '';
      
      // Insassen-Info mit Insassen-Nummer
      const insassenNummer = antrag.insassenNummer ? `<span class="insassen-nummer">${antrag.insassenNummer}</span>` : '';
      const insassenInfo = `
        <div class="antrag-insasse">
          <span class="insasse-icon"></span>
          <span>${insassenNummer} <strong>${antrag.insasseName}</strong> (${getHausName(antrag.insasseJva)} - Station ${antrag.insasseStation})</span>
        </div>
      `;
      
      let actionsHtml = '';
      let bearbeiterInfo = '';
      
      if (mode === 'offen') {
        actionsHtml = `
          <div class="antrag-actions">
            <button class="btn btn-secondary btn-sm" onclick="openAntragDetail('${antrag.id}', false, true)">
              üìÇ ${t('button.open')}
            </button>
            <button class="btn btn-primary btn-sm" onclick="nehmeAntrag('${antrag.id}')">
${t('button.takeApplication')}
            </button>
          </div>
        `;
      } else if (mode === 'bearbeitung') {
        // Bearbeiter-Info anzeigen (wichtig f√ºr Leitungen)
        if (antrag.bearbeiterName) {
          bearbeiterInfo = `
            <div class="bearbeiter-info ${isOwnAntrag ? 'own' : ''}">
              <span class="bearbeiter-icon"></span>
              <span>Bearbeitet von: <strong>${antrag.bearbeiterName}</strong>${isOwnAntrag ? ' (Sie)' : ''}</span>
            </div>
          `;
        }
        
        // Nur eigene Antr√§ge k√∂nnen bearbeitet werden
        if (isOwnAntrag) {
          actionsHtml = `
            <div class="antrag-actions">
              <button class="btn btn-primary btn-sm" onclick="openAntragDetail('${antrag.id}')">
                ${t('button.open')}
              </button>
            </div>
          `;
        }
      } else if (mode === 'eroeffnung') {
        // Antr√§ge die auf pers√∂nliche Er√∂ffnung warten
        const ergebnisText = antrag.geplantesErgebnis === 'genehmigt' ? 'Genehmigt' : 
                            antrag.geplantesErgebnis === 'abgelehnt' ? 'Abgelehnt' : 'Teilweise genehmigt';
        const ergebnisClass = antrag.geplantesErgebnis;
        
        bearbeiterInfo = `
          <div class="eroeffnung-info">
            <div class="eroeffnung-ergebnis ${ergebnisClass}">
              <strong>Geplantes Ergebnis:</strong> ${ergebnisText}
            </div>
            ${antrag.geplanteBegruendung ? `<div class="eroeffnung-begruendung"><strong>Begr√ºndung:</strong> ${getTranslatedUserText(antrag.geplanteBegruendung)}</div>` : ''}
          </div>
        `;
        
        actionsHtml = `
          <div class="antrag-actions">
            <button class="btn btn-success btn-sm" onclick="bestaetigeEroeffnung('${antrag.id}')">
Pers√∂nlich er√∂ffnet
            </button>
          </div>
        `;
      } else if (mode === 'historie') {
        // Erledigte Antr√§ge k√∂nnen ge√∂ffnet werden (Verlauf ansehen, verakten)
        if (antrag.begruendung) {
          detailsHtml += `<p class="antrag-feedback"><strong>Begr√ºndung:</strong> ${getTranslatedUserText(antrag.begruendung)}</p>`;
        }
        if (antrag.bearbeiterName) {
          bearbeiterInfo = `
            <div class="bearbeiter-info ${antrag.bearbeiterId === currentSession.userId ? 'own' : ''}">
              <span class="bearbeiter-icon"></span>
              <span>Bearbeitet von: <strong>${antrag.bearbeiterName}</strong>${antrag.bearbeiterId === currentSession.userId ? ' (Sie)' : ''}${antrag.persoenlichEroeffnet ? '' : ''}</span>
            </div>
          `;
        }
        // √ñffnen-Button f√ºr erledigte Antr√§ge
        actionsHtml = `
          <div class="antrag-actions">
            <button class="btn btn-secondary btn-sm" onclick="openAntragDetail('${antrag.id}', true)">
              üìÇ ${t('button.open')}
            </button>
          </div>
        `;
      }
      
      return `
        <div class="antrag-card">
          ${insassenInfo}
          <div class="antrag-header">
            <span class="antrag-type">${antragsNummer} ${typeLabel}</span>
            <span class="status-badge ${statusClass}">
              ${getStatusIcon(antrag.status)} ${getStatusText(antrag.status)}
            </span>
          </div>
          <div class="antrag-body">
            ${detailsHtml}
            <p class="antrag-date">Eingereicht: ${formatDate(antrag.erstelltAm)}</p>
            ${antrag.bearbeitetAm ? `<p class="antrag-date">Bearbeitet: ${formatDate(antrag.bearbeitetAm)}</p>` : ''}
          </div>
          ${bearbeiterInfo}
          ${actionsHtml}
        </div>
      `;
    }

    // Aufgaben-Karte rendern
    function renderAufgabeCard(aufgabe) {
      const antrag = antragSystem.getAntrag(aufgabe.antragId);
      const antragsNummer = antrag ? antrag.antragsNummer : aufgabe.antragsNummer;
      const istErsteller = aufgabe.erstelltVonId === currentSession.userId;
      const dateLocale = currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE';
      const overdueText = currentLanguage === 'en' ? 'Overdue!' : currentLanguage === 'fr' ? 'En retard!' : '√úberf√§llig!';
      const completedText = currentLanguage === 'en' ? 'Completed' : currentLanguage === 'fr' ? 'Termin√©' : 'Erledigt';
      const deleteAndTakeText = currentLanguage === 'en' ? 'Delete & take over' : currentLanguage === 'fr' ? 'Supprimer et reprendre' : 'L√∂schen & √ºbernehmen';
      
      // Frist-Anzeige
      let fristHtml = '';
      if (aufgabe.fristDatum) {
        const frist = new Date(aufgabe.fristDatum);
        const heute = new Date();
        heute.setHours(0, 0, 0, 0);
        frist.setHours(0, 0, 0, 0);
        const istUeberfaellig = heute > frist && aufgabe.status === 'offen';
        fristHtml = `<p class="${istUeberfaellig ? 'frist-ueberfaellig' : 'frist-info'}"><strong>${t('task.deadline')}:</strong> ${frist.toLocaleDateString(dateLocale)}${istUeberfaellig ? ' ' + overdueText : ''}</p>`;
      }
      
      return `
        <div class="antrag-card aufgabe-card ${aufgabe.fristDatum && new Date() > new Date(aufgabe.fristDatum) && aufgabe.status === 'offen' ? 'ueberfaellig' : ''}">
          <div class="aufgabe-header">
            <span class="aufgabe-icon"></span>
            <span class="aufgabe-label">${t('task.title')}</span>
            <span class="status-badge ${aufgabe.status === 'offen' ? 'in-bearbeitung' : 'genehmigt'}">
              ${aufgabe.status === 'offen' ? '' + t('status.open') : '' + t('status.completed')}
            </span>
          </div>
          <div class="antrag-body">
            <p><strong>${t('task.forApplication')}:</strong> ${antragsNummer || aufgabe.antragId}</p>
            <p><strong>${t('task.from')}:</strong> ${aufgabe.erstelltVonName}</p>
            <p><strong>${t('task.shortDescription')}:</strong> ${getTranslatedUserText(aufgabe.kurzbeschreibung || aufgabe.beschreibung)}</p>
            ${fristHtml}
            <p class="antrag-date">${formatDate(aufgabe.erstelltAm)}</p>
          </div>
          ${aufgabe.status === 'offen' ? `
            <div class="antrag-actions">
              <button class="btn btn-primary btn-sm" onclick="openAufgabeLoesungModal('${aufgabe.id}')">
                ${t('task.edit')}
              </button>
              <button class="btn btn-secondary btn-sm" onclick="openAntragDetail('${aufgabe.antragId}')">
                ${t('button.openApplication')}
              </button>
              ${istErsteller ? `
                <button class="btn btn-danger btn-sm" onclick="loescheAufgabeUndUebernehme('${aufgabe.id}')">
                  ${deleteAndTakeText}
                </button>
              ` : ''}
            </div>
          ` : `
            <div class="aufgabe-antwort">
              ${aufgabe.erledigungsTyp === 'kenntnisnahme' 
                ? `<p><strong>${t('application.status')}:</strong> ${t('task.acknowledged')}</p>`
                : `<p><strong>${t('task.answer')}:</strong> ${getTranslatedUserText(aufgabe.antwort) || '-'}</p>`
              }
              <p class="antrag-date">${completedText}: ${formatDate(aufgabe.erledigtAm)}</p>
            </div>
          `}
        </div>
      `;
    }
    
    // Aufgabe l√∂schen und Antrag √ºbernehmen (aus Aufgaben-√úbersicht)
    async function loescheAufgabeUndUebernehme(aufgabeId) {
      const msg = currentLanguage === 'en' ? 'Do you really want to delete this task and take over the application?'
                : currentLanguage === 'fr' ? 'Voulez-vous vraiment supprimer cette t√¢che et reprendre la demande?'
                : 'M√∂chten Sie diese Aufgabe wirklich l√∂schen und den Antrag √ºbernehmen?';
      if (!await showConfirm(msg)) return;
      
      zuruecknehmenAufgabeAusfuehren(aufgabeId);
    }
    
    // Aufgabe zur√ºcknehmen mit Best√§tigung (f√ºr direkten Aufruf)
    async function zuruecknehmenAufgabe(aufgabeId) {
      const aufgabe = aufgabenSystem.getAufgabe(aufgabeId);
      if (!aufgabe) return;
      
      // Pr√ºfen ob aktueller Benutzer der Ersteller ist
      if (aufgabe.erstelltVonId !== currentSession.userId) {
        const msg = currentLanguage === 'en' ? 'You can only withdraw tasks that you created yourself.' 
                  : currentLanguage === 'fr' ? 'Vous ne pouvez retirer que les t√¢ches que vous avez cr√©√©es.' 
                  : 'Sie k√∂nnen nur Aufgaben zur√ºcknehmen, die Sie selbst erstellt haben.';
        await showAlert(msg);
        return;
      }
      
      const confirmMsg = currentLanguage === 'en' ? 'Do you really want to withdraw this task? The task will be removed from the processor\'s list and the application will be transferred to you.'
                       : currentLanguage === 'fr' ? 'Voulez-vous vraiment retirer cette t√¢che? La t√¢che sera supprim√©e de la liste du processeur et la demande vous sera transf√©r√©e.'
                       : 'M√∂chten Sie diese Aufgabe wirklich zur√ºcknehmen? Die Aufgabe wird aus der Liste des Bearbeiters entfernt und der Antrag an Sie √ºbergeben.';
      if (!await showConfirm(confirmMsg)) return;
      
      zuruecknehmenAufgabeAusfuehren(aufgabeId);
    }
    
    // Aufgabe zur√ºcknehmen (separater Button) - f√ºhrt die eigentliche Aktion aus
    function zuruecknehmenAufgabeAusfuehren(aufgabeId) {
      const aufgabe = aufgabenSystem.getAufgabe(aufgabeId);
      if (!aufgabe) return;
      
      // Aufgabe l√∂schen
      aufgabenSystem.loescheAufgabe(aufgabeId, currentSession.userId, currentSession.name);
      
      // Antrag √ºbernehmen (wenn nicht bereits bei mir)
      const antrag = antragSystem.getAntrag(aufgabe.antragId);
      if (antrag && antrag.bearbeiterId !== currentSession.userId) {
        antragSystem.uebernehmeAntrag(aufgabe.antragId, currentSession, 'Aufgabe zur√ºckgenommen');
      }
      
      // Benachrichtigung an die Person, die die Aufgabe hatte
      const titleText = currentLanguage === 'en' ? 'Task withdrawn' : currentLanguage === 'fr' ? 'T√¢che retir√©e' : 'Aufgabe zur√ºckgenommen';
      const msgText = currentLanguage === 'en' ? `The task for application ${aufgabe.antragsNummer} was withdrawn by ${currentSession.name}.`
                    : currentLanguage === 'fr' ? `La t√¢che pour la demande ${aufgabe.antragsNummer} a √©t√© retir√©e par ${currentSession.name}.`
                    : `Die Aufgabe zum Antrag ${aufgabe.antragsNummer} wurde von ${currentSession.name} zur√ºckgenommen.`;
      notificationSystem.createNotification(
        aufgabe.zugewiesenAnId,
        'aufgabe-geloescht',
        titleText,
        msgText,
        aufgabe.antragId
      );
      
      // Wenn wir in der Detailansicht sind, diese aktualisieren
      if (currentAntragId === aufgabe.antragId) {
        openAntragDetail(aufgabe.antragId);
      } else {
        renderAntraege();
      }
      renderNotifications();
    }

    // ============================================
    // ANTRAGS-DETAILANSICHT
    // ============================================
    
    function openAntragDetail(antragId, isHistorie = false, isOffen = false) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag) return;
      
      currentAntragId = antragId;
      const istOffen = antrag.status === 'offen';
      const istErledigt = antrag.erledigt || ['genehmigt', 'abgelehnt', 'teilweise-genehmigt'].includes(antrag.status);
      
      // Pr√ºfen ob der aktuelle Benutzer berechtigt ist
      const aufgabenZuAntrag = aufgabenSystem.getAufgabenZuAntrag(antragId);
      const meineOffeneAufgabe = aufgabenZuAntrag.find(a => a.zugewiesenAnId === currentSession.userId && a.status === 'offen');
      const hatOffeneAufgabe = !!meineOffeneAufgabe;
      
      // Der aktuelle Bearbeiter hat IMMER Zugriff (bis zur Veraktung)
      // Dies umfasst sowohl den urspr√ºnglichen Bearbeiter als auch jeden, der den Antrag durch Weiterleitung erhalten hat
      const istBearbeiter = antrag.bearbeiterId === currentSession.userId;
      
      // Pr√ºfen ob der Benutzer den Antrag "abgegeben" hat (durch Aufgabenerledigung mit Antwort/Zur√ºck)
      // WICHTIG: Wenn jemand jetzt der Bearbeiter ist (durch Weiterleitung), ist er NICHT mehr "abgegeben"
      const hatAntragAbgegeben = !istBearbeiter && antragSystem.hatAntragAbgegeben(antragId, currentSession.userId);
      
      let hatAktuellenZugriff = false;
      if (istBearbeiter) {
        // Aktueller Bearbeiter hat immer vollen Zugriff (auch wenn er fr√ºher abgegeben hatte)
        hatAktuellenZugriff = true;
      } else if (hatOffeneAufgabe) {
        // Hat eine offene Aufgabe - kann sie bearbeiten (auch wenn vorher abgegeben)
        hatAktuellenZugriff = true;
      } else if (hatAntragAbgegeben) {
        // Hat den Antrag abgegeben und ist nicht der aktuelle Bearbeiter - kein Zugriff mehr
        hatAktuellenZugriff = false;
      }
      
      // Berechtigungen:
      // - istBearbeiter: Urspr√ºnglicher Bearbeiter (hat immer vollen Zugriff)
      // - hatAktuellenZugriff: Aufgabenempf√§nger mit aktivem Zugriff (bis zur n√§chsten Aufgabenerstellung)
      const istAufgabenBeteiligter = hatAktuellenZugriff;
      const kannVollziehenVerakten = istBearbeiter || hatAktuellenZugriff;
      
      // Prozess-Status berechnen
      const prozessStatus = berechneProzessStatus(antrag);
      
      // Geburtsdatum formatieren
      let geburtsdatumFormatiert = '-';
      if (antrag.insasseGeburtsdatum) {
        const d = new Date(antrag.insasseGeburtsdatum);
        geburtsdatumFormatiert = d.toLocaleDateString('de-DE');
      }
      
      // Antragstyp-spezifische Details (√ºbersetzt in die Sprache des Mitarbeiters)
      let anliegenHtml = '';
      if (antrag.type === 'teilhabegeld') {
        anliegenHtml = `
          <div class="detail-box">
            <h4>üí∞ ${t('application.type.teilhabegeld')}</h4>
            <div class="detail-row">
              <span class="detail-label">${t('month.january').split(' ')[0] ? t('calendar.month') : 'Monat'}:</span>
              <span class="detail-value">${formatMonat(antrag.monat)}</span>
            </div>
          </div>
        `;
      } else if (antrag.type === 'eigentum') {
        const aktionText = antrag.aktion === 'aufstocken' 
          ? (currentLanguage === 'en' ? 'Add clothing' : currentLanguage === 'fr' ? 'Ajouter des v√™tements' : 'Kleidung aufstocken')
          : (currentLanguage === 'en' ? 'Exchange clothing' : currentLanguage === 'fr' ? '√âchanger des v√™tements' : 'Kleidung tauschen');
        anliegenHtml = `
          <div class="detail-box">
            <h4>üëï ${t('application.type.eigentum')}</h4>
            <div class="detail-row">
              <span class="detail-label">${currentLanguage === 'en' ? 'Action' : currentLanguage === 'fr' ? 'Action' : 'Aktion'}:</span>
              <span class="detail-value">${aktionText}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">${currentLanguage === 'en' ? 'Clothing items' : currentLanguage === 'fr' ? 'V√™tements' : 'Kleidungsst√ºcke'}:</span>
              <span class="detail-value">${antrag.kleidung.join(', ')}</span>
            </div>
            ${antrag.antragBegruendung ? `
              <div class="detail-row">
                <span class="detail-label">${t('application.justification')}:</span>
                <span class="detail-value">${getTranslatedUserText(antrag.antragBegruendung)}</span>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Aufgaben zu diesem Antrag laden
      const aufgaben = aufgabenSystem.getAufgabenZuAntrag(antragId);
      let aufgabenHtml = '';
      if (aufgaben.length > 0) {
        aufgabenHtml = `
          <div class="detail-section">
            <h3>${currentLanguage === 'en' ? 'Related Tasks' : currentLanguage === 'fr' ? 'T√¢ches associ√©es' : 'Zugeh√∂rige Aufgaben'}</h3>
            <div class="aufgaben-liste">
              ${aufgaben.map(a => {
                const istErsteller = a.erstelltVonId === currentSession.userId;
                const dateLocale = currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE';
                const overdueText = currentLanguage === 'en' ? 'Overdue!' : currentLanguage === 'fr' ? 'En retard!' : '√úberf√§llig!';
                const withdrawText = currentLanguage === 'en' ? 'Withdraw task' : currentLanguage === 'fr' ? 'Retirer la t√¢che' : 'Aufgabe zur√ºcknehmen';
                let fristHtml = '';
                if (a.fristDatum) {
                  const frist = new Date(a.fristDatum);
                  const heute = new Date();
                  heute.setHours(0, 0, 0, 0);
                  frist.setHours(0, 0, 0, 0);
                  const istUeberfaellig = heute > frist && a.status === 'offen';
                  fristHtml = `<p class="${istUeberfaellig ? 'frist-ueberfaellig' : 'frist-info'}"><strong>${t('task.deadline')}:</strong> ${frist.toLocaleDateString(dateLocale)}${istUeberfaellig ? ' ' + overdueText : ''}</p>`;
                }
                return `
                  <div class="aufgabe-item ${a.status} ${a.fristDatum && new Date() > new Date(a.fristDatum) && a.status === 'offen' ? 'ueberfaellig' : ''}">
                    <div class="aufgabe-item-header">
                      <span class="status-badge ${a.status === 'offen' ? 'in-bearbeitung' : 'genehmigt'}">
                        ${a.status === 'offen' ? '' + t('status.open') : '' + t('status.completed')}
                      </span>
                      <span class="aufgabe-datum">${formatDate(a.erstelltAm)}</span>
                    </div>
                    <p><strong>${currentLanguage === 'en' ? 'To' : currentLanguage === 'fr' ? '√Ä' : 'An'}:</strong> ${a.zugewiesenAnName}</p>
                    <p><strong>${t('task.from')}:</strong> ${a.erstelltVonName}</p>
                    <p><strong>${t('task.shortDescription')}:</strong> ${getTranslatedUserText(a.kurzbeschreibung || a.beschreibung)}</p>
                    ${a.beschreibung && a.kurzbeschreibung ? `<p><strong>${t('task.description')}:</strong> ${getTranslatedUserText(a.beschreibung)}</p>` : ''}
                    ${fristHtml}
                    ${a.antwort ? `<p><strong>${t('task.answer')}:</strong> ${getTranslatedUserText(a.antwort)}</p>` : ''}
                    ${a.erledigungsTyp === 'kenntnisnahme' ? `<p><strong>${t('application.status')}:</strong> ${t('task.acknowledged')}</p>` : ''}
                    ${istErsteller && a.status === 'offen' ? `
                      <div class="aufgabe-item-actions">
                        <button class="btn btn-danger btn-sm" onclick="zuruecknehmenAufgabe('${a.id}')">
${withdrawText}
                        </button>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      // Verlauf/Aktivit√§ten zu diesem Antrag laden
      const aktivitaeten = aktivitaetenSystem.getAktivitaetenZuAntrag(antragId);
      let verlaufHtml = '';
      if (aktivitaeten.length > 0) {
        verlaufHtml = `
          <div class="detail-section">
            <h3>${t('history.title')}</h3>
            <div class="verlauf-liste">
              ${aktivitaeten.map(a => `
                <div class="verlauf-item">
                  <div class="verlauf-item-marker">
                    <span class="verlauf-icon">${getVerlaufIcon(a.typ)}</span>
                    <span class="verlauf-line"></span>
                  </div>
                  <div class="verlauf-item-content">
                    <div class="verlauf-item-header">
                      <span class="verlauf-beschreibung">${getAktivitaetBeschreibung(a)}</span>
                      <span class="verlauf-datum">${formatDate(a.erstelltAm)}</span>
                    </div>
                    <div class="verlauf-item-meta">
                      <span class="verlauf-benutzer">
                        ${a.benutzerName}
                      </span>
                    </div>
                    ${a.details && a.details.begruendung ? `
                      <div class="verlauf-details">
                        <em>${t('decision.reason')}: ${getTranslatedUserText(a.details.begruendung)}</em>
                      </div>
                    ` : ''}
                    ${a.details && a.details.antwort ? `
                      <div class="verlauf-details">
                        <em>${t('task.answer')}: ${getTranslatedUserText(a.details.antwort)}</em>
                      </div>
                    ` : ''}
                    ${a.details && a.details.erledigungsTyp === 'kenntnisnahme' && a.typ !== 'aufgabe-erledigt' ? `
                      <div class="verlauf-details">
                        <em>${t('task.acknowledged')}</em>
                      </div>
                    ` : ''}
                    ${a.details && a.details.kurzbeschreibung && a.typ === 'aufgabe-erstellt' ? `
                      <div class="verlauf-details">
                        <em>${t('task.shortDescription')}: ${getTranslatedUserText(a.details.kurzbeschreibung)}</em>
                      </div>
                    ` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      // Prozess-Grafik HTML generieren (√ºbersetzt)
      const prozessGrafikHtml = `
        <div class="prozess-grafik">
          <div class="prozess-schritt ${prozessStatus.eingang}">
            <div class="prozess-icon"></div>
            <div class="prozess-label">${t('process.receipt')}</div>
          </div>
          <div class="prozess-pfeil ${prozessStatus.eingang === 'erledigt' ? 'aktiv' : ''}">‚Üí</div>
          <div class="prozess-schritt ${prozessStatus.pruefung}">
            <div class="prozess-icon"></div>
            <div class="prozess-label">${t('process.review')}</div>
          </div>
          <div class="prozess-pfeil ${prozessStatus.pruefung === 'erledigt' ? 'aktiv' : ''}">‚Üí</div>
          <div class="prozess-schritt ${prozessStatus.entscheiden}">
            <div class="prozess-icon"></div>
            <div class="prozess-label">${t('process.decision')}</div>
          </div>
          <div class="prozess-pfeil ${prozessStatus.entscheiden === 'erledigt' ? 'aktiv' : ''}">‚Üí</div>
          <div class="prozess-schritt ${prozessStatus.bekanntgabe}">
            <div class="prozess-icon">üì¢</div>
            <div class="prozess-label">${t('process.notification')}</div>
          </div>
          <div class="prozess-pfeil ${prozessStatus.bekanntgabe === 'erledigt' ? 'aktiv' : ''}">‚Üí</div>
          <div class="prozess-schritt ${prozessStatus.vollzug}">
            <div class="prozess-icon"></div>
            <div class="prozess-label">${t('process.execution')}</div>
          </div>
          <div class="prozess-pfeil ${prozessStatus.vollzug === 'erledigt' ? 'aktiv' : ''}">‚Üí</div>
          <div class="prozess-schritt ${prozessStatus.abschluss}">
            <div class="prozess-icon"></div>
            <div class="prozess-label">${t('process.completion')}</div>
          </div>
        </div>
      `;
      
      const html = `
        <div class="detail-header">
          <h2>Antrag ${antrag.antragsNummer || antrag.id}</h2>
          <span class="status-badge ${antrag.status}">
            ${getStatusIcon(antrag.status)} ${getStatusText(antrag.status)}
          </span>
        </div>
        
        ${prozessGrafikHtml}
        
        <div class="detail-two-column">
          <!-- Linke Spalte: Daten und Aktionen -->
          <div class="detail-main">
            <div class="detail-section">
              <h3>${currentLanguage === 'en' ? 'Basic Data' : currentLanguage === 'fr' ? 'Donn√©es de base' : 'Grunddaten'}</h3>
              <div class="detail-grid">
                <div class="detail-box">
                  <h4>${currentLanguage === 'en' ? 'Application Data' : currentLanguage === 'fr' ? 'Donn√©es de la demande' : 'Antragsdaten'}</h4>
                  <div class="detail-row">
                    <span class="detail-label">${t('application.id')}:</span>
                    <span class="detail-value">${antrag.antragsNummer || antrag.id}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">${currentLanguage === 'en' ? 'Submitted on' : currentLanguage === 'fr' ? 'Soumis le' : 'Eingereicht am'}:</span>
                    <span class="detail-value">${formatDate(antrag.erstelltAm)}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">${t('application.status')}:</span>
                    <span class="detail-value">${getStatusText(antrag.status)}</span>
                  </div>
                </div>
                
                <div class="detail-box">
                  <h4>${currentLanguage === 'en' ? 'Inmate Master Data' : currentLanguage === 'fr' ? 'Donn√©es du d√©tenu' : 'Stammdaten des Gefangenen'}</h4>
                  <div class="detail-row">
                    <span class="detail-label">${t('masterdata.name')}:</span>
                    <span class="detail-value">${antrag.insasseName}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">${t('masterdata.birthdate')}:</span>
                    <span class="detail-value">${geburtsdatumFormatiert}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">${t('masterdata.inmateId')}:</span>
                    <span class="detail-value">${antrag.insassenNummer || '-'}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">${t('masterdata.house')}:</span>
                    <span class="detail-value">${getHausName(antrag.insasseJva)}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">${t('masterdata.station')}:</span>
                    <span class="detail-value">${antrag.insasseStation}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h3>${t('application.concern')}</h3>
              ${anliegenHtml}
            </div>
            
            ${aufgabenHtml}
            
            ${antrag.bescheidPdf ? `
              <div class="detail-section">
                <h3>${t('notice.title')}</h3>
                <div class="bescheid-download">
                  <p>${currentLanguage === 'en' ? 'A notice has been created for this application.' : currentLanguage === 'fr' ? 'Un avis a √©t√© cr√©√© pour cette demande.' : 'Ein Bescheid wurde f√ºr diesen Antrag erstellt.'}</p>
                  <button class="btn btn-secondary" onclick="downloadBescheidPdf('${antrag.id}')">
${currentLanguage === 'en' ? 'Download notice' : currentLanguage === 'fr' ? 'T√©l√©charger l\'avis' : 'Bescheid herunterladen'}
                  </button>
                </div>
              </div>
            ` : ''}
            
            <div class="detail-section">
              <h3>‚öôÔ∏è ${t('button.actions')}</h3>
              ${istOffen ? `
                <div class="offen-hinweis">
                  <span class="hinweis-icon"></span>
                  <span>${t('hint.applicationNotTaken')}</span>
                </div>
              ` : ''}
              ${!istOffen && !istErledigt && !antrag.sachlichGeprueft ? `
                <div class="pruefung-hinweis">
                  <span class="hinweis-icon">‚ÑπÔ∏è</span>
                  <span>${t('hint.reviewRequired')}</span>
                </div>
              ` : ''}
              ${!istOffen && !istErledigt && antrag.sachlichGeprueft ? `
                <div class="pruefung-erfolgt">
                  <span class="erfolgt-icon"></span>
                  <span>${t('process.reviewDone')} ${new Date(antrag.sachlichGeprueftAm).toLocaleDateString(currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE')} ${t('process.by')} ${antrag.sachlichGeprueftVon}</span>
                </div>
              ` : ''}
              ${istErledigt && !antrag.veraktet ? `
                <div class="entscheidung-erfolgt">
                  <span class="erfolgt-icon"></span>
                  <span>${t('hint.decisionMade')}: ${getStatusText(antrag.status)} ${t('hint.on')} ${new Date(antrag.bearbeitetAm).toLocaleDateString(currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE')}</span>
                </div>
              ` : ''}
              
              ${antrag.wartetAufEroeffnung ? `
                <div class="warten-hinweis persoenlich-warten">
                  <span class="hinweis-icon"></span>
                  <span>${currentLanguage === 'en' ? 'Waiting for personal opening' : currentLanguage === 'fr' ? 'En attente d\'ouverture personnelle' : 'Wartet auf pers√∂nliche Er√∂ffnung'} - ${currentLanguage === 'en' ? 'Planned decision' : currentLanguage === 'fr' ? 'D√©cision pr√©vue' : 'Geplante Entscheidung'}: ${getStatusText(antrag.geplantesErgebnis)}</span>
                </div>
                <div class="bestaetigung-checkbox">
                  <button class="btn btn-success btn-large" onclick="bestaetigeEroeffnung('${antrag.id}')">
${currentLanguage === 'en' ? 'Confirm personal opening' : currentLanguage === 'fr' ? 'Confirmer l\'ouverture personnelle' : 'Pers√∂nliche Er√∂ffnung best√§tigen'}
                  </button>
                </div>
              ` : ''}
              
              ${antrag.wartetAufVollzug ? `
                <div class="warten-hinweis vollzug-warten">
                  <span class="hinweis-icon">üì¶</span>
                  <span>${currentLanguage === 'en' ? 'Execution before notification planned' : currentLanguage === 'fr' ? 'Ex√©cution avant notification pr√©vue' : 'Vollzug vor Bekanntgabe geplant'} - ${currentLanguage === 'en' ? 'Planned decision' : currentLanguage === 'fr' ? 'D√©cision pr√©vue' : 'Geplante Entscheidung'}: ${getStatusText(antrag.geplantesErgebnis)}</span>
                </div>
                <div class="bestaetigung-checkbox">
                  <button class="btn btn-success btn-large" onclick="openVollzugBestaetigenModal('${antrag.id}')">
${currentLanguage === 'en' ? 'Confirm execution & notify' : currentLanguage === 'fr' ? 'Confirmer l\'ex√©cution et notifier' : 'Vollzug best√§tigen & Bekanntgabe'}
                  </button>
                </div>
              ` : ''}
              
              ${antrag.entscheidungGetroffen && currentSession.rolle === 'hausleitung' && !antrag.veraktet ? `
                <div class="revision-bereich">
                  <button class="btn btn-danger btn-sm" onclick="revidiereEntscheidung('${antrag.id}')">
                    ${currentLanguage === 'en' ? 'Revise decision (House management)' : currentLanguage === 'fr' ? 'R√©viser la d√©cision (Direction)' : 'Entscheidung revidieren (Hausleitung)'}
                  </button>
                </div>
              ` : ''}
              
              ${istErledigt && !antrag.veraktet && kannVollziehenVerakten && (antrag.status === 'genehmigt' || antrag.status === 'teilweise-genehmigt') ? `
                <div class="vollzug-checkbox">
                  <label class="checkbox-option vollzug-option">
                    <input type="checkbox" id="vollzogenCheckbox" ${antrag.vollzogen ? 'checked disabled' : ''} onchange="toggleVollzogen('${antrag.id}', this.checked)">
                    <span class="checkbox-label">${t('action.executed')}</span>
                  </label>
                  ${antrag.vollzogen ? `
                    <span class="vollzug-info">${t('hint.on')} ${new Date(antrag.vollzogenAm).toLocaleDateString(currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE')} ${t('process.by')} ${antrag.vollzogenVon}</span>
                  ` : ''}
                </div>
              ` : ''}
              
              ${hatOffeneAufgabe ? `
                <div class="aufgabe-hinweis">
                  <span class="hinweis-icon"></span>
                  <span>${t('hint.openTask')}</span>
                </div>
              ` : ''}
              
              <div class="action-buttons">
                ${istOffen ? `
                  <button class="btn btn-primary btn-large" onclick="nehmeAntragUndBleibeInDetail('${antrag.id}')">
${t('button.takeApplication')}
                  </button>
                ` : ''}
                ${hatOffeneAufgabe ? `
                  <button class="btn btn-primary btn-large" onclick="openAufgabeLoesungModal('${meineOffeneAufgabe.id}')">
                    ${t('task.edit')}
                  </button>
                ` : ''}
                ${!istOffen && !istErledigt && (istBearbeiter || istAufgabenBeteiligter) && !antrag.entscheidungGetroffen ? `
                  ${!antrag.sachlichGeprueft ? `
                    <button class="btn btn-warning btn-large" onclick="markiereAlsGeprueft('${antrag.id}')">
                      ${t('action.technicalReview')}
                    </button>
                  ` : ''}
                  <button class="btn btn-primary btn-large ${!antrag.sachlichGeprueft ? 'disabled' : ''}" 
                          onclick="${antrag.sachlichGeprueft ? `openEntscheidenModal('${antrag.id}')` : `showReviewRequiredAlert()`}"
                          ${!antrag.sachlichGeprueft ? `title="${t('error.reviewRequired')}"` : ''}>
                    ${t('decision.title')}
                  </button>
                  <button class="btn btn-secondary btn-large" onclick="openAufgabeModal('${antrag.id}')">
${t('task.create')}
                  </button>
                ` : ''}
                ${antrag.entscheidungGetroffen && !antrag.erledigt && (istBearbeiter || istAufgabenBeteiligter) ? `
                  <button class="btn btn-secondary btn-large" onclick="openAufgabeModal('${antrag.id}')">
${t('task.create')}
                  </button>
                ` : ''}
                ${istErledigt && !antrag.veraktet && kannVollziehenVerakten ? `
                  <button class="btn btn-secondary btn-large" onclick="openAufgabeModal('${antrag.id}')">
${t('task.create')}
                  </button>
                ` : ''}
                ${!antrag.veraktet && kannVollziehenVerakten && prozessStatus.abschluss === 'aktiv' ? `
                  <button class="btn btn-secondary btn-large" onclick="veraktenAntrag('${antrag.id}')">
${t('action.archive')}
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
          
          <!-- Rechte Spalte: Verlauf und Kommentare -->
          <div class="detail-sidebar">
            <!-- Kommentar-Bereich -->
            <div class="detail-section kommentar-section">
              <h3>${currentLanguage === 'en' ? 'Notes' : currentLanguage === 'fr' ? 'Notes' : 'Notizen'}</h3>
              ${!antrag.veraktet && hatAktuellenZugriff ? `
                <div class="kommentar-eingabe">
                  <textarea id="neuerKommentar" placeholder="${currentLanguage === 'en' ? 'Add a note...' : currentLanguage === 'fr' ? 'Ajouter une note...' : 'Notiz hinzufuegen...'}" rows="3"></textarea>
                  <button class="btn btn-primary btn-sm" onclick="addKommentar('${antrag.id}')">
                    ${currentLanguage === 'en' ? 'Add' : currentLanguage === 'fr' ? 'Ajouter' : 'Hinzufuegen'}
                  </button>
                </div>
              ` : ''}
              <div class="kommentar-liste">
                ${renderKommentare(antrag.kommentare || [])}
              </div>
            </div>
            
            ${verlaufHtml || `<div class="detail-section"><h3>${t('history.title')}</h3><p class="empty-hint">${currentLanguage === 'en' ? 'No activities yet.' : currentLanguage === 'fr' ? 'Pas encore d\'activit√©s.' : 'Noch keine Aktivit√§ten.'}</p></div>`}
          </div>
        </div>
      `;
      
      document.getElementById('antragDetailContent').innerHTML = html;
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('antragDetailView').style.display = 'block';
    }
    
    function closeAntragDetail() {
      document.getElementById('antragDetailView').style.display = 'none';
      document.getElementById('dashboardView').style.display = 'block';
      currentAntragId = null;
      renderAntraege();
    }

    // ============================================
    // HILFSFUNKTIONEN F√úR ALERTS
    // ============================================
    
    function showReviewRequiredAlert() {
      const msg = currentLanguage === 'en' ? 'Please complete the technical review first.' 
                : currentLanguage === 'fr' ? 'Veuillez d\'abord effectuer l\'examen technique.' 
                : 'Bitte pr√ºfen Sie den Antrag zun√§chst sachlich/fachlich.';
      showAlert(msg);
    }
    
    function showExecutionRequiredAlert() {
      const msg = currentLanguage === 'en' ? 'Please mark the application as executed first.' 
                : currentLanguage === 'fr' ? 'Veuillez d\'abord marquer la demande comme ex√©cut√©e.' 
                : 'Bitte markieren Sie zun√§chst den Antrag als vollzogen.';
      showAlert(msg);
    }

    // ============================================
    // SACHLICHE/FACHLICHE PR√úFUNG
    // ============================================
    
    function markiereAlsGeprueft(antragId) {
      // Modal f√ºr Pr√ºfungskommentar √∂ffnen
      document.getElementById('pruefungAntragId').value = antragId;
      document.getElementById('pruefungKommentar').value = '';
      openModal('pruefungModal');
    }
    
    function confirmPruefung() {
      const antragId = document.getElementById('pruefungAntragId').value;
      const kommentar = document.getElementById('pruefungKommentar').value.trim();
      
      if (!kommentar) {
        const msg = currentLanguage === 'en' ? 'Please enter a review comment.'
                  : currentLanguage === 'fr' ? 'Veuillez entrer un commentaire d\'examen.'
                  : 'Bitte geben Sie einen Pr√ºfungskommentar ein.';
        showAlert(msg);
        return;
      }
      
      // Antrag als gepr√ºft markieren mit Kommentar
      antragSystem.markiereAlsGeprueft(antragId, currentSession.userId, currentSession.name, kommentar);
      
      closeModal('pruefungModal');
      
      // Nach Pr√ºfung: Weiterleitung anbieten
      openWeiterleitenModal(antragId, 'geprueft');
    }

    // ============================================
    // ENTSCHEIDEN
    // ============================================
    
    function openEntscheidenModal(antragId) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag.sachlichGeprueft) {
        showReviewRequiredAlert();
        return;
      }
      document.getElementById('entscheidenAntragId').value = antragId;
      document.getElementById('entscheidungBegruendung').value = '';
      document.getElementById('entscheidungPersoenlichEroeffnen').checked = false;
      document.getElementById('entscheidungVollzugVorBekanntgabe').checked = false;
      openModal('entscheidenModal');
    }
    
    function handleEntscheidung(status) {
      const antragId = document.getElementById('entscheidenAntragId').value;
      const begruendungText = document.getElementById('entscheidungBegruendung').value.trim();
      const persoenlichEroeffnen = document.getElementById('entscheidungPersoenlichEroeffnen').checked;
      const vollzugVorBekanntgabe = document.getElementById('entscheidungVollzugVorBekanntgabe').checked;
      
      // Begr√ºndung ist f√ºr alle Entscheidungen Pflicht
      if (!begruendungText) {
        showAlert(t('decision.reasonRequired'));
        return;
      }
      
      // Begr√ºndung mit Sprachinfo f√ºr √úbersetzung speichern
      const begruendung = createTranslatableText(begruendungText);
      
      // Bescheid-PDF erstellen (mit Original-Text f√ºr PDF)
      const bescheidPdf = generateBescheidPdf(antragId, status, begruendungText);
      
      // Antrag abschlie√üen - die beiden Optionen werden jetzt separat behandelt
      antragSystem.abschliessenAntrag(antragId, status, begruendung, persoenlichEroeffnen, bescheidPdf, vollzugVorBekanntgabe);
      closeModal('entscheidenModal');
      
      // Nach Entscheidung: Weiterleitung anbieten
      // Nur wenn KEINE pers√∂nliche Er√∂ffnung oder Vollzug vor Bekanntgabe
      if (!persoenlichEroeffnen && !vollzugVorBekanntgabe) {
        openWeiterleitenModal(antragId, 'entschieden');
      } else {
        // Bei Pers. Er√∂ffnung oder Vollzug vor Bekanntgabe: Detailansicht √∂ffnen
        openAntragDetail(antragId);
      }
    }
    
    // Modal f√ºr Vollzugs-Best√§tigung √∂ffnen
    function openVollzugBestaetigenModal(antragId) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag || !antrag.wartetAufVollzug) return;
      
      const statusText = antrag.geplantesErgebnis === 'genehmigt' 
        ? (currentLanguage === 'en' ? 'Approved' : currentLanguage === 'fr' ? 'Approuv√©' : 'Genehmigt')
        : antrag.geplantesErgebnis === 'abgelehnt'
        ? (currentLanguage === 'en' ? 'Rejected' : currentLanguage === 'fr' ? 'Rejet√©' : 'Abgelehnt')
        : (currentLanguage === 'en' ? 'Partially approved' : currentLanguage === 'fr' ? 'Partiellement approuv√©' : 'Teilweise genehmigt');
      
      document.getElementById('vollzugGeplantEntscheidung').textContent = statusText;
      document.getElementById('vollzugKommentar').value = '';
      document.getElementById('vollzugBestaetigenAntragId').value = antragId;
      openModal('vollzugBestaetigenModal');
    }
    
    // Vollzug best√§tigen
    function confirmVollzugBestaetigung() {
      const antragId = document.getElementById('vollzugBestaetigenAntragId').value;
      const kommentar = document.getElementById('vollzugKommentar').value.trim();
      
      if (!kommentar) {
        const msg = currentLanguage === 'en' ? 'Please enter a comment for the execution.' 
                  : currentLanguage === 'fr' ? 'Veuillez entrer un commentaire pour l\'ex√©cution.' 
                  : 'Bitte geben Sie einen Kommentar zum Vollzug ein.';
        showAlert(msg);
        return;
      }
      
      // Kommentar mit Sprachinfo speichern
      const vollzugKommentar = createTranslatableText(kommentar);
      
      antragSystem.bestaetigeVollzugVorBekanntgabe(antragId, vollzugKommentar, currentSession.userId, currentSession.name);
      closeModal('vollzugBestaetigenModal');
      
      // Nach Bekanntgabe: Weiterleitung anbieten
      openWeiterleitenModal(antragId, 'bekanntgegeben');
    }
    
    // Entscheidung revidieren (nur f√ºr Hausleitung)
    async function revidiereEntscheidung(antragId) {
      const confirmMsg = currentLanguage === 'en' 
        ? 'Are you sure you want to revise this decision? This action can only be performed by house management.'
        : currentLanguage === 'fr'
        ? '√ätes-vous s√ªr de vouloir r√©viser cette d√©cision ? Cette action ne peut √™tre effectu√©e que par la direction de la maison.'
        : 'Sind Sie sicher, dass Sie diese Entscheidung revidieren m√∂chten? Diese Aktion kann nur von der Hausleitung durchgef√ºhrt werden.';
      
      if (!await showConfirm(confirmMsg)) return;
      
      const result = antragSystem.revidiereEntscheidung(antragId, currentSession.userId, currentSession.name);
      if (result) {
        openAntragDetail(antragId);
      }
    }
    
    // Bescheid-PDF generieren (in der Sprache des aktuellen Benutzers)
    function generateBescheidPdf(antragId, status, begruendung) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag) return null;
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Datumsformat je nach Sprache
      const dateLocale = currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE';
      
      // Header (√ºbersetzt)
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text(t('notice.title'), 105, 20, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`${t('notice.reference')}: ${antrag.antragsNummer || antrag.id}`, 20, 35);
      doc.text(`${t('notice.date')}: ${new Date().toLocaleDateString(dateLocale)}`, 20, 42);
      
      // Anrede (√ºbersetzt)
      doc.setFontSize(11);
      doc.text(`${t('notice.greeting')} ${antrag.insasseName},`, 20, 60);
      
      // Beschreibung des Anliegens (√ºbersetzt)
      let anliegenText = '';
      if (antrag.type === 'teilhabegeld') {
        anliegenText = `${t('notice.applicationFor')} ${t('application.type.teilhabegeld')} ${t('notice.for')} ${formatMonat(antrag.monat)}`;
      } else if (antrag.type === 'eigentum') {
        const aktionText = antrag.aktion === 'aufstocken' 
          ? (currentLanguage === 'en' ? 'Addition' : currentLanguage === 'fr' ? 'Ajout' : 'Aufstockung')
          : (currentLanguage === 'en' ? 'Exchange' : currentLanguage === 'fr' ? '√âchange' : 'Tausch');
        const eigentumsText = currentLanguage === 'en' ? 'of property in storage' : currentLanguage === 'fr' ? 'd\'articles personnels' : 'von Eigentum in der Kammer';
        anliegenText = `${aktionText} ${eigentumsText} (${antrag.kleidung.join(', ')})`;
      }
      
      // Entscheidungstext (√ºbersetzt)
      let entscheidungText = '';
      if (status === 'genehmigt') {
        entscheidungText = t('notice.approved');
      } else if (status === 'teilweise-genehmigt') {
        entscheidungText = t('notice.partiallyApproved');
      } else if (status === 'abgelehnt') {
        entscheidungText = t('notice.rejected');
      }
      
      // Antragsdatum formatieren
      const antragsDatum = new Date(antrag.erstelltAm).toLocaleDateString(dateLocale);
      
      // Haupttext (√ºbersetzt)
      const hauptText = `${t('notice.yourApplication')} ${antrag.antragsNummer || antrag.id} (${t('notice.applicationDate')}: ${antragsDatum}) - ${anliegenText} - ${entscheidungText}.`;
      const hauptTextLines = doc.splitTextToSize(hauptText, 170);
      doc.text(hauptTextLines, 20, 75);
      
      let yPos = 75 + (hauptTextLines.length * 6) + 10;
      
      // Begr√ºndung (√ºbersetzt)
      if (begruendung) {
        doc.text(t('notice.reasonIntro'), 20, yPos);
        yPos += 8;
        // Begr√ºndung in die Sprache des Benutzers √ºbersetzen wenn es ein Objekt ist
        const translatedBegruendung = typeof begruendung === 'object' ? getTranslatedUserText(begruendung) : begruendung;
        const begruendungLines = doc.splitTextToSize(translatedBegruendung, 170);
        doc.text(begruendungLines, 20, yPos);
        yPos += begruendungLines.length * 6 + 10;
      }
      
      // Rechtsmittelbelehrung (√ºbersetzt)
      yPos += 10;
      doc.setFont('helvetica', 'bold');
      const rechtsmittelTitel = currentLanguage === 'en' ? 'Legal Remedies:' : currentLanguage === 'fr' ? 'Voies de recours:' : 'Rechtsmittelbelehrung:';
      doc.text(rechtsmittelTitel, 20, yPos);
      doc.setFont('helvetica', 'normal');
      yPos += 8;
      const rechtsmittelText = t('notice.appeal');
      const rechtsmittelLines = doc.splitTextToSize(rechtsmittelText, 170);
      doc.text(rechtsmittelLines, 20, yPos);
      
      // Footer
      yPos = 250;
      doc.text(`${getJvaName(antrag.insasseJva)}`, 20, yPos);
      const bearbeiterText = currentLanguage === 'en' ? 'Processed by' : currentLanguage === 'fr' ? 'Trait√© par' : 'Bearbeiter';
      doc.text(`${bearbeiterText}: ${currentSession.name}`, 20, yPos + 7);
      
      // Als Base64 zur√ºckgeben
      return doc.output('datauristring');
    }
    
    // Bescheid-PDF herunterladen
    function downloadBescheidPdf(antragId) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag || !antrag.bescheidPdf) {
        const msg = currentLanguage === 'en' ? 'No notice available.' 
                  : currentLanguage === 'fr' ? 'Aucun avis disponible.' 
                  : 'Kein Bescheid vorhanden.';
        showAlert(msg);
        return;
      }
      
      // Base64-URL in Link umwandeln und downloaden
      const link = document.createElement('a');
      link.href = antrag.bescheidPdf;
      link.download = `Bescheid_${antrag.antragsNummer || antrag.id}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ============================================
    // AUFGABE ERSTELLEN
    // ============================================
    
    function openAufgabeModal(antragId) {
      document.getElementById('aufgabeAntragId').value = antragId;
      document.getElementById('aufgabeKurzbeschreibung').value = '';
      document.getElementById('aufgabeBeschreibung').value = '';
      document.getElementById('aufgabeFrist').value = '';
      document.getElementById('aufgabeKurzCounter').textContent = '0';
      
      // PDF-Upload zur√ºcksetzen
      clearAufgabePdfs();
      
      // Radio-Buttons zur√ºcksetzen
      document.querySelectorAll('input[name="aufgabeZiel"]').forEach(r => r.checked = false);
      document.getElementById('mitarbeiterAuswahl').style.display = 'none';
      
      // Mitarbeiter-Auswahl zur√ºcksetzen
      document.getElementById('aufgabeMitarbeiterSuche').value = '';
      document.getElementById('aufgabePersonId').value = '';
      document.getElementById('selectedPersonDisplay').style.display = 'none';
      
      // Zeichenz√§hler f√ºr Kurzbeschreibung
      document.getElementById('aufgabeKurzbeschreibung').oninput = function() {
        document.getElementById('aufgabeKurzCounter').textContent = this.value.length;
      };
      
      openModal('aufgabeModal');
    }
    
    function toggleAufgabeZiel(ziel) {
      if (ziel === 'mitarbeiter') {
        document.getElementById('mitarbeiterAuswahl').style.display = 'block';
        loadAlleMitarbeiter();
      } else {
        document.getElementById('mitarbeiterAuswahl').style.display = 'none';
      }
    }
    
    // Alle Mitarbeiter laden und anzeigen
    function loadAlleMitarbeiter() {
      const liste = document.getElementById('aufgabeMitarbeiterListe');
      const alleMitarbeiter = userSystem.users.filter(u => u.type === 'mitarbeiter');
      
      // Sortieren nach Name
      alleMitarbeiter.sort((a, b) => {
        const nameA = `${a.nachname} ${a.vorname}`.toLowerCase();
        const nameB = `${b.nachname} ${b.vorname}`.toLowerCase();
        return nameA.localeCompare(nameB, 'de');
      });
      
      renderMitarbeiterListe(alleMitarbeiter);
    }
    
    // Mitarbeiterliste rendern
    function renderMitarbeiterListe(mitarbeiter) {
      const liste = document.getElementById('aufgabeMitarbeiterListe');
      const selectedId = document.getElementById('aufgabePersonId').value;
      
      if (mitarbeiter.length === 0) {
        liste.innerHTML = '<div class="keine-ergebnisse">Keine Mitarbeiter gefunden</div>';
        return;
      }
      
      liste.innerHTML = mitarbeiter.map(m => {
        const rolleText = getRolleText(m.rolle);
        const hausText = m.jvas && m.jvas.length > 0 ? HAUS_CONFIG[m.jvas[0]]?.name || m.jvas[0] : '';
        const stationText = m.station ? `Station ${m.station}` : '';
        const zusatzInfo = [hausText, stationText].filter(Boolean).join(', ');
        const isSelected = m.id === selectedId;
        
        return `
          <div class="mitarbeiter-item ${isSelected ? 'selected' : ''}" onclick="selectMitarbeiter('${m.id}', '${m.vorname} ${m.nachname}')">
            <div class="mitarbeiter-item-name">${m.vorname} ${m.nachname}</div>
            <div class="mitarbeiter-item-info">${rolleText}${zusatzInfo ? ' ‚Ä¢ ' + zusatzInfo : ''}</div>
          </div>
        `;
      }).join('');
    }
    
    // Mitarbeiterliste filtern
    function filterMitarbeiterListe() {
      const suchbegriff = document.getElementById('aufgabeMitarbeiterSuche').value.toLowerCase().trim();
      const alleMitarbeiter = userSystem.users.filter(u => u.type === 'mitarbeiter');
      
      let gefiltert = alleMitarbeiter;
      
      if (suchbegriff) {
        gefiltert = alleMitarbeiter.filter(m => {
          const vollName = `${m.vorname} ${m.nachname}`.toLowerCase();
          const rolleText = getRolleText(m.rolle).toLowerCase();
          return vollName.includes(suchbegriff) || rolleText.includes(suchbegriff);
        });
      }
      
      // Sortieren nach Name
      gefiltert.sort((a, b) => {
        const nameA = `${a.nachname} ${a.vorname}`.toLowerCase();
        const nameB = `${b.nachname} ${b.vorname}`.toLowerCase();
        return nameA.localeCompare(nameB, 'de');
      });
      
      renderMitarbeiterListe(gefiltert);
    }
    
    // Mitarbeiter ausw√§hlen
    function selectMitarbeiter(id, name) {
      document.getElementById('aufgabePersonId').value = id;
      document.getElementById('selectedPersonName').textContent = name;
      document.getElementById('selectedPersonDisplay').style.display = 'flex';
      
      // Liste neu rendern um Auswahl anzuzeigen
      filterMitarbeiterListe();
    }
    
    // Auswahl aufheben
    function clearSelectedPerson() {
      document.getElementById('aufgabePersonId').value = '';
      document.getElementById('selectedPersonDisplay').style.display = 'none';
      filterMitarbeiterListe();
    }
    
    // PDF-Upload-Funktionen f√ºr Aufgaben (multiple PDFs)
    let aufgabePdfs = [];
    let antwortPdfs = [];
    
    function handleAufgabePdfUpload(input) {
      const files = input.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file && file.type === 'application/pdf') {
          const reader = new FileReader();
          reader.onload = function(e) {
            aufgabePdfs.push({
              name: file.name,
              data: e.target.result
            });
            renderAufgabePdfList();
          };
          reader.readAsDataURL(file);
        }
      }
      input.value = ''; // Reset f√ºr weitere Uploads
    }
    
    function renderAufgabePdfList() {
      const container = document.getElementById('aufgabePdfList');
      if (aufgabePdfs.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = aufgabePdfs.map((pdf, index) => `
        <div class="pdf-preview">
          <span class="pdf-icon"></span>
          <span class="pdf-name">${pdf.name}</span>
          <button type="button" class="btn-clear" onclick="removeAufgabePdf(${index})">&times;</button>
        </div>
      `).join('');
    }
    
    function removeAufgabePdf(index) {
      aufgabePdfs.splice(index, 1);
      renderAufgabePdfList();
    }
    
    function clearAufgabePdfs() {
      aufgabePdfs = [];
      document.getElementById('aufgabePdfUpload').value = '';
      renderAufgabePdfList();
    }
    
    function handleAntwortPdfUpload(input) {
      const files = input.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file && file.type === 'application/pdf') {
          const reader = new FileReader();
          reader.onload = function(e) {
            antwortPdfs.push({
              name: file.name,
              data: e.target.result
            });
            renderAntwortPdfList();
          };
          reader.readAsDataURL(file);
        }
      }
      input.value = ''; // Reset f√ºr weitere Uploads
    }
    
    function renderAntwortPdfList() {
      const container = document.getElementById('aufgabeAntwortPdfList');
      if (antwortPdfs.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = antwortPdfs.map((pdf, index) => `
        <div class="pdf-preview">
          <span class="pdf-icon"></span>
          <span class="pdf-name">${pdf.name}</span>
          <button type="button" class="btn-clear" onclick="removeAntwortPdf(${index})">&times;</button>
        </div>
      `).join('');
    }
    
    function removeAntwortPdf(index) {
      antwortPdfs.splice(index, 1);
      renderAntwortPdfList();
    }
    
    function clearAntwortPdfs() {
      antwortPdfs = [];
      document.getElementById('aufgabeAntwortPdfUpload').value = '';
      renderAntwortPdfList();
    }
    
    function sendeAufgabe() {
      const antragId = document.getElementById('aufgabeAntragId').value;
      const antrag = antragSystem.getAntrag(antragId);
      const kurzbeschreibungText = document.getElementById('aufgabeKurzbeschreibung').value.trim();
      const beschreibungText = document.getElementById('aufgabeBeschreibung').value.trim();
      const fristDatum = document.getElementById('aufgabeFrist').value;
      
      // Texte mit Sprachinfo f√ºr √úbersetzung speichern
      const kurzbeschreibung = createTranslatableText(kurzbeschreibungText);
      const beschreibung = beschreibungText ? createTranslatableText(beschreibungText) : '';
      
      const zielRadio = document.querySelector('input[name="aufgabeZiel"]:checked');
      if (!zielRadio) {
        showAlert(t('error.selectOption'));
        return;
      }
      
      if (!kurzbeschreibungText) {
        showAlert(t('error.required'));
        return;
      }
      
      let zugewiesenAnId, zugewiesenAnName, zugewiesenAnTyp;
      
      if (zielRadio.value === 'insasse') {
        // Aufgabe an den Antragsteller
        zugewiesenAnId = antrag.insasseId;
        zugewiesenAnName = antrag.insasseName;
        zugewiesenAnTyp = 'insasse';
      } else {
        // Aufgabe an Mitarbeiter
        const personId = document.getElementById('aufgabePersonId').value;
        if (!personId) {
          const msg = currentLanguage === 'en' ? 'Please select a staff member.' 
                    : currentLanguage === 'fr' ? 'Veuillez s√©lectionner un employ√©.' 
                    : 'Bitte w√§hlen Sie einen Mitarbeiter aus.';
          showAlert(msg);
          return;
        }
        const person = userSystem.getUser(personId);
        zugewiesenAnId = personId;
        zugewiesenAnName = `${person.vorname} ${person.nachname}`;
        zugewiesenAnTyp = 'mitarbeiter';
      }
      
      // Aufgabe erstellen (mit Array von PDFs)
      aufgabenSystem.createAufgabe({
        antragId: antragId,
        antragsNummer: antrag.antragsNummer,
        erstelltVonId: currentSession.userId,
        erstelltVonName: currentSession.name,
        zugewiesenAnId: zugewiesenAnId,
        zugewiesenAnName: zugewiesenAnName,
        zugewiesenAnTyp: zugewiesenAnTyp,
        kurzbeschreibung: kurzbeschreibung,
        beschreibung: beschreibung,
        fristDatum: fristDatum || null,
        anhangPdfs: aufgabePdfs.length > 0 ? [...aufgabePdfs] : null
      });
      
      // Benachrichtigung erstellen
      notificationSystem.createNotification(
        zugewiesenAnId,
        'aufgabe',
        '' + t('task.title'),
        `${kurzbeschreibungText} (${t('application.id')}: ${antrag.antragsNummer || antragId})`,
        antragId
      );
      
      closeModal('aufgabeModal');
      showAlert(t('success.taskCreated'));
      
      // Detailansicht aktualisieren
      openAntragDetail(antragId);
    }

    // ============================================
    // AUFGABE BEARBEITEN (f√ºr Mitarbeiter)
    // ============================================
    
    function openAufgabeLoesungModal(aufgabeId) {
      const aufgabe = aufgabenSystem.getAufgabe(aufgabeId);
      if (!aufgabe) return;
      
      document.getElementById('aufgabeLoesungId').value = aufgabeId;
      document.getElementById('aufgabeAntwortText').value = '';
      
      // PDF-Upload zur√ºcksetzen
      clearAntwortPdfs();
      
      // Radio-Button auf "Antwort" setzen und Felder anzeigen
      document.querySelector('input[name="aufgabeErledigungsTyp"][value="antwort"]').checked = true;
      document.getElementById('aufgabeAntwortGruppe').style.display = 'block';
      document.getElementById('aufgabeAntwortPdfGruppe').style.display = 'block';
      
      // Kenntnisnahme-Optionen zur√ºcksetzen und verstecken
      document.getElementById('aufgabeKenntnisnahmeOptionen').style.display = 'none';
      document.querySelector('input[name="kenntnisnahmeAktion"][value="zurueck"]').checked = true;
      
      // Angeh√§ngte PDFs der Aufgabe anzeigen
      let anhangPdfsHtml = '';
      if (aufgabe.anhangPdfs && aufgabe.anhangPdfs.length > 0) {
        anhangPdfsHtml = `
          <div class="detail-row">
            <span class="detail-label">${currentLanguage === 'en' ? 'Attached documents' : currentLanguage === 'fr' ? 'Documents joints' : 'Angeh√§ngte Dokumente'}:</span>
            <div class="pdf-list aufgabe-pdfs">
              ${aufgabe.anhangPdfs.map((pdf, index) => `
                <div class="pdf-preview pdf-download" onclick="downloadAufgabePdf('${aufgabeId}', ${index})">
                  <span class="pdf-icon"></span>
                  <span class="pdf-name">${pdf.name}</span>
                  <span class="download-hint">‚¨á</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      // R√ºckw√§rtskompatibilit√§t: Einzelnes PDF (altes Format)
      else if (aufgabe.anhangPdf) {
        anhangPdfsHtml = `
          <div class="detail-row">
            <span class="detail-label">${currentLanguage === 'en' ? 'Attached document' : currentLanguage === 'fr' ? 'Document joint' : 'Angeh√§ngtes Dokument'}:</span>
            <div class="pdf-list aufgabe-pdfs">
              <div class="pdf-preview pdf-download" onclick="downloadAufgabePdfLegacy('${aufgabeId}')">
                <span class="pdf-icon"></span>
                <span class="pdf-name">Dokument.pdf</span>
                <span class="download-hint">‚¨á</span>
              </div>
            </div>
          </div>
        `;
      }
      
      document.getElementById('aufgabeLoesungInfo').innerHTML = `
        <div class="detail-box">
          <div class="detail-row">
            <span class="detail-label">${t('task.from')}:</span>
            <span class="detail-value">${aufgabe.erstelltVonName}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">${t('task.forApplication')}:</span>
            <span class="detail-value">${aufgabe.antragsNummer || aufgabe.antragId}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">${t('task.shortDescription')}:</span>
            <span class="detail-value">${getTranslatedUserText(aufgabe.kurzbeschreibung || aufgabe.beschreibung)}</span>
          </div>
          ${aufgabe.beschreibung && aufgabe.kurzbeschreibung ? `
          <div class="detail-row">
            <span class="detail-label">${t('task.description')}:</span>
            <span class="detail-value">${getTranslatedUserText(aufgabe.beschreibung)}</span>
          </div>
          ` : ''}
          ${aufgabe.fristDatum ? `
          <div class="detail-row">
            <span class="detail-label">Frist:</span>
            <span class="detail-value">${new Date(aufgabe.fristDatum).toLocaleDateString('de-DE')}</span>
          </div>
          ` : ''}
          ${anhangPdfsHtml}
        </div>
      `;
      
      openModal('aufgabeLoesungModal');
    }
    
    // PDF aus Aufgabe herunterladen
    function downloadAufgabePdf(aufgabeId, index) {
      const aufgabe = aufgabenSystem.getAufgabe(aufgabeId);
      if (!aufgabe || !aufgabe.anhangPdfs || !aufgabe.anhangPdfs[index]) return;
      
      const pdf = aufgabe.anhangPdfs[index];
      const link = document.createElement('a');
      link.href = pdf.data;
      link.download = pdf.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Legacy: Einzelnes PDF (altes Format)
    function downloadAufgabePdfLegacy(aufgabeId) {
      const aufgabe = aufgabenSystem.getAufgabe(aufgabeId);
      if (!aufgabe || !aufgabe.anhangPdf) return;
      
      const link = document.createElement('a');
      link.href = aufgabe.anhangPdf;
      link.download = `Aufgabe_${aufgabe.id}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function toggleAntwortFeld() {
      const erledigungsTyp = document.querySelector('input[name="aufgabeErledigungsTyp"]:checked').value;
      const antwortGruppe = document.getElementById('aufgabeAntwortGruppe');
      const pdfGruppe = document.getElementById('aufgabeAntwortPdfGruppe');
      const kenntnisnahmeOptionen = document.getElementById('aufgabeKenntnisnahmeOptionen');
      
      if (erledigungsTyp === 'kenntnisnahme') {
        antwortGruppe.style.display = 'none';
        pdfGruppe.style.display = 'none';
        kenntnisnahmeOptionen.style.display = 'block';
        // Standard: zur√ºck an Aufgabensteller
        document.querySelector('input[name="kenntnisnahmeAktion"][value="zurueck"]').checked = true;
      } else {
        antwortGruppe.style.display = 'block';
        pdfGruppe.style.display = 'block';
        kenntnisnahmeOptionen.style.display = 'none';
      }
    }
    
    function erledigeAufgabe() {
      const aufgabeId = document.getElementById('aufgabeLoesungId').value;
      const erledigungsTyp = document.querySelector('input[name="aufgabeErledigungsTyp"]:checked').value;
      const antwortText = document.getElementById('aufgabeAntwortText').value.trim();
      
      // Bei "Antwort" ist eine Eingabe erforderlich, bei "Kenntnisnahme" nicht
      if (erledigungsTyp === 'antwort' && !antwortText) {
        showAlert(t('error.required'));
        return;
      }
      
      // Bei "Zur Kenntnis" die gew√§hlte Aktion ermitteln
      let kenntnisnahmeAktion = 'zurueck'; // Standard
      if (erledigungsTyp === 'kenntnisnahme') {
        const aktionRadio = document.querySelector('input[name="kenntnisnahmeAktion"]:checked');
        if (aktionRadio) {
          kenntnisnahmeAktion = aktionRadio.value;
        }
      }
      
      // Antwort mit Sprachinfo f√ºr √úbersetzung speichern
      const antwort = antwortText ? createTranslatableText(antwortText) : '';
      
      // PDFs als Array √ºbergeben
      const aufgabe = aufgabenSystem.erledigeAufgabe(aufgabeId, antwort, erledigungsTyp, antwortPdfs.length > 0 ? [...antwortPdfs] : null);
      const antrag = antragSystem.getAntrag(aufgabe.antragId);
      
      // Logik basierend auf Erledigungstyp und Aktion
      if (erledigungsTyp === 'antwort' || (erledigungsTyp === 'kenntnisnahme' && kenntnisnahmeAktion === 'zurueck')) {
        // Antrag geht zur√ºck an den Aufgabensteller
        // Der Empf√§nger verliert den Zugriff (wird als "abgegeben" markiert)
        antragSystem.markiereAufgabeAbgegeben(aufgabe.antragId, currentSession.userId);
        
        // Benachrichtigung an den Ersteller
        const nachrichtText = erledigungsTyp === 'kenntnisnahme'
          ? `${t('task.acknowledged')} (${t('application.id')}: ${aufgabe.antragsNummer || aufgabe.antragId})`
          : `${t('task.answer')}: ${aufgabe.antragsNummer || aufgabe.antragId}`;
        
        notificationSystem.createNotification(
          aufgabe.erstelltVonId,
          'aufgabe-erledigt',
          '' + t('task.complete'),
          nachrichtText,
          aufgabe.antragId
        );
        
        closeModal('aufgabeLoesungModal');
        
        // Zur√ºck zur √úbersicht (da kein Zugriff mehr)
        closeAntragDetail();
        renderAntraege();
        
        const msgZurueck = currentLanguage === 'en' ? 'Task completed. The application has been returned to the task creator.'
                        : currentLanguage === 'fr' ? 'T√¢che termin√©e. La demande a √©t√© renvoy√©e au cr√©ateur de la t√¢che.'
                        : 'Aufgabe erledigt. Der Antrag wurde an den Aufgabensteller zur√ºckgegeben.';
        showAlert(msgZurueck);
        
      } else if (erledigungsTyp === 'kenntnisnahme' && kenntnisnahmeAktion === 'uebernehmen') {
        // Bearbeitung √ºbernehmen - Empf√§nger wird neuer Hauptbearbeiter
        antragSystem.uebernehmBearbeitung(aufgabe.antragId, currentSession.userId, currentSession.name, aufgabe.erstelltVonId);
        
        // Benachrichtigung an den ehemaligen Bearbeiter (Aufgabensteller)
        const nachrichtUebernahme = currentLanguage === 'en' ? `Application processing taken over (ID: ${aufgabe.antragsNummer || aufgabe.antragId})`
                                  : currentLanguage === 'fr' ? `Traitement de la demande repris (ID: ${aufgabe.antragsNummer || aufgabe.antragId})`
                                  : `Antragsbearbeitung √ºbernommen (ID: ${aufgabe.antragsNummer || aufgabe.antragId})`;
        
        notificationSystem.createNotification(
          aufgabe.erstelltVonId,
          'bearbeitung-uebernommen',
          '' + (currentLanguage === 'en' ? 'Processing taken over' : currentLanguage === 'fr' ? 'Traitement repris' : 'Bearbeitung √ºbernommen'),
          nachrichtUebernahme,
          aufgabe.antragId
        );
        
        closeModal('aufgabeLoesungModal');
        
        // Antrag direkt √∂ffnen mit vollen Bearbeitungsrechten
        openAntragDetail(aufgabe.antragId);
        
        const msgUebernommen = currentLanguage === 'en' ? 'You are now the main processor of this application.'
                             : currentLanguage === 'fr' ? 'Vous √™tes maintenant le responsable principal de cette demande.'
                             : 'Sie sind jetzt der Hauptbearbeiter dieses Antrags.';
        showAlert(msgUebernommen);
      }
    }

    // ============================================
    // ANTRAG VOLLZOGEN (Kontrollk√§stchen)
    // ============================================
    
    function toggleVollzogen(antragId, checked) {
      if (checked) {
        antragSystem.markiereAlsVollzogen(antragId, currentSession.userId, currentSession.name);
        // Nach Vollzug: Weiterleitung anbieten
        openWeiterleitenModal(antragId, 'vollzug');
      }
    }

    // ============================================
    // ANTRAG WEITERLEITEN
    // ============================================
    
    let weiterleitenCallback = null;
    
    function openWeiterleitenModal(antragId, phase) {
      // Formular zur√ºcksetzen
      document.getElementById('weiterleitenAntragId').value = antragId;
      document.getElementById('weiterleitenPhase').value = phase;
      
      // Radio-Buttons zur√ºcksetzen
      const radioNein = document.querySelector('input[name="weiterleitenEntscheidung"][value="nein"]');
      if (radioNein) radioNein.checked = true;
      
      // Felder zur√ºcksetzen
      document.getElementById('weiterleitenFelder').style.display = 'none';
      document.getElementById('weiterleitenNotiz').value = '';
      document.getElementById('weiterleitenPersonId').value = '';
      document.getElementById('weiterleitenSelectedContainer').style.display = 'none';
      document.getElementById('weiterleitenMitarbeiterSuche').value = '';
      
      // Phase-Info setzen
      const phaseTexte = {
        'genommen': currentLanguage === 'en' ? 'You have taken the application. It is now in the "Review" phase.'
                  : currentLanguage === 'fr' ? 'Vous avez pris la demande. Elle est maintenant en phase "Examen".'
                  : 'Sie haben den Antrag genommen. Er befindet sich jetzt in der Phase "Pr√ºfung".',
        'geprueft': currentLanguage === 'en' ? 'The application has been reviewed. It is now in the "Decision" phase.'
                  : currentLanguage === 'fr' ? 'La demande a √©t√© examin√©e. Elle est maintenant en phase "D√©cision".'
                  : 'Der Antrag wurde gepr√ºft. Er befindet sich jetzt in der Phase "Entscheidung".',
        'entschieden': currentLanguage === 'en' ? 'A decision has been made. The application is now in the "Notification" phase.'
                     : currentLanguage === 'fr' ? 'Une d√©cision a √©t√© prise. La demande est maintenant en phase "Notification".'
                     : 'Die Entscheidung wurde getroffen. Der Antrag befindet sich jetzt in der Phase "Bekanntgabe".',
        'bekanntgegeben': currentLanguage === 'en' ? 'The decision has been communicated. The application is now in the "Execution" phase.'
                        : currentLanguage === 'fr' ? 'La d√©cision a √©t√© communiqu√©e. La demande est maintenant en phase "Ex√©cution".'
                        : 'Die Entscheidung wurde bekannt gegeben. Der Antrag befindet sich jetzt in der Phase "Vollzug".',
        'vollzug': currentLanguage === 'en' ? 'The application has been executed. It is now in the "Completion" phase.'
                 : currentLanguage === 'fr' ? 'La demande a √©t√© ex√©cut√©e. Elle est maintenant en phase "Ach√®vement".'
                 : 'Der Antrag wurde vollzogen. Er befindet sich jetzt in der Phase "Abschluss".'
      };
      
      document.getElementById('weiterleitenPhaseInfo').textContent = phaseTexte[phase] || '';
      
      // Mitarbeiterliste laden
      loadWeiterleitenMitarbeiter();
      
      openModal('weiterleitenModal');
    }
    
    function toggleWeiterleitenFelder() {
      const entscheidung = document.querySelector('input[name="weiterleitenEntscheidung"]:checked').value;
      const felder = document.getElementById('weiterleitenFelder');
      
      if (entscheidung === 'ja') {
        felder.style.display = 'block';
      } else {
        felder.style.display = 'none';
      }
    }
    
    // Alle Mitarbeiter f√ºr Weiterleitung laden
    function loadWeiterleitenMitarbeiter() {
      const alleMitarbeiter = userSystem.users.filter(u => u.type === 'mitarbeiter' && u.id !== currentSession.userId);
      
      // Sortieren nach Name
      alleMitarbeiter.sort((a, b) => {
        const nameA = `${a.nachname} ${a.vorname}`.toLowerCase();
        const nameB = `${b.nachname} ${b.vorname}`.toLowerCase();
        return nameA.localeCompare(nameB, 'de');
      });
      
      renderWeiterleitenMitarbeiter(alleMitarbeiter);
    }
    
    // Mitarbeiterliste f√ºr Weiterleitung rendern
    function renderWeiterleitenMitarbeiter(mitarbeiter) {
      const liste = document.getElementById('weiterleitenMitarbeiterListe');
      const selectedId = document.getElementById('weiterleitenPersonId').value;
      
      if (!liste) return;
      
      if (mitarbeiter.length === 0) {
        liste.innerHTML = '<div class="keine-ergebnisse">Keine Mitarbeiter gefunden</div>';
        return;
      }
      
      liste.innerHTML = mitarbeiter.map(m => {
        const rolleText = getRolleText(m.rolle);
        const hausText = m.jvas && m.jvas.length > 0 ? (HAUS_CONFIG[m.jvas[0]]?.name || m.jvas[0]) : '';
        const stationText = m.station ? `Station ${m.station}` : '';
        const zusatzInfo = [hausText, stationText].filter(Boolean).join(', ');
        const isSelected = m.id === selectedId;
        
        return `
          <div class="mitarbeiter-item ${isSelected ? 'selected' : ''}" onclick="selectWeiterleitenMitarbeiter('${m.id}', '${m.vorname} ${m.nachname}')">
            <div class="mitarbeiter-item-name">${m.vorname} ${m.nachname}</div>
            <div class="mitarbeiter-item-info">${rolleText}${zusatzInfo ? ' ‚Ä¢ ' + zusatzInfo : ''}</div>
          </div>
        `;
      }).join('');
    }
    
    // Mitarbeiterliste f√ºr Weiterleitung filtern
    function filterWeiterleitenMitarbeiter() {
      const suchbegriff = document.getElementById('weiterleitenMitarbeiterSuche').value.toLowerCase().trim();
      const alleMitarbeiter = userSystem.users.filter(u => u.type === 'mitarbeiter' && u.id !== currentSession.userId);
      
      let gefiltert = alleMitarbeiter;
      
      if (suchbegriff) {
        gefiltert = alleMitarbeiter.filter(m => {
          const vollName = `${m.vorname} ${m.nachname}`.toLowerCase();
          const rolleText = getRolleText(m.rolle).toLowerCase();
          const hausText = m.jvas && m.jvas.length > 0 ? (HAUS_CONFIG[m.jvas[0]]?.name || '').toLowerCase() : '';
          return vollName.includes(suchbegriff) || rolleText.includes(suchbegriff) || hausText.includes(suchbegriff);
        });
      }
      
      // Sortieren nach Name
      gefiltert.sort((a, b) => {
        const nameA = `${a.nachname} ${a.vorname}`.toLowerCase();
        const nameB = `${b.nachname} ${b.vorname}`.toLowerCase();
        return nameA.localeCompare(nameB, 'de');
      });
      
      renderWeiterleitenMitarbeiter(gefiltert);
    }
    
    // Mitarbeiter f√ºr Weiterleitung ausw√§hlen
    function selectWeiterleitenMitarbeiter(id, name) {
      document.getElementById('weiterleitenPersonId').value = id;
      document.getElementById('weiterleitenSelectedPersonName').textContent = name;
      document.getElementById('weiterleitenSelectedContainer').style.display = 'block';
      
      // Liste neu rendern um Auswahl zu markieren
      filterWeiterleitenMitarbeiter();
    }
    
    // Auswahl f√ºr Weiterleitung l√∂schen
    function clearWeiterleitenSelection() {
      document.getElementById('weiterleitenPersonId').value = '';
      document.getElementById('weiterleitenSelectedContainer').style.display = 'none';
      document.getElementById('weiterleitenMitarbeiterSuche').value = '';
      loadWeiterleitenMitarbeiter();
    }
    
    function closeWeiterleitenModal(confirmed) {
      closeModal('weiterleitenModal');
      
      // Wenn abgebrochen, trotzdem die Detailansicht aktualisieren
      const antragId = document.getElementById('weiterleitenAntragId').value;
      if (antragId) {
        openAntragDetail(antragId);
      }
    }
    
    function confirmWeiterleiten() {
      const antragId = document.getElementById('weiterleitenAntragId').value;
      const phase = document.getElementById('weiterleitenPhase').value;
      const entscheidung = document.querySelector('input[name="weiterleitenEntscheidung"]:checked').value;
      
      if (entscheidung === 'ja') {
        const personId = document.getElementById('weiterleitenPersonId').value;
        if (!personId) {
          const msg = currentLanguage === 'en' ? 'Please select a staff member.'
                    : currentLanguage === 'fr' ? 'Veuillez s√©lectionner un employ√©.'
                    : 'Bitte w√§hlen Sie einen Mitarbeiter aus.';
          showAlert(msg);
          return;
        }
        
        const person = userSystem.getUser(personId);
        const notiz = document.getElementById('weiterleitenNotiz').value.trim();
        
        // Weiterleitung durchf√ºhren
        antragSystem.weiterleitenAntrag(
          antragId, 
          personId, 
          `${person.vorname} ${person.nachname}`,
          currentSession.userId,
          currentSession.name,
          notiz
        );
        
        // Benachrichtigung an neuen Bearbeiter
        const nachrichtText = currentLanguage === 'en' 
          ? `Application forwarded to you${notiz ? ': ' + notiz : ''}`
          : currentLanguage === 'fr' 
          ? `Demande transmise √† vous${notiz ? ': ' + notiz : ''}`
          : `Antrag an Sie weitergeleitet${notiz ? ': ' + notiz : ''}`;
        
        const antrag = antragSystem.getAntrag(antragId);
        notificationSystem.createNotification(
          personId,
          'weiterleitung',
          '' + (currentLanguage === 'en' ? 'Application forwarded' : currentLanguage === 'fr' ? 'Demande transmise' : 'Antrag weitergeleitet'),
          `${nachrichtText} (${antrag.antragsNummer || antragId})`,
          antragId
        );
        
        closeModal('weiterleitenModal');
        
        // Zur√ºck zur √úbersicht
        closeAntragDetail();
        renderAntraege();
        
        const msgErfolg = currentLanguage === 'en' ? `Application forwarded to ${person.vorname} ${person.nachname}.`
                        : currentLanguage === 'fr' ? `Demande transmise √† ${person.vorname} ${person.nachname}.`
                        : `Antrag an ${person.vorname} ${person.nachname} weitergeleitet.`;
        showAlert(msgErfolg);
      } else {
        // Keine Weiterleitung - einfach schlie√üen
        closeModal('weiterleitenModal');
        openAntragDetail(antragId);
      }
    }

    // ============================================
    // VERAKTEN (PDF)
    // ============================================
    
    function veraktenAntrag(antragId) {
      const antrag = antragSystem.getAntrag(antragId);
      if (!antrag) return;
      
      // Antrag als veraktet markieren
      antragSystem.verakteAntrag(antragId, currentSession.userId, currentSession.name);
      
      // PDF generieren und herunterladen
      generateAntragPdf(antrag);
      
      // Zur√ºck zur √úbersicht oder Detailansicht aktualisieren
      closeAntragDetail();
    }
    
    function generateAntragPdf(antrag) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Titel
      doc.setFontSize(18);
      doc.text('Antragsakte', 105, 20, { align: 'center' });
      
      // Antrags-ID
      doc.setFontSize(12);
      doc.text(`Antrags-Nr.: ${antrag.antragsNummer || antrag.id}`, 20, 35);
      doc.text(`Status: ${getStatusText(antrag.status)}`, 20, 42);
      doc.text(`Erstellt am: ${formatDate(antrag.erstelltAm)}`, 20, 49);
      
      // Trennlinie
      doc.line(20, 55, 190, 55);
      
      // Stammdaten
      doc.setFontSize(14);
      doc.text('Stammdaten des Antragstellers', 20, 65);
      doc.setFontSize(11);
      doc.text(`Name: ${antrag.insasseName}`, 25, 75);
      doc.text(`Insassen-ID: ${antrag.insassenNummer || '-'}`, 25, 82);
      doc.text(`Haus: ${getHausName(antrag.insasseJva)}`, 25, 89);
      doc.text(`Station: ${antrag.insasseStation}`, 25, 96);
      
      // Trennlinie
      doc.line(20, 102, 190, 102);
      
      // Anliegen
      doc.setFontSize(14);
      doc.text('Anliegen', 20, 112);
      doc.setFontSize(11);
      
      let yPos = 122;
      if (antrag.type === 'teilhabegeld') {
        doc.text('Art: Teilhabegeld', 25, yPos);
        doc.text(`Monat: ${formatMonat(antrag.monat)}`, 25, yPos + 7);
        yPos += 20;
      } else if (antrag.type === 'eigentum') {
        const aktionText = antrag.aktion === 'aufstocken' ? 'Kleidung aufstocken' : 'Kleidung tauschen';
        doc.text('Art: Eigentum in der Kammer', 25, yPos);
        doc.text(`Aktion: ${aktionText}`, 25, yPos + 7);
        doc.text(`Kleidung: ${antrag.kleidung.join(', ')}`, 25, yPos + 14);
        yPos += 27;
      }
      
      // Sachliche/fachliche Pr√ºfung (wenn erfolgt)
      if (antrag.sachlichGeprueft) {
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        doc.setFontSize(14);
        doc.text('Sachliche/Fachliche Pr√ºfung', 20, yPos);
        yPos += 10;
        doc.setFontSize(11);
        doc.text(`Gepr√ºft von: ${antrag.sachlichGeprueftVon || '-'}`, 25, yPos);
        doc.text(`Am: ${antrag.sachlichGeprueftAm ? formatDate(antrag.sachlichGeprueftAm) : '-'}`, 25, yPos + 7);
        yPos += 14;
        
        // Pr√ºfungskommentar (Pflichtfeld)
        if (antrag.pruefungsKommentar) {
          doc.text('Pr√ºfungsergebnis:', 25, yPos);
          yPos += 6;
          const pruefText = doc.splitTextToSize(antrag.pruefungsKommentar, 160);
          doc.text(pruefText, 25, yPos);
          yPos += pruefText.length * 5 + 8;
        } else {
          doc.text('Ergebnis: Antrag sachlich und fachlich gepr√ºft', 25, yPos);
          yPos += 13;
        }
      }
      
      // Entscheidung (wenn vorhanden)
      if (antrag.bearbeitetAm) {
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        doc.setFontSize(14);
        doc.text('Entscheidung', 20, yPos);
        yPos += 10;
        doc.setFontSize(11);
        doc.text(`Bearbeitet von: ${antrag.bearbeiterName || '-'}`, 25, yPos);
        doc.text(`Am: ${formatDate(antrag.bearbeitetAm)}`, 25, yPos + 7);
        doc.text(`Ergebnis: ${getStatusText(antrag.status)}`, 25, yPos + 14);
        yPos += 21;
        if (antrag.begruendung) {
          const begruendungText = getTranslatedUserText(antrag.begruendung);
          const splitText = doc.splitTextToSize(`Begr√ºndung: ${begruendungText}`, 160);
          doc.text(splitText, 25, yPos);
          yPos += splitText.length * 6 + 5;
        }
      }
      
      // Vollzug (wenn vorhanden)
      if (antrag.vollzogen) {
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        doc.setFontSize(14);
        doc.text('Vollzug', 20, yPos);
        yPos += 10;
        doc.setFontSize(11);
        doc.text(`Vollzogen von: ${antrag.vollzogenVon || '-'}`, 25, yPos);
        doc.text(`Am: ${antrag.vollzogenAm ? formatDate(antrag.vollzogenAm) : '-'}`, 25, yPos + 7);
        yPos += 20;
      }
      
      // Kommentare/Notizen (wenn vorhanden)
      if (antrag.kommentare && antrag.kommentare.length > 0) {
        // Neue Seite wenn n√∂tig
        if (yPos > 220) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        doc.setFontSize(14);
        doc.text('Notizen', 20, yPos);
        yPos += 10;
        doc.setFontSize(10);
        
        // Sortieren: √§lteste zuerst f√ºr chronologische Darstellung
        const sortierteKommentare = [...antrag.kommentare].sort((a, b) => new Date(a.erstelltAm) - new Date(b.erstelltAm));
        
        sortierteKommentare.forEach(k => {
          // Neue Seite wenn n√∂tig
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          
          const datum = new Date(k.erstelltAm);
          const datumStr = datum.toLocaleDateString('de-DE') + ' ' + datum.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
          
          doc.setFont(undefined, 'bold');
          doc.text(`${k.benutzerName} (${datumStr}):`, 25, yPos);
          doc.setFont(undefined, 'normal');
          yPos += 6;
          
          const splitText = doc.splitTextToSize(k.text, 160);
          doc.text(splitText, 25, yPos);
          yPos += splitText.length * 5 + 5;
        });
      }
      
      // Fu√üzeile
      doc.setFontSize(9);
      doc.text(`Generiert am: ${new Date().toLocaleString('de-DE')}`, 20, 280);
      doc.text(`Veraktet von: ${currentSession.name}`, 20, 285);
      
      // Download
      doc.save(`Antrag_${antrag.antragsNummer || antrag.id}.pdf`);
    }
    
    function generateAufgabePdf(antrag, beschreibung) {
      // Hier k√∂nnte ein PDF-Objekt als Base64 zur√ºckgegeben werden
      // F√ºr Demonstrationszwecke geben wir nur einen String zur√ºck
      return `aufgabe_${antrag.antragsNummer}_${Date.now()}.pdf`;
    }

    // ============================================
    // SONSTIGE FUNKTIONEN
    // ============================================

    // Berechnet den aktuellen Prozess-Status f√ºr die grafische Darstellung
    function berechneProzessStatus(antrag) {
      const status = {
        eingang: 'ausstehend',
        pruefung: 'ausstehend',
        entscheiden: 'ausstehend',
        bekanntgabe: 'ausstehend',
        vollzug: 'ausstehend',
        abschluss: 'ausstehend'
      };
      
      // Eingang - immer erledigt wenn Antrag existiert
      if (antrag.status === 'offen') {
        status.eingang = 'aktiv';
      } else {
        status.eingang = 'erledigt';
      }
      
      // Pr√ºfung - wenn genommen aber noch nicht gepr√ºft
      if (antrag.status === 'in-bearbeitung' && !antrag.sachlichGeprueft) {
        status.pruefung = 'aktiv';
      } else if (antrag.sachlichGeprueft || antrag.erledigt) {
        status.pruefung = 'erledigt';
      }
      
      // Entscheiden - wenn gepr√ºft aber noch nicht entschieden
      if (antrag.status === 'in-bearbeitung' && antrag.sachlichGeprueft && !antrag.erledigt) {
        status.entscheiden = 'aktiv';
      } else if (antrag.erledigt) {
        status.entscheiden = 'erledigt';
      }
      
      // Bekanntgabe - wenn entschieden, aber bei pers. Er√∂ffnung noch nicht durchgef√ºhrt
      if (antrag.erledigt && antrag.persoenlichEroeffnen && !antrag.persoenlichEroeffnet) {
        status.bekanntgabe = 'aktiv';
      } else if (antrag.erledigt && (!antrag.persoenlichEroeffnen || antrag.persoenlichEroeffnet)) {
        status.bekanntgabe = 'erledigt';
      }
      
      // Vollzug - wenn Bekanntgabe erfolgt, aber noch nicht vollzogen
      // Nur relevant f√ºr genehmigt/teilweise-genehmigt
      const istGenehmigt = antrag.status === 'genehmigt' || antrag.status === 'teilweise-genehmigt';
      const bekanntgabeErfolgt = antrag.erledigt && (!antrag.persoenlichEroeffnen || antrag.persoenlichEroeffnet);
      
      if (istGenehmigt && bekanntgabeErfolgt && !antrag.vollzogen) {
        status.vollzug = 'aktiv';
      } else if (antrag.vollzogen) {
        status.vollzug = 'erledigt';
      } else if (antrag.status === 'abgelehnt' && bekanntgabeErfolgt) {
        // Bei Ablehnung ist Vollzug nicht erforderlich, aber wir markieren es als erledigt/√ºbersprungen
        status.vollzug = 'uebersprungen';
      }
      
      // Abschluss - wenn vollzogen aber noch nicht veraktet
      if ((antrag.vollzogen || antrag.status === 'abgelehnt') && !antrag.veraktet && bekanntgabeErfolgt) {
        status.abschluss = 'aktiv';
      } else if (antrag.veraktet) {
        status.abschluss = 'erledigt';
      }
      
      return status;
    }

    function nehmeAntrag(antragId) {
      if (!currentSession) return;
      
      const result = antragSystem.nehmeAntrag(antragId, currentSession);
      if (result) {
        renderAntraege();
        // Automatisch zum "Meine Antr√§ge und Aufgaben" Tab wechseln
        switchTab('bearbeitung');
      }
    }
    
    function nehmeAntragUndBleibeInDetail(antragId) {
      if (!currentSession) return;
      
      const result = antragSystem.nehmeAntrag(antragId, currentSession);
      if (result) {
        renderAntraege();
        // Direkt in der Detailansicht weiterarbeiten (keine Weiterleitungs-Abfrage)
        openAntragDetail(antragId);
      }
    }

    async function bestaetigeEroeffnung(antragId) {
      const msg = currentLanguage === 'en' ? 'Have you personally communicated the result to the inmate?'
                : currentLanguage === 'fr' ? 'Avez-vous personnellement communiqu√© le r√©sultat au d√©tenu?'
                : 'Haben Sie das Ergebnis dem Insassen pers√∂nlich mitgeteilt?';
      
      const confirmed = await showConfirm(msg);
      if (confirmed) {
        // Pers√∂nliche Er√∂ffnung best√§tigen (Benachrichtigung wird in app.js gesendet)
        const antrag = antragSystem.bestaetigePersoenlicheEroeffnung(antragId);
        renderAntraege();
        
        // Nach Bekanntgabe: Weiterleitung anbieten (nur wenn kein Vollzug mehr aussteht)
        if (!antrag.wartetAufVollzug) {
          openWeiterleitenModal(antragId, 'bekanntgegeben');
        } else {
          // Noch Vollzug ausstehend - Detailansicht aktualisieren
          openAntragDetail(antragId);
        }
      }
    }

    function renderAntraege() {
      if (!currentSession) return;
      
      const offenList = document.getElementById('offenList');
      const bearbeitungList = document.getElementById('bearbeitungList');
      const historieList = document.getElementById('historieList');
      
      let offeneAntraege = antragSystem.getOffeneAntraegeMitarbeiter(currentSession);
      let inBearbeitungAntraege = antragSystem.getInBearbeitungAntraege(currentSession);
      let historieAntraege = antragSystem.getHistorieMitarbeiter(currentSession);
      
      // Aufgaben f√ºr den aktuellen Benutzer laden
      let meineAufgaben = aufgabenSystem.getOffeneAufgaben(currentSession.userId);
      
      // Sortierfunktion erstellen
      const erstelleSortierFunktion = (sortierung) => {
        return (a, b) => {
          switch (sortierung) {
            case 'datum-alt':
              return new Date(a.erstelltAm) - new Date(b.erstelltAm);
            case 'datum-neu':
              return new Date(b.erstelltAm) - new Date(a.erstelltAm);
            case 'antragsteller-az':
              const nameA = a.insasseName || a.zugewiesenAnName || '';
              const nameB = b.insasseName || b.zugewiesenAnName || '';
              return nameA.localeCompare(nameB, 'de');
            case 'antragsteller-za':
              const nameA2 = a.insasseName || a.zugewiesenAnName || '';
              const nameB2 = b.insasseName || b.zugewiesenAnName || '';
              return nameB2.localeCompare(nameA2, 'de');
            default:
              return new Date(b.erstelltAm) - new Date(a.erstelltAm);
          }
        };
      };
      
      // Sortierung f√ºr jede Liste anwenden
      const sortierungOffen = document.getElementById('sortierungOffen')?.value || 'datum-neu';
      const sortierungBearbeitung = document.getElementById('sortierung')?.value || 'datum-neu';
      const sortierungHistorie = document.getElementById('sortierungHistorie')?.value || 'datum-neu';
      
      offeneAntraege = [...offeneAntraege].sort(erstelleSortierFunktion(sortierungOffen));
      inBearbeitungAntraege = [...inBearbeitungAntraege].sort(erstelleSortierFunktion(sortierungBearbeitung));
      meineAufgaben = [...meineAufgaben].sort(erstelleSortierFunktion(sortierungBearbeitung));
      historieAntraege = [...historieAntraege].sort(erstelleSortierFunktion(sortierungHistorie));
      
      const bearbeitungTotal = inBearbeitungAntraege.length + meineAufgaben.length;
      document.getElementById('offenCount').textContent = offeneAntraege.length;
      document.getElementById('bearbeitungCount').textContent = bearbeitungTotal;
      document.getElementById('historieCount').textContent = historieAntraege.length;
      
      // Tab-Z√§hler f√ºr "Meine Antr√§ge und Aufgaben" aktualisieren
      const tabCount = document.getElementById('bearbeitungTabCount');
      if (tabCount) {
        tabCount.textContent = bearbeitungTotal;
        tabCount.style.display = bearbeitungTotal > 0 ? 'inline-block' : 'none';
      }
      
      // Offene Antr√§ge
      if (offeneAntraege.length === 0) {
        offenList.innerHTML = '<div class="empty-state"><p>Keine offenen Antr√§ge vorhanden.</p></div>';
      } else {
        offenList.innerHTML = offeneAntraege.map(a => renderAntragCard(a, 'offen')).join('');
      }
      
      // Meine Antr√§ge und Aufgaben
      let bearbeitungHtml = '';
      
      // Erst Aufgaben
      if (meineAufgaben.length > 0) {
        bearbeitungHtml += '<h3 class="subsection-title">Meine Aufgaben</h3>';
        bearbeitungHtml += meineAufgaben.map(a => renderAufgabeCard(a)).join('');
      }
      
      // Dann Antr√§ge in Bearbeitung
      if (inBearbeitungAntraege.length > 0) {
        bearbeitungHtml += '<h3 class="subsection-title">Antr√§ge in Bearbeitung</h3>';
        bearbeitungHtml += inBearbeitungAntraege.map(a => renderAntragCard(a, 'bearbeitung')).join('');
      }
      
      if (bearbeitungHtml === '') {
        bearbeitungList.innerHTML = '<div class="empty-state"><p>Keine Antr√§ge oder Aufgaben vorhanden.</p></div>';
      } else {
        bearbeitungList.innerHTML = bearbeitungHtml;
      }
      
      // Historie
      if (historieAntraege.length === 0) {
        historieList.innerHTML = '<div class="empty-state"><p>Noch keine erledigten Antr√§ge.</p></div>';
      } else {
        historieList.innerHTML = historieAntraege.map(a => renderAntragCard(a, 'historie')).join('');
      }
    }

    // ============================================
    // KALENDER-FUNKTIONEN
    // ============================================
    
    let kalenderDatum = new Date(); // Aktuelles Referenzdatum
    let kalenderAnsicht = 'monat'; // 'tag', 'woche', 'monat'
    let ausgewaehltesDatum = new Date(); // F√ºr Sidebar
    
    const WOCHENTAGE = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    const WOCHENTAGE_LANG = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
    const MONATE = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    
    function setKalenderAnsicht(ansicht) {
      kalenderAnsicht = ansicht;
      document.querySelectorAll('.kalender-view-buttons .view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`view${ansicht.charAt(0).toUpperCase() + ansicht.slice(1)}Btn`).classList.add('active');
      renderKalender();
    }
    
    function kalenderHeute() {
      kalenderDatum = new Date();
      ausgewaehltesDatum = new Date();
      renderKalender();
    }
    
    function kalenderZurueck() {
      if (kalenderAnsicht === 'tag') {
        kalenderDatum.setDate(kalenderDatum.getDate() - 1);
      } else if (kalenderAnsicht === 'woche') {
        kalenderDatum.setDate(kalenderDatum.getDate() - 7);
      } else {
        kalenderDatum.setMonth(kalenderDatum.getMonth() - 1);
      }
      renderKalender();
    }
    
    function kalenderVor() {
      if (kalenderAnsicht === 'tag') {
        kalenderDatum.setDate(kalenderDatum.getDate() + 1);
      } else if (kalenderAnsicht === 'woche') {
        kalenderDatum.setDate(kalenderDatum.getDate() + 7);
      } else {
        kalenderDatum.setMonth(kalenderDatum.getMonth() + 1);
      }
      renderKalender();
    }
    
    function renderKalender() {
      if (!currentSession) return;
      
      try {
        updateKalenderAnzeige();
        
        if (kalenderAnsicht === 'tag') {
          renderTagAnsicht();
        } else if (kalenderAnsicht === 'woche') {
          renderWocheAnsicht();
        } else {
          renderMonatAnsicht();
        }
        
        renderTermineSidebar();
      } catch (error) {
        console.error('Fehler beim Rendern des Kalenders:', error);
        const main = document.getElementById('kalenderMain');
        if (main) {
          main.innerHTML = '<p style="color: red; padding: 1rem;">Fehler beim Laden des Kalenders. Bitte Seite neu laden.</p>';
        }
      }
    }
    
    function updateKalenderAnzeige() {
      const anzeige = document.getElementById('kalenderAnzeige');
      if (kalenderAnsicht === 'tag') {
        anzeige.textContent = kalenderDatum.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      } else if (kalenderAnsicht === 'woche') {
        const startOfWeek = getStartOfWeek(kalenderDatum);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6);
        anzeige.textContent = `${startOfWeek.getDate()}. - ${endOfWeek.getDate()}. ${MONATE[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`;
      } else {
        anzeige.textContent = `${MONATE[kalenderDatum.getMonth()]} ${kalenderDatum.getFullYear()}`;
      }
    }
    
    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }
    
    function renderTagAnsicht() {
      const main = document.getElementById('kalenderMain');
      const termine = terminSystem.getTermineFuerTag(currentSession, kalenderDatum);
      const heute = new Date().toDateString();
      const istHeute = kalenderDatum.toDateString() === heute;
      
      let html = `
        <div class="kalender-tag-ansicht">
          <div class="tag-header ${istHeute ? 'heute' : ''}">
            <div class="tag-datum">
              <span class="tag-wochentag">${WOCHENTAGE_LANG[(kalenderDatum.getDay() + 6) % 7]}</span>
              <span class="tag-nummer-gross">${kalenderDatum.getDate()}</span>
              <span class="tag-monat-jahr">${MONATE[kalenderDatum.getMonth()]} ${kalenderDatum.getFullYear()}</span>
            </div>
            <button class="btn btn-primary btn-sm" onclick="openTerminModalMitDatum('${kalenderDatum.toISOString().split('T')[0]}')">+ Termin</button>
          </div>
          <div class="tag-termine">
            ${termine.length === 0 ? '<p class="keine-termine">Keine Termine an diesem Tag</p>' : ''}
            ${termine.map(t => renderTerminBlock(t)).join('')}
          </div>
        </div>
      `;
      main.innerHTML = html;
      ausgewaehltesDatum = new Date(kalenderDatum);
    }
    
    function renderWocheAnsicht() {
      const main = document.getElementById('kalenderMain');
      const startOfWeek = getStartOfWeek(kalenderDatum);
      const heute = new Date().toDateString();
      
      let headerHtml = '<div class="woche-header">';
      let tageHtml = '<div class="woche-tage">';
      
      for (let i = 0; i < 7; i++) {
        const tag = new Date(startOfWeek);
        tag.setDate(tag.getDate() + i);
        const istHeute = tag.toDateString() === heute;
        const termine = terminSystem.getTermineFuerTag(currentSession, tag);
        
        headerHtml += `
          <div class="woche-tag-header ${istHeute ? 'heute' : ''}" onclick="waehleTagInWoche('${tag.toISOString()}')">
            <span class="woche-wochentag">${WOCHENTAGE[i]}</span>
            <span class="woche-tag-nummer">${tag.getDate()}</span>
          </div>
        `;
        
        tageHtml += `
          <div class="woche-tag-spalte ${istHeute ? 'heute' : ''}" onclick="waehleTagInWoche('${tag.toISOString()}')">
            ${termine.length === 0 ? '<div class="keine-termine-klein">-</div>' : ''}
            ${termine.slice(0, 4).map(t => `
              <div class="woche-termin" style="background: ${getTerminFarbe(t.typ)}20; border-left: 3px solid ${getTerminFarbe(t.typ)};" onclick="event.stopPropagation(); zeigeTerminDetails('${t.id}')">
                ${t.uhrzeit ? `<span class="woche-termin-zeit">${t.uhrzeit}</span>` : ''}
                <span class="woche-termin-titel">${t.titel}</span>
              </div>
            `).join('')}
            ${termine.length > 4 ? `<div class="mehr-termine-klein">+${termine.length - 4} weitere</div>` : ''}
          </div>
        `;
      }
      
      headerHtml += '</div>';
      tageHtml += '</div>';
      
      main.innerHTML = `<div class="kalender-woche-ansicht">${headerHtml}${tageHtml}</div>`;
    }
    
    function waehleTagInWoche(datumIso) {
      ausgewaehltesDatum = new Date(datumIso);
      renderTermineSidebar();
    }
    
    function renderMonatAnsicht() {
      const main = document.getElementById('kalenderMain');
      const jahr = kalenderDatum.getFullYear();
      const monat = kalenderDatum.getMonth();
      const termine = terminSystem.getTermineFuerMonat(currentSession, jahr, monat);
      
      const ersterTag = new Date(jahr, monat, 1);
      const letzterTag = new Date(jahr, monat + 1, 0);
      const anzahlTage = letzterTag.getDate();
      const startWochentag = (ersterTag.getDay() + 6) % 7;
      
      const heute = new Date().toDateString();
      
      let html = `
        <div class="kalender-monat-ansicht">
          <div class="kalender-header">
            ${WOCHENTAGE.map(wt => `<div class="kalender-wochentag">${wt}</div>`).join('')}
          </div>
          <div class="kalender-tage">
      `;
      
      // Leere Felder am Anfang
      for (let i = 0; i < startWochentag; i++) {
        html += '<div class="kalender-tag leer"></div>';
      }
      
      // Tage des Monats
      for (let tag = 1; tag <= anzahlTage; tag++) {
        const datum = new Date(jahr, monat, tag);
        const datumString = datum.toDateString();
        const istHeute = datumString === heute;
        const istAusgewaehlt = datumString === ausgewaehltesDatum.toDateString();
        const tagesTermine = termine.filter(t => new Date(t.datum).toDateString() === datumString);
        
        const terminMarkierungen = tagesTermine.slice(0, 3).map(t => 
          `<div class="termin-marker" style="background: ${getTerminFarbe(t.typ)};" title="${t.titel}"></div>`
        ).join('');
        
        const mehrTermine = tagesTermine.length > 3 ? `<div class="mehr-termine">+${tagesTermine.length - 3}</div>` : '';
        
        html += `
          <div class="kalender-tag ${istHeute ? 'heute' : ''} ${istAusgewaehlt ? 'ausgewaehlt' : ''} ${tagesTermine.length > 0 ? 'hat-termine' : ''}" 
               onclick="waehleTagImMonat('${datum.toISOString()}')">
            <span class="tag-nummer">${tag}</span>
            <div class="termin-markers">${terminMarkierungen}${mehrTermine}</div>
          </div>
        `;
      }
      
      html += '</div></div>';
      main.innerHTML = html;
    }
    
    function waehleTagImMonat(datumIso) {
      ausgewaehltesDatum = new Date(datumIso);
      renderKalender();
    }
    
    function renderTermineSidebar() {
      const titel = document.getElementById('termineSidebarTitel');
      const liste = document.getElementById('termineSidebarListe');
      const termine = terminSystem.getTermineFuerTag(currentSession, ausgewaehltesDatum);
      
      const formatDatum = ausgewaehltesDatum.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
      titel.textContent = `${formatDatum}`;
      
      if (termine.length === 0) {
        liste.innerHTML = `
          <p class="keine-termine">Keine Termine</p>
          <button class="btn btn-primary btn-sm btn-full" onclick="openTerminModalMitDatum('${ausgewaehltesDatum.toISOString().split('T')[0]}')">+ Termin hinzuf√ºgen</button>
        `;
        return;
      }
      
      liste.innerHTML = termine.map(t => `
        <div class="termin-item" onclick="zeigeTerminDetails('${t.id}')" style="border-left-color: ${getTerminFarbe(t.typ)}">
          <div class="termin-item-header">
            <span class="termin-typ-badge" style="background: ${getTerminFarbe(t.typ)}">${getTerminTypText(t.typ)}</span>
            ${t.uhrzeit ? `<span class="termin-uhrzeit">${t.uhrzeit}</span>` : ''}
          </div>
          <div class="termin-titel">${t.titel}</div>
        </div>
      `).join('') + `
        <button class="btn btn-outline btn-sm btn-full" style="margin-top: 0.5rem;" onclick="openTerminModalMitDatum('${ausgewaehltesDatum.toISOString().split('T')[0]}')">+ Termin</button>
      `;
    }
    
    function renderTerminBlock(termin) {
      return `
        <div class="termin-block" onclick="zeigeTerminDetails('${termin.id}')" style="border-left-color: ${getTerminFarbe(termin.typ)}">
          <div class="termin-block-header">
            <span class="termin-typ-badge" style="background: ${getTerminFarbe(termin.typ)}">${getTerminTypText(termin.typ)}</span>
            ${termin.uhrzeit ? `<span class="termin-block-zeit">${termin.uhrzeit} Uhr</span>` : '<span class="termin-block-zeit">Ganzt√§gig</span>'}
          </div>
          <div class="termin-block-titel">${termin.titel}</div>
          ${termin.beschreibung ? `<div class="termin-block-beschreibung">${termin.beschreibung}</div>` : ''}
          <div class="termin-block-meta">${currentLanguage === 'en' ? 'From' : currentLanguage === 'fr' ? 'De' : 'Von'}: ${termin.erstelltVonName}</div>
        </div>
      `;
    }
    
    function getTerminFarbe(typ) {
      switch (typ) {
        case 'admin': return '#e5484d';
        case 'persoenlich': return '#3d8bfd';
        case 'aufgabe': return '#f0a500';
        case 'haus': return '#2eb872';
        case 'station': return '#a187d1';
        default: return '#7c8da6';
      }
    }
    
    function getTerminTypText(typ) {
      switch (typ) {
        case 'admin': return 'Allgemein';
        case 'persoenlich': return 'Pers√∂nlich';
        case 'aufgabe': return 'Aufgabe';
        case 'haus': return 'Haus';
        case 'station': return 'Station';
        default: return 'Termin';
      }
    }
    
    function zeigeTerminDetails(terminId) {
      const termin = terminSystem.termine.find(t => t.id === terminId);
      if (!termin) return;
      
      const datum = new Date(termin.datum);
      const dateLocale = currentLanguage === 'en' ? 'en-GB' : currentLanguage === 'fr' ? 'fr-FR' : 'de-DE';
      const formatDatum = datum.toLocaleDateString(dateLocale, { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      
      const dateLabel = currentLanguage === 'en' ? 'Date' : currentLanguage === 'fr' ? 'Date' : 'Datum';
      const timeLabel = currentLanguage === 'en' ? 'Time' : currentLanguage === 'fr' ? 'Heure' : 'Uhrzeit';
      const allDayText = currentLanguage === 'en' ? 'All day' : currentLanguage === 'fr' ? 'Toute la journ√©e' : 'Ganzt√§gig';
      const descLabel = currentLanguage === 'en' ? 'Description' : currentLanguage === 'fr' ? 'Description' : 'Beschreibung';
      const createdByLabel = currentLanguage === 'en' ? 'Created by' : currentLanguage === 'fr' ? 'Cr√©√© par' : 'Erstellt von';
      const forAppLabel = currentLanguage === 'en' ? 'For application' : currentLanguage === 'fr' ? 'Pour la demande' : 'Zum Antrag';
      const openAppText = currentLanguage === 'en' ? 'Open application' : currentLanguage === 'fr' ? 'Ouvrir la demande' : 'Antrag √∂ffnen';
      
      let html = `
        <div class="termin-detail-header" style="border-left: 4px solid ${getTerminFarbe(termin.typ)}; padding-left: 1rem;">
          <span class="termin-typ-badge" style="background: ${getTerminFarbe(termin.typ)}">${getTerminTypText(termin.typ)}</span>
          <h4 style="margin: 0.5rem 0;">${termin.titel}</h4>
        </div>
        <div class="termin-detail-body">
          <p><strong>${dateLabel}:</strong> ${formatDatum}</p>
          ${termin.uhrzeit ? `<p><strong>üïê ${timeLabel}:</strong> ${termin.uhrzeit}</p>` : `<p><strong>üïê ${timeLabel}:</strong> ${allDayText}</p>`}
          ${termin.beschreibung ? `<p><strong>${descLabel}:</strong> ${termin.beschreibung}</p>` : ''}
          <p><strong>${createdByLabel}:</strong> ${termin.erstelltVonName}</p>
          ${termin.antragId ? `<p><strong>${forAppLabel}:</strong> <a href="#" onclick="closeModal('terminDetailModal'); openAntragDetail('${termin.antragId}'); return false;">${openAppText}</a></p>` : ''}
        </div>
      `;
      
      document.getElementById('terminDetailContent').innerHTML = html;
      
      let footerHtml = `<button class="btn btn-secondary" onclick="closeModal('terminDetailModal')">${t('button.close')}</button>`;
      if (termin.erstelltVonId === currentSession.userId && termin.typ !== 'aufgabe') {
        footerHtml += `<button class="btn btn-danger" onclick="loescheTermin('${termin.id}')">${t('button.delete')}</button>`;
      }
      document.getElementById('terminDetailFooter').innerHTML = footerHtml;
      
      openModal('terminDetailModal');
    }
    
    function openTerminModal() {
      document.getElementById('terminTitel').value = '';
      document.getElementById('terminBeschreibung').value = '';
      document.getElementById('terminDatum').value = ausgewaehltesDatum.toISOString().split('T')[0];
      document.getElementById('terminUhrzeit').value = '';
      document.getElementById('terminEditId').value = '';
      document.querySelector('input[name="terminSichtbarkeit"][value="persoenlich"]').checked = true;
      
      const hausOption = document.getElementById('terminHausOption');
      const stationOption = document.getElementById('terminStationOption');
      
      if (currentSession.rolle === 'jva-leitung' || currentSession.rolle === 'haus-leitung') {
        hausOption.style.display = 'block';
        stationOption.style.display = 'none';
      } else if (currentSession.rolle === 'stationsleitung') {
        hausOption.style.display = 'none';
        stationOption.style.display = 'block';
      } else {
        hausOption.style.display = 'none';
        stationOption.style.display = 'none';
      }
      
      openModal('terminModal');
    }
    
    function openTerminModalMitDatum(datum) {
      closeModal('terminDetailModal');
      ausgewaehltesDatum = new Date(datum);
      openTerminModal();
    }
    
    function updateTerminSichtbarkeit() {
      // Kann f√ºr zuk√ºnftige Erweiterungen genutzt werden
    }
    
    function speichereTermin() {
      const titel = document.getElementById('terminTitel').value.trim();
      const beschreibung = document.getElementById('terminBeschreibung').value.trim();
      const datum = document.getElementById('terminDatum').value;
      const uhrzeit = document.getElementById('terminUhrzeit').value;
      const sichtbarkeit = document.querySelector('input[name="terminSichtbarkeit"]:checked').value;
      
      if (!titel) {
        const msg = currentLanguage === 'en' ? 'Please enter a title.' 
                  : currentLanguage === 'fr' ? 'Veuillez entrer un titre.' 
                  : 'Bitte geben Sie einen Titel ein.';
        showAlert(msg);
        return;
      }
      if (!datum) {
        const msg = currentLanguage === 'en' ? 'Please select a date.' 
                  : currentLanguage === 'fr' ? 'Veuillez s√©lectionner une date.' 
                  : 'Bitte w√§hlen Sie ein Datum.';
        showAlert(msg);
        return;
      }
      
      const terminData = {
        titel,
        beschreibung,
        datum,
        uhrzeit: uhrzeit || null,
        typ: sichtbarkeit,
        erstelltVonId: currentSession.userId,
        erstelltVonName: currentSession.name
      };
      
      if (sichtbarkeit === 'haus' && currentSession.jvas && currentSession.jvas.length > 0) {
        terminData.hausId = currentSession.jvas[0];
      } else if (sichtbarkeit === 'station' && currentSession.jvas && currentSession.jvas.length > 0) {
        terminData.hausId = currentSession.jvas[0];
        terminData.stationId = currentSession.station;
      }
      
      terminSystem.createTermin(terminData);
      closeModal('terminModal');
      renderKalender();
    }
    
    async function loescheTermin(terminId) {
      const confirmMsg = currentLanguage === 'en' ? 'Do you really want to delete this appointment?' 
                       : currentLanguage === 'fr' ? 'Voulez-vous vraiment supprimer ce rendez-vous?' 
                       : 'M√∂chten Sie diesen Termin wirklich l√∂schen?';
      if (!await showConfirm(confirmMsg)) return;
      
      terminSystem.deleteTermin(terminId);
      closeModal('terminDetailModal');
      renderKalender();
    }
  </script>
</body>
</html>
